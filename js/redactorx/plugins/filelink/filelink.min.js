RedactorX.add("plugin","filelink",{translations:{en:{filelink:{file:"File",upload:"Upload",title:"Title",choose:"Choose",placeholder:"Drag to upload a file<br>or click to select"}}},defaults:{states:!0,classname:!1,upload:!1,select:!1,name:"file",data:!1,icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m14 9c.5128358 0 .9355072.38604019.9932723.88337887l.0067277.11662113v3.2c0 .9600523-.7638671 1.7205052-1.7068479 1.7941504l-.150295.0058496h-10.28571424c-.96021508 0-1.77209294-.7124503-1.85088019-1.6501425l-.00626267-.1498575v-3.2c0-.55228475.44771525-1 1-1 .51283584 0 .93550716.38604019.99327227.88337887l.00672773.11662113v3h10v-3c0-.51283584.3860402-.93550716.8833789-.99327227zm-6-8c.51283584 0 .93550716.38604019.99327227.88337887l.00672773.11662113v6h1.5c.1573787 0 .3055728.07409708.4.2.1656854.2209139.1209139.53431458-.1.7l-2.5 1.875c-.17777778.1333333-.42222222.1333333-.6 0l-2.5-1.875c-.12590292-.09442719-.2-.24262135-.2-.4 0-.27614237.22385763-.5.5-.5h1.5v-6c0-.55228475.44771525-1 1-1z"/></svg>'},subscribe:{"editor.load, editor.build":function(){this.observeStates()}},popups:{create:{title:"## filelink.upload ##",width:"400px",form:{title:{type:"input",label:"## filelink.title ##"},file:{}}},choose:{collapse:!1,title:"## filelink.choose ##",width:"400px"}},init:function(){this.dataStates=[]},start:function(){this._is()&&this.app.toolbar.add("file",{title:"## filelink.file ##",icon:this.opts.filelink.icon,command:"filelink.popup",blocks:{all:"editable",except:["code"]},position:{after:"link"}})},popup:function(t,i){var e="create";if(this.opts.filelink.upload){e="add";var s=this.app.selection.getText();this.app.popup.create("file",this._buildPopupUpload(this.popups.create)).setData({title:s})}if(this.opts.filelink.select){var a=this.app.popup[e]("file-select",this.popups.choose);this.$sbox=a.getBody(),"string"==typeof this.opts.filelink.select?this.ajax.get({url:this.opts.filelink.select,success:this._parseList.bind(this)}):this._parseList.apply(this,[this.opts.filelink.select])}this.app.popup.open({button:i})},insertByUpload:function(t){this.app.popup.close();var i=this.app.popup.getData();this._insert(t,i.title)},insertBySelect:function(t){t.preventDefault(),this.app.popup.close();var i=this.app.selection.getText(),e=this.dom(t.target).closest("."+this.prefix+"-popup-list-item"),s=JSON.parse(decodeURI(e.attr("data-params")));this._insert({file:s},i,!0)},error:function(t){this.app.broadcast("file.upload.error",{response:t})},observeStates:function(){this._findFiles().each(this._addFileState.bind(this))},getStates:function(){var t=this._findFiles();for(var i in this.dataStates){var e=this.dataStates[i],s=t.is('[data-file="'+e.id+'"]');this._setFileState(e.id,s)}return this.dataStates},_is:function(){return this.opts.filelink.upload||this.opts.filelink.select},_insert:function(t,i,e){for(var s in t){var a=this._createFileAndStore(t[s],i),l=e?"select":"upload";this.app.broadcast("file."+l,{response:t,$el:a});break}},_buildPopupUpload:function(t){return t.form.file={type:"upload",upload:{type:"file",box:!0,placeholder:this.lang.get("filelink.placeholder"),url:this.opts.filelink.upload,name:this.opts.filelink.name,data:this.opts.filelink.data,success:"filelink.insertByUpload",error:"filelink.error"}},t},_findFiles:function(){return this.app.editor.getLayout().find("[data-file]")},_addFileState:function(t){var i=t.attr("data-file");this.dataStates[i]={type:"file",status:!0,url:t.attr("src"),$el:t,id:i}},_setFileState:function(t,i){this.dataStates[t].status=i},_parseList:function(t){var i=this.dom("<ul>");for(var e in i.addClass(this.prefix+"-popup-list"),t){var s=t[e];if("object"==typeof s){var a=this.dom("<li>"),l=this.dom("<span>");a.append(l),l.addClass(this.prefix+"-popup-list-item"),l.attr("data-params",encodeURI(JSON.stringify(s))),l.text(s.title||s.name);var p=this.dom("<span>");p.addClass(this.prefix+"-popup-list-aside"),p.text(s.name),a.append(p);var o=this.dom("<span>");o.addClass(this.prefix+"-popup-list-aside"),o.text("("+s.size+")"),a.append(o),a.on("click",this.insertBySelect.bind(this)),i.append(a)}}this.$sbox.append(i)},_createFileAndStore:function(t,i){var e=this.app.inline.set({tag:"a",caret:"after"}),s=this.dom(e);return s.attr("href",t.url),s.attr("data-file",t.id?t.id:this.app.utils.getRandomId()),s.attr("data-name",t.name),this.opts.filelink.classname&&s.addClass(this.opts.filelink.classname),i=i&&""!==i?i:this._truncateUrl(t.name),s.html(i),s},_truncateUrl:function(t){return-1!==t.search(/^http/)&&20<t.length?t.substring(0,20)+"...":t}});