var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(k){var h=0;return function(){return h<k.length?{done:!1,value:k[h++]}:{done:!0}}};$jscomp.arrayIterator=function(k){return{next:$jscomp.arrayIteratorImpl(k)}};$jscomp.makeIterator=function(k){var h="undefined"!=typeof Symbol&&Symbol.iterator&&k[Symbol.iterator];return h?h.call(k):$jscomp.arrayIterator(k)};$jscomp.arrayFromIterator=function(k){for(var h,n=[];!(h=k.next()).done;)n.push(h.value);return n};
$jscomp.arrayFromIterable=function(k){return k instanceof Array?k:$jscomp.arrayFromIterator($jscomp.makeIterator(k))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(k,h,n){if(k==Array.prototype||k==Object.prototype)return k;k[h]=n.value;return k};$jscomp.getGlobal=function(k){k=["object"==typeof globalThis&&globalThis,k,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var h=0;h<k.length;++h){var n=k[h];if(n&&n.Math==Math)return n}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(k,h){var n=$jscomp.propertyToPolyfillSymbol[h];if(null==n)return k[h];n=k[n];return void 0!==n?n:k[h]};
$jscomp.polyfill=function(k,h,n,q){h&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(k,h,n,q):$jscomp.polyfillUnisolated(k,h,n,q))};$jscomp.polyfillUnisolated=function(k,h,n,q){n=$jscomp.global;k=k.split(".");for(q=0;q<k.length-1;q++){var t=k[q];if(!(t in n))return;n=n[t]}k=k[k.length-1];q=n[k];h=h(q);h!=q&&null!=h&&$jscomp.defineProperty(n,k,{configurable:!0,writable:!0,value:h})};
$jscomp.polyfillIsolated=function(k,h,n,q){var t=k.split(".");k=1===t.length;q=t[0];q=!k&&q in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var u=0;u<t.length-1;u++){var y=t[u];if(!(y in q))return;q=q[y]}t=t[t.length-1];n=$jscomp.IS_SYMBOL_NATIVE&&"es6"===n?q[t]:null;h=h(n);null!=h&&(k?$jscomp.defineProperty($jscomp.polyfills,t,{configurable:!0,writable:!0,value:h}):h!==n&&(void 0===$jscomp.propertyToPolyfillSymbol[t]&&(n=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[t]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(t):$jscomp.POLYFILL_PREFIX+n+"$"+t),$jscomp.defineProperty(q,$jscomp.propertyToPolyfillSymbol[t],{configurable:!0,writable:!0,value:h})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(k){if(k)return k;var h=function(u,y){this.$jscomp$symbol$id_=u;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:y})};h.prototype.toString=function(){return this.$jscomp$symbol$id_};var n="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",q=0,t=function(u){if(this instanceof t)throw new TypeError("Symbol is not a constructor");return new h(n+(u||"")+"_"+q++,u)};return t},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(k){if(k)return k;k=Symbol("Symbol.iterator");for(var h="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),n=0;n<h.length;n++){var q=$jscomp.global[h[n]];"function"===typeof q&&"function"!=typeof q.prototype[k]&&$jscomp.defineProperty(q.prototype,k,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return k},"es6",
"es3");$jscomp.iteratorPrototype=function(k){k={next:k};k[Symbol.iterator]=function(){return this};return k};$jscomp.iteratorFromArray=function(k,h){k instanceof String&&(k+="");var n=0,q=!1,t={next:function(){if(!q&&n<k.length){var u=n++;return{value:h(u,k[u]),done:!1}}q=!0;return{done:!0,value:void 0}}};t[Symbol.iterator]=function(){return t};return t};$jscomp.polyfill("Array.prototype.keys",function(k){return k?k:function(){return $jscomp.iteratorFromArray(this,function(h){return h})}},"es6","es3");
$jscomp.findInternal=function(k,h,n){k instanceof String&&(k=String(k));for(var q=k.length,t=0;t<q;t++){var u=k[t];if(h.call(n,u,t,k))return{i:t,v:u}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(k){return k?k:function(h,n){return $jscomp.findInternal(this,h,n).v}},"es6","es3");
$jscomp.polyfill("Math.hypot",function(k){return k?k:function(h){if(2>arguments.length)return arguments.length?Math.abs(arguments[0]):0;var n,q,t;for(n=t=0;n<arguments.length;n++)t=Math.max(t,Math.abs(arguments[n]));if(1E100<t||1E-100>t){if(!t)return t;for(n=q=0;n<arguments.length;n++){var u=Number(arguments[n])/t;q+=u*u}return Math.sqrt(q)*t}for(n=q=0;n<arguments.length;n++)u=Number(arguments[n]),q+=u*u;return Math.sqrt(q)}},"es6","es3");if(void 0===CodeMirror)var CodeMirror;
!function(){function k(a,b){return this.parse(a,b)}function h(a,b){return A(a,b)}var n={settings:{},post:function(a){return new q("post",a)},get:function(a){return new q("get",a)},request:function(a,b){return new q(a,b)}},q=function(a,b){this.p=this.extend({method:a,url:"",before:function(){},success:function(){},error:function(){},data:!1,async:!0,headers:{}},b);this.p=this.extend(this.p,n.settings);this.p.method=this.p.method.toUpperCase();this.prepareData();this.xhr=new XMLHttpRequest;this.xhr.open(this.p.method,
this.p.url,this.p.async);this.setHeaders();!1!==("function"!=typeof this.p.before||this.p.before(this.xhr))&&this.send()};q.prototype={extend:function(a,b){return b&&Object.keys(b).forEach(function(c){a[c]=b[c]}),a},prepareData:function(){if(-1===["POST","PUT"].indexOf(this.p.method)||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"!=typeof this.p.data||this.isFormData()||(this.p.data=this.toParams(this.p.data)),"GET"===this.p.method){var a=-1!==this.p.url.search(/\?/)?
"&":"?";this.p.url=this.p.data?this.p.url+a+this.p.data:this.p.url}},setHeaders:function(){this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest");Object.keys(this.p.headers).forEach(function(a){this.xhr.setRequestHeader(a,this.p.headers[a])}.bind(this))},isFormData:function(){return void 0!==window.FormData&&this.p.data instanceof window.FormData},isComplete:function(){return!(200>this.xhr.status||300<=this.xhr.status&&304!==this.xhr.status)},send:function(){this.p.async?
(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded:function(){var a;this.isComplete()?(a=this.parseResponse(),"function"==typeof this.p.success&&this.p.success(a,this.xhr)):(a=this.parseResponse(),"function"==typeof this.p.error&&this.p.error(a,this.xhr,this.xhr.status))},parseResponse:function(){var a=this.xhr.response;return this.parseJson(a)||a},parseJson:function(a){try{var b=JSON.parse(a);if(b&&"object"==typeof b)return b}catch(c){}return!1},
toParams:function(a){return Object.keys(a).map(function(b){return encodeURIComponent(b)+"="+encodeURIComponent(a[b])}).join("&")}};var t=[0],u="data"+(new Date).getTime();k.ready=function(a){document.addEventListener("DOMContentLoaded",a)};k.prototype={get length(){return this.nodes.length},parse:function(a,b){if(a){if(a instanceof k)return this.nodes=a.nodes,a;a=/^\s*<(\w+|!)[^>]*>/.test(a)?this.create(a):"string"!=typeof a?a.nodeType&&11===a.nodeType?a.childNodes:a.nodeType||this._isWindowNode(a)?
[a]:a:this._query(a,b)}else a=[];this.nodes=this._slice(a)},create:function(a){if(/^<(\w+)\s*\/?>(?:<\/\1>|)$/.test(a))return[document.createElement(RegExp.$1)];var b=[],c=document.createElement("div");c.innerHTML=a;a=0;for(var d=c.childNodes.length;a<d;a++)b.push(c.childNodes[a]);return b},dataset:function(a,b){return this.each(function(c){t[this.dataindex(c.get())][a]=b})},dataget:function(a){return t[this.dataindex(this.get())][a]},dataindex:function(a){var b=a[u],c=t.length;return b||(b=c,a&&
(a[u]=c),t[b]={}),b},add:function(a){return this.nodes=this.nodes.concat(this._array(a)),this},get:function(a){return this.nodes[a||0]||!1},getAll:function(){return this.nodes},eq:function(a){return new k(this.nodes[a])},first:function(){return new k(this.nodes[0])},last:function(){return new k(this.nodes[this.nodes.length-1])},contents:function(){return this.get().childNodes},each:function(a){for(var b=this.nodes.length,c=0;c<b;c++)a.call(this,new k(this.nodes[c]),c);return this},is:function(a){return 0<
this.filter(a).length},filter:function(a){var b;return void 0===a?this:(b="function"==typeof a?function(c){return a(new k(c))}:function(c){return a&&a.nodeType||a instanceof Node?a===c:(c.matches=c.matches||c.msMatchesSelector||c.webkitMatchesSelector,1===c.nodeType&&c.matches(a||"*"))},new k(this.nodes.filter.call(this.nodes,b)))},not:function(a){return this.filter(function(b){return!(new k(b)).is(a||!0)})},find:function(a){var b=[];return this.each(function(c){c=c.get();c=this._query(a,c);for(var d=
0;d<c.length;d++)b.push(c[d])}),new k(b)},children:function(a){var b=[];return this.each(function(c){c=c.get();if(c.children){c=c.children;for(var d=0;d<c.length;d++)b.push(c[d])}}),(new k(b)).filter(a)},parent:function(a){var b=this.get();return(b=!!b.parentNode&&b.parentNode)?(new k(b)).filter(a):new k},parents:function(a,b){b=this._context(b);var c=[];return this.each(function(d){for(d=d.get().parentNode;d&&d!==b;)a?(new k(d)).is(a)&&c.push(d):c.push(d),d=d.parentNode}),new k(c)},closest:function(a,
b){b=this._context(b);var c=[],d=a&&a.nodeType;return this.each(function(e){e=e.get();do if(e&&(d&&e===a||(new k(e)).is(a)))return c.push(e);while((e=e.parentNode)&&e!==b)}),new k(c)},next:function(a){return this._sibling(a,"nextSibling")},nextElement:function(a){return this._sibling(a,"nextElementSibling")},prev:function(a){return this._sibling(a,"previousSibling")},prevElement:function(a){return this._sibling(a,"previousElementSibling")},css:function(a,b){if(void 0!==b||"object"==typeof a)return this.each(function(d){d=
d.get();var e={},f;for(f in"object"==typeof a?e=a:e[a]=b,e)d.style&&(d.style[f]=e[f])});var c=this.get();return"width"===a||"height"===a?c.style?this._getHeightOrWidth(a)+"px":void 0:c.style?getComputedStyle(c,null)[a]:void 0},attr:function(a,b,c){if(c=c?"data-":"",void 0!==b||"object"==typeof a)return this.each(function(e){e=e.get();var f={},g;for(g in"object"==typeof a?f=a:f[a]=b,f)3!==e.nodeType&&("checked"===g?e.checked=f[g]:e.setAttribute(c+g,f[g]))});var d=this.get();return d&&3!==d.nodeType?
"checked"===a?d.checked:this._boolean(d.getAttribute(c+a)):void 0},data:function(a,b){function c(m){return m[1].toUpperCase()}if(void 0!==a&&!0!==a)return this.attr(a,b,!0);b=/^data-(.+)$/;var d=this.get().attributes,e={},f;for(f in d)if(d[f]&&b.test(d[f].nodeName)){var g=d[f].nodeName.match(b)[1],l=d[f].value;!0!==a&&(g=g.replace(/-([a-z])/g,c));l=-1!==l.search(/^{/)?this._object(l):this._number(l)?parseFloat(l):this._boolean(l);e[g]=l}return e},val:function(a){if(void 0!==a)return this.each(function(c){c=
c.get();c.type&&"checkbox"===c.type?c.checked=a:c.value=a});var b=this.get();return b.type&&"checkbox"===b.type?b.checked:b.value},removeAttr:function(a){return this.each(function(b){var c=b.get();a.split(" ").forEach(function(d){3!==c.nodeType&&c.removeAttribute(d)})})},addClass:function(a){return this._eachClass(a,"add")},removeClass:function(a){return this._eachClass(a,"remove")},toggleClass:function(a){return this._eachClass(a,"toggle")},hasClass:function(a){var b=this.get();return!!b.classList&&
b.classList.contains(a)},empty:function(){return this.each(function(a){a.get().innerHTML=""})},html:function(a){return void 0===a?this.get().innerHTML||"":this.empty().append(a)},text:function(a){return void 0===a?this.get().textContent||"":this.each(function(b){b.get().textContent=a})},after:function(a){return this._inject(a,function(b,c){if("string"==typeof b)c.insertAdjacentHTML("afterend",b);else if(null!==c.parentNode){b=b instanceof Node?[b]:this._array(b).reverse();for(var d=0;d<b.length;d++)c.parentNode.insertBefore(b[d],
c.nextSibling)}return c})},before:function(a){return this._inject(a,function(b,c){if("string"==typeof b)c.insertAdjacentHTML("beforebegin",b);else{b=b instanceof Node?[b]:this._array(b);for(var d=0;d<b.length;d++)c.parentNode.insertBefore(b[d],c)}return c})},append:function(a){return this._inject(a,function(b,c){if("string"==typeof b||"number"==typeof b)c.insertAdjacentHTML("beforeend",b);else{b=b instanceof Node?[b]:this._array(b);for(var d=0;d<b.length;d++)c.appendChild(b[d])}return c})},prepend:function(a){return this._inject(a,
function(b,c){if("string"==typeof b||"number"==typeof b)c.insertAdjacentHTML("afterbegin",b);else{b=b instanceof Node?[b]:this._array(b).reverse();for(var d=0;d<b.length;d++)c.insertBefore(b[d],c.firstChild)}return c})},wrap:function(a){return this._inject(a,function(b,c){b="string"==typeof b||"number"==typeof b?this.create(b)[0]:b instanceof Node?b:this._array(b)[0];return c.parentNode&&c.parentNode.insertBefore(b,c),b.appendChild(c),b})},unwrap:function(){return this.each(function(a){a=a.get();
for(var b=document.createDocumentFragment();a.firstChild;){var c=a.removeChild(a.firstChild);b.appendChild(c)}a.parentNode.replaceChild(b,a)})},replaceWith:function(a){return this._inject(a,function(b,c){var d=document.createDocumentFragment();b="string"==typeof b||"number"==typeof b?this.create(b):b instanceof Node?[b]:this._array(b);for(var e=0;e<b.length;e++)d.appendChild(b[e]);b=d.childNodes[0];return c.parentNode&&c.parentNode.replaceChild(d,c),b})},remove:function(){return this.each(function(a){a=
a.get();a.parentNode&&a.parentNode.removeChild(a)})},clone:function(a){var b=[];return this.each(function(c){c=c.get();var d=this._clone(c);a&&(d=this._cloneEvents(c,d));b.push(d)}),new k(b)},show:function(){return this.each(function(a){a=a.get();if(a.style&&this._hasDisplayNone(a)){var b=a.getAttribute("domTargetShow");a.style.display=b||"block";a.removeAttribute("domTargetShow")}}.bind(this))},hide:function(){return this.each(function(a){a=a.get();if(a.style&&!this._hasDisplayNone(a)){var b=a.style.display;
"block"!==b&&a.setAttribute("domTargetShow",b);a.style.display="none"}})},scrollTop:function(a){var b=this.get(),c=this._isWindowNode(b),d=9===b.nodeType?b.scrollingElement||b.body.parentNode||b.body||b.documentElement:b;return void 0!==a?(a=parseInt(a),void(c?b.scrollTo(0,a):d.scrollTop=a)):c?b.pageYOffset:d.scrollTop},offset:function(){return this._getPos("offset")},position:function(){return this._getPos("position")},width:function(a){return void 0!==a?this.css("width",parseInt(a)+"px"):this._getSize("width",
"Width")},height:function(a){return void 0!==a?this.css("height",parseInt(a)+"px"):this._getSize("height","Height")},outerWidth:function(){return this._getSize("width","Width","outer")},outerHeight:function(){return this._getSize("height","Height","outer")},innerWidth:function(){return this._getSize("width","Width","inner")},innerHeight:function(){return this._getSize("height","Height","inner")},click:function(){return this._trigger("click")},focus:function(){return this._trigger("focus")},blur:function(){return this._trigger("blur")},
on:function(a,b,c){return this.each(function(d){d=d.get();for(var e=a.split(" "),f=0;f<e.length;f++){var g=this._getEventName(e[f]),l=this._getEventNamespace(e[f]);b=c?this._getOneHandler(b,a):b;d.addEventListener(g,b);d._e=d._e||{};d._e[l]=d._e[l]||{};d._e[l][g]=d._e[l][g]||[];d._e[l][g].push(b)}})},one:function(a,b){return this.on(a,b,!0)},off:function(a,b){function c(g,l,m){return g===m}function d(g,l,m,r){return l===r}function e(g,l,m,r){return g===m&&l===r}function f(){return!0}return void 0===
a?this.each(function(g){this._offEvent(g.get(),!1,!1,b,f)}):this.each(function(g){g=g.get();for(var l=a.split(" "),m=0;m<l.length;m++){var r=this._getEventName(l[m]),v=this._getEventNamespace(l[m]);"_events"===v?this._offEvent(g,r,v,b,c):r||"_events"===v?this._offEvent(g,r,v,b,e):this._offEvent(g,r,v,b,d)}})},serialize:function(a){for(var b={},c=this.get().elements,d=0;d<c.length;d++){var e=c[d];if((!/(checkbox|radio)/.test(e.type)||e.checked)&&e.name&&!e.disabled&&"file"!==e.type){if("select-multiple"===
e.type)for(var f=0;f<e.options.length;f++){var g=e.options[f];g.selected&&(b[e.name]=g.value)}b[e.name]=this._number(e.value)?parseFloat(e.value):this._boolean(e.value)}}return a?b:this._params(b)},scroll:function(){this.get().scrollIntoView({behavior:"smooth"})},fadeIn:function(a,b){var c=this._anim(a,b,500);return this.each(function(d){d.css({display:"block",opacity:0,animation:"fadeIn "+c.speed+"s ease-in-out"}).removeClass("hidden");d.one("animationend",function(){d.css({opacity:"",animation:""});
c.fn&&c.fn(d)})})},fadeOut:function(a,b){var c=this._anim(a,b,300);return this.each(function(d){d.css({opacity:1,animation:"fadeOut "+c.speed+"s ease-in-out"});d.one("animationend",function(){d.css({display:"none",opacity:"",animation:""});c.fn&&c.fn(d)})})},slideUp:function(a,b){var c=this._anim(a,b,300);return this.each(function(d){d.height(d.height());d.css({overflow:"hidden",animation:"slideUp "+c.speed+"s ease-out"});d.one("animationend",function(){d.css({display:"none",height:"",animation:""});
c.fn&&c.fn(d)})})},slideDown:function(a,b){var c=this._anim(a,b,400);return this.each(function(d){d.height(d.height());d.css({display:"block",overflow:"hidden",animation:"slideDown "+c.speed+"s ease-in-out"}).removeClass("hidden");d.one("animationend",function(){d.css({overflow:"",height:"",animation:""});c.fn&&c.fn(d)})})},_queryContext:function(a,b){return 3!==(b=this._context(b)).nodeType&&"function"==typeof b.querySelectorAll?b.querySelectorAll(a):[]},_query:function(a,b){var c=document;return b?
this._queryContext(a,b):/^[.#]?[\w-]*$/.test(a)?"#"!==a[0]?"."===a[0]?c.getElementsByClassName(a.slice(1)):c.getElementsByTagName(a):(a=c.getElementById(a.slice(1)))?[a]:[]:c.querySelectorAll(a)},_context:function(a){return a?"string"==typeof a?document.querySelector(a):a:document},_sibling:function(a,b){var c,d=a&&a.nodeType;return this.each(function(e){e=e.get();do if((e=e[b])&&(d&&e===a||(new k(e)).is(a)))return void(c=e);while(e)}),new k(c)},_slice:function(a){return a&&0!==a.length?a.length?
[].slice.call(a.nodes||a):[a]:[]},_array:function(a){if(void 0===a)return[];if(a instanceof NodeList){for(var b=[],c=0;c<a.length;c++)b[c]=a[c];return b}return a instanceof k?a.nodes:a},_object:function(a){a=a.replace(/(\w+:)|(\w+ :)/g,function(b){return'"'+b.substring(0,b.length-1)+'":'});return JSON.parse(a)},_params:function(a){var b="";return Object.keys(a).forEach(function(c){b+="&"+this._encodeUri(c)+"="+this._encodeUri(a[c])}.bind(this)),b.replace(/^&/,"")},_boolean:function(a){return"true"===
a||"false"!==a&&a},_number:function(a){return!isNaN(a)&&!isNaN(parseFloat(a))},_inject:function(a,b){for(var c=this.nodes.length,d=[];c--;){var e="function"==typeof a?a.call(this,this.nodes[c]):a;e=0===c?e:this._clone(e);(e=b.call(this,e,this.nodes[c]))&&(e.dom?d.push(e.get()):d.push(e))}return new k(d)},_clone:function(a){if(void 0!==a)return"string"==typeof a?a:a instanceof Node||a.nodeType?a.cloneNode(!0):"length"in a?[].map.call(this._array(a),function(b){return b.cloneNode(!0)}):void 0},_cloneEvents:function(a,
b){if(a=a._e)for(var c in(b._e=a)._events)if(a._events.hasOwnProperty(c))for(var d=0;d<a._events[c].length;d++)b.addEventListener(c,a._events[c][d]);return b},_trigger:function(a){var b=this.get();return b&&3!==b.nodeType&&b[a](),this},_encodeUri:function(a){return encodeURIComponent(a).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},_getSize:function(a,b){var c=this.get(),d=0;return d=3===c.nodeType?0:9===c.nodeType?this._getDocSize(c,
b):this._isWindowNode(c)?window["inner"+b]:this._getHeightOrWidth(a),Math.round(d)},_getDocSize:function(a,b){var c=a.body;a=a.documentElement;return Math.max(c["scroll"+b],c["offset"+b],a["client"+b],a["scroll"+b],a["offset"+b])},_getPos:function(a){var b=this.get(),c={top:0,left:0};if(3===b.nodeType||this._isWindowNode(b)||9===b.nodeType)return c;if("position"===a)return{top:b.offsetTop,left:b.offsetLeft};if("offset"!==a)return c;a=b.getBoundingClientRect();c=b.ownerDocument;b=c.documentElement;
c=c.defaultView;return{top:a.top+c.pageYOffset-b.clientTop,left:a.left+c.pageXOffset-b.clientLeft}},_getHeightOrWidth:function(a,b){a=a.charAt(0).toUpperCase()+a.slice(1);b=b||"offset";var c=0;c=this.get();var d=getComputedStyle(c,null),e=this.parents().filter(function(g){g=g.get();return 1===g.nodeType&&"none"===getComputedStyle(g,null).display&&g});if("none"===d.display&&e.add(c),0!==e.length){var f=[];e.each(function(g){var l=g.attr("style");null!==l&&f.push(l);g.attr("style",null!==l?l+";visibility: hidden !important; display: block !important;":
"visibility: hidden !important; display: block !important;")});c=c[b+a];e.each(function(g,l){void 0===f[l]?g.removeAttr("style"):g.attr("style",f[l])})}else c=c[b+a];return c},_eachClass:function(a,b){return this.each(function(c){if(a){var d=c.get();a.split(" ").forEach(function(e){d.classList&&d.classList[b](e)})}})},_getOneHandler:function(a,b){var c=this;return function(){a.apply(this,arguments);c.off(b)}},_getEventNamespace:function(a){a=a.split(".");var b=a[1]?a[1]:"_events";return a[2]?b+a[2]:
b},_getEventName:function(a){return a.split(".")[0]},_offEvent:function(a,b,c,d,e){for(var f in a._e)if(a._e.hasOwnProperty(f))for(var g in a._e[f])if(e(g,f,b,c))for(var l=a._e[f][g],m=0;m<l.length;m++)void 0!==d&&l[m].toString()!==d.toString()||(a.removeEventListener(g,l[m]),a._e[f][g].splice(m,1),0===a._e[f][g].length&&delete a._e[f][g],0===Object.keys(a._e[f]).length&&delete a._e[f])},_hasDisplayNone:function(a){return"none"===a.style.display||"none"===(a.currentStyle?a.currentStyle.display:getComputedStyle(a,
null).display)},_anim:function(a,b,c){return a="function"==typeof a?(b=a,c):a||c,{fn:b,speed:a/1E3}},_isWindowNode:function(a){return a===window||a.parent&&a.parent===window}};var y=0,A=function(a,b){var c;return p.dom(a).each(function(d){(c=d.dataget(p.namespace))||(c=new z(d,b,y),d.dataset(p.namespace,c),p.instances[y]=c,y++)}),c},p=h;p.dom=function(a,b){return new k(a,b)};p.ajax=n;p.instances=[];p.namespace="redactorx";p.prefix="rx";p.version="1.3.4";p.settings={};p.lang={};p._mixins={};p._repository=
{};p._subscribe={};p.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37};p.add=function(a,b,c){if(c.translations&&(p.lang=p.extend(!0,p.lang,c.translations)),c.defaults){var d={};d[b]=c.defaults;p.opts=p.extend(!0,p.opts,d)}if("mixin"===a)p._mixins[b]=c;else{d=function(){};if(c.subscribe)for(var e in c.subscribe)if(c.subscribe.hasOwnProperty(e))for(var f=e.split(","),g=0;g<f.length;g++){var l=f[g].trim();void 0===p._subscribe[l]&&
(p._subscribe[l]=[]);p._subscribe[l].push({module:b,func:c.subscribe[e]})}if((d.prototype=c).mixins)for(e=0;e<c.mixins.length;e++)p.inherit(d,p._mixins[c.mixins[e]]);p._repository[b]={type:a,proto:d,obj:c}}};p.extend=function(){var a={},b=!1,c=0,d=arguments.length;for("[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(b=arguments[0],c++);c<d;c++){var e=void 0,f=arguments[c];for(e in f)Object.prototype.hasOwnProperty.call(f,e)&&(b&&"[object Object]"===Object.prototype.toString.call(f[e])?
a[e]=p.extend(!0,a[e],f[e]):a[e]=f[e])}return a};p.error=function(a){throw a;};p.inherit=function(a,b){function c(){}c.prototype=b;var d=new c,e;for(e in a.prototype)a.prototype.__lookupGetter__(e)?d.__defineGetter__(e,a.prototype.__lookupGetter__(e)):d[e]=a.prototype[e];return a.prototype=d,a.prototype.super=b,a};p.addLang=function(a,b){void 0===p.lang[a]&&(p.lang[a]={});p.lang[a]=p.extend(!0,p.lang[a],b)};h.opts={plugins:[],content:!1,placeholder:!1,classes:!1,draggable:!1,editor:{classname:"content",
focus:!1,sync:!0,drop:!0,lang:"en",add:"top",https:!1,enterKey:!0,scrollTarget:window,direction:"ltr",spellcheck:!0,grammarly:!1,notranslate:!1,reloadmarker:!0,minHeight:"40px",maxHeight:!1},codemirrorSrc:!1,codemirror:!1,source:!0,autosave:{url:!1,name:!1,data:!1,method:"post"},state:{limit:100},clean:{comments:!1,enter:!0,enterinline:!1},tab:{key:!0,spaces:!1},link:{size:30,nofollow:!1,target:!1},tooltip:{context:!0},topbar:!0,context:!1,control:!1,reorder:!1,buttons:{addbar:"paragraph image embed table quote pre line".split(" "),
context:["bold","italic","deleted","code","link"],topbar:["shortcut"],editor:["add","html","format"],toolbar:!1,tags:{b:["bold"],strong:["bold"],i:["italic"],em:["italic"],del:["deleted"],u:["underline"],a:["link"]},types:!1,icons:!1,hidden:{}},addbar:{add:{},hide:[]},toolbar:{hide:[],sticky:!0,stickyMinHeight:200,stickyTopOffset:0},paste:{clean:!0,autoparse:!0,paragraphize:!0,plaintext:!1,linkTarget:!1,images:!0,links:!0,keepClass:[],keepStyle:[],keepAttrs:["td","th"],formTags:"form input button select textarea legend fieldset".split(" "),
blockTags:"pre h1 h2 h3 h4 h5 h6 table tbody thead tfoot th tr td ul ol li blockquote p hr figure iframe figcaption address".split(" "),inlineTags:"a svg img br strong ins code del span samp kbd sup sub mark var cite small b u em i abbr".split(" ")},image:{states:!0,upload:!1,url:!0,select:!1,name:"file",data:!1,drop:!0,multiple:!0,clipboard:!0,types:["image/*"],tag:"figure",newtab:!1,link:!0,width:!1},noneditable:{classname:"noneditable"},embed:{responsive:"embed-responsive",script:!0,checkbox:!1},
pre:{template:"<pre></pre>",spaces:4},line:!0,table:{template:"<table><tr><td></td><td></td></tr><tr><td></td><td></td></tr></table>",nowrap:"nowrap"},quote:{template:"<blockquote><p>Quote...</p><p><cite>Author Attribution</cite></p></blockquote>"},format:"p h1 h2 h3 ul ol".split(" "),formatAdd:!1,shortcutsRemove:!1,shortcutsBase:{"meta+z":"## shortcuts.meta-z ##","meta+shift+z":"## shortcuts.meta-shift-z ##","meta+a":"## shortcuts.meta-a ##"},shortcuts:{"ctrl+shift+o, meta+shift+o":{title:"## shortcuts.meta-shift-o ##",
name:"meta+shift+o",command:"addbar.popup"},"ctrl+shift+d, meta+shift+d":{title:"## shortcuts.meta-shift-d ##",name:"meta+shift+d",command:"block.duplicate"},"ctrl+shift+up, meta+shift+up":{title:"## shortcuts.meta-shift-up ##",name:"meta+shift+&uarr;",command:"block.moveUp"},"ctrl+shift+down, meta+shift+down":{title:"## shortcuts.meta-shift-down ##",name:"meta+shift+&darr;",command:"block.moveDown"},"ctrl+shift+m, meta+shift+m":{title:"## shortcuts.meta-shift-m ##",name:"meta+shift+m",command:"inline.removeFormat"},
"ctrl+b, meta+b":{title:"## shortcuts.meta-b ##",name:"meta+b",command:"inline.set",params:{tag:"b"}},"ctrl+i, meta+i":{title:"## shortcuts.meta-i ##",name:"meta+i",command:"inline.set",params:{tag:"i"}},"ctrl+u, meta+u":{title:"## shortcuts.meta-u ##",name:"meta+u",command:"inline.set",params:{tag:"u"}},"ctrl+h, meta+h":{title:"## shortcuts.meta-h ##",name:"meta+h",command:"inline.set",params:{tag:"sup"}},"ctrl+l, meta+l":{title:"## shortcuts.meta-l ##",name:"meta+l",command:"inline.set",params:{tag:"sub"}},
"ctrl+alt+0, meta+alt+0":{title:"## shortcuts.meta-alt-0 ##",name:"meta+alt+0",command:"block.format",params:{tag:"p"}},"ctrl+alt+1, meta+alt+1":{title:"## shortcuts.meta-alt-1 ##",name:"meta+alt+1",command:"block.format",params:{tag:"h1"}},"ctrl+alt+2, meta+alt+2":{title:"## shortcuts.meta-alt-2 ##",name:"meta+alt+2",command:"block.format",params:{tag:"h2"}},"ctrl+alt+3, meta+alt+3":{title:"## shortcuts.meta-alt-3 ##",name:"meta+alt+3",command:"block.format",params:{tag:"h3"}},"ctrl+alt+4, meta+alt+4":{title:"## shortcuts.meta-alt-4 ##",
name:"meta+alt+4",command:"block.format",params:{tag:"h4"}},"ctrl+alt+5, meta+alt+5":{title:"## shortcuts.meta-alt-5 ##",name:"meta+alt+5",command:"block.format",params:{tag:"h5"}},"ctrl+alt+6, meta+alt+6":{title:"## shortcuts.meta-alt-6 ##",name:"meta+alt+6",command:"block.format",params:{tag:"h6"}},"ctrl+shift+7, meta+shift+7":{title:"## shortcuts.meta-shift-7 ##",name:"meta+shift+7",command:"block.format",params:{tag:"ol"}},"ctrl+shift+8, meta+shift+8":{title:"## shortcuts.meta-shift-8 ##",name:"meta+shift+8",
command:"block.format",params:{tag:"ul"}},"ctrl+], meta+]":{title:"## shortcuts.meta-indent ##",name:"meta+]",command:"list.indent"},"ctrl+[, meta+[":{title:"## shortcuts.meta-outdent ##",name:"meta+[",command:"list.outdent"},"ctrl+k, meta+k":{title:"## shortcuts.meta-k ##",name:"meta+k",command:"link.format"}},paddingControl:"24px 26px",paddingNormal:"20px",buttonsObj:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",
command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"},undo:{title:"## buttons.undo ##",command:"state.undo"},redo:{title:"## buttons.redo ##",command:"state.redo"},shortcut:{title:"## buttons.shortcuts ##",command:"shortcut.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",
command:"inline.set",params:{tag:"del"}},code:{title:"## buttons.code ##",command:"inline.set",params:{tag:"code"}},link:{title:"## buttons.link ##",command:"link.popup"},mark:{title:"## buttons.mark ##",command:"inline.set",params:{tag:"mark"}},sub:{title:"## buttons.subscript ##",command:"inline.set",params:{tag:"sub"}},sup:{title:"## buttons.superscript ##",command:"inline.set",params:{tag:"sup"}},kbd:{title:"## buttons.shortcut ##",command:"inline.set",params:{tag:"kbd"}},paragraph:{title:"## blocks.paragraph ##",
command:"block.add",params:{name:"paragraph"}},image:{title:"## blocks.image ##",command:"image.popup",observer:"image.observe"},embed:{title:"## blocks.embed ##",command:"embed.popup",observer:"embed.observe"},"table-tune":{title:"## buttons.column-settings ##",command:"table.cellSetting",icon:"tune"},indent:{title:"## buttons.indent ##",command:"list.indent"},outdent:{title:"## buttons.outdent ##",command:"list.outdent"},line:{title:"## blocks.line ##",command:"block.add",observer:"block.observe",
params:{name:"line"}},table:{title:"## blocks.table ##",command:"table.add",observer:"table.observe",params:{name:"table"}},quote:{title:"## blocks.quote ##",command:"block.add",observer:"block.observe",params:{name:"quote"}},pre:{title:"## blocks.pre ##",command:"block.add",observer:"block.observe",params:{name:"pre"}}},formatObj:{p:{title:"## format.p ##",type:"paragraph",shortcut:"Ctrl+Alt+0"},h1:{title:'<span style="font-size: 20px; font-weight: bold;">## format.h1 ##</span>',type:"heading",shortcut:"Ctrl+Alt+1"},
h2:{title:'<span style="font-size: 16px; font-weight: bold;">## format.h2 ##</span>',type:"heading",shortcut:"Ctrl+Alt+2"},h3:{title:'<span style="font-weight: bold;">## format.h3 ##</span>',type:"heading",shortcut:"Ctrl+Alt+3"},h4:{title:'<span style="font-weight: bold;">## format.h4 ##</span>',type:"heading",shortcut:"Ctrl+Alt+4"},h5:{title:'<span style="font-weight: bold;">## format.h5 ##</span>',type:"heading",shortcut:"Ctrl+Alt+5"},h6:{title:'<span style="font-weight: bold;">## format.h6 ##</span>',
type:"heading",shortcut:"Ctrl+Alt+6"},ol:{title:"1. ## format.ol ##",type:"list",shortcut:"Ctrl+Shift+7"},ul:{title:"&bull; ## format.ul ##",type:"list",shortcut:"Ctrl+Shift+8"},address:{title:"<em>## format.address ##</em>",type:"address"},dl:{title:"## format.dl ##",type:"dlist"}},markerChar:"\ufeff",containers:{main:["toolbar","editor","source","statusbar"]},tags:{denied:"font html head link title body meta applet marquee".split(" "),incode:"!DOCTYPE !doctype html head link title body meta textarea style".split(" "),
form:"form input button select textarea legend fieldset".split(" "),inline:"a svg span strong strike b u em i code del ins samp kbd sup sub mark var cite small abbr".split(" "),block:"pre hr ul ol li p h1 h2 h3 h4 h5 h6 dl dt dd div table tbody thead tfoot tr th td blockquote output figcaption figure address main section header footer aside article iframe".split(" "),parser:"pre hr ul ol p h1 h2 h3 h4 h5 h6 table address blockquote figure iframe form dl div section header footer article main aside".split(" ")},
bsmodal:!1,regex:{youtube:/^https?:\/\/(?:www\.youtube(?:\-nocookie)?\.com\/|m\.youtube\.com\/|youtube\.com\/)?(?:ytscreeningroom\?vi?=|youtu\.be\/|vi?\/|user\/.+\/u\/\w{1,2}\/|embed\/|watch\?(?:.*&)?vi?=|&vi?=|\?(?:.*&)?vi?=)([^#&\?\n\/<>"']*)/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:\/[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z\u00F0-\u02AF0-9()!@:%_+.~#?&//=]*)/gi,
aurl1:/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,aurl2:/(^|[^\/])(www\.[\S]+(\b|$))/gim}};h.lang.en={accessibility:{"help-label":"Rich text editor"},placeholders:{figcaption:"Type caption (optional)"},popup:{back:"Back",link:"Link",add:"Add",image:"Image","add-image":"Add Image"},shortcuts:{"meta-a":"Select all","meta-z":"Undo","meta-shift-z":"Redo","meta-shift-m":"Remove inline format","meta-b":"Bold","meta-i":"Italic","meta-u":"Underline","meta-h":"Superscript","meta-l":"Subscript",
"meta-k":"Link","meta-alt-0":"Normal text","meta-alt-1":"Heading 1","meta-alt-2":"Heading 2","meta-alt-3":"Heading 3","meta-alt-4":"Heading 4","meta-alt-5":"Heading 5","meta-alt-6":"Heading 6","meta-shift-7":"Ordered List","meta-shift-8":"Unordered List","meta-indent":"Indent","meta-outdent":"Outdent","meta-shift-backspace":"Delete","meta-shift-o":"Add","meta-shift-d":"Duplicate","meta-shift-up":"Move up","meta-shift-down":"Move down"},buttons:{add:"Add",html:"HTML",format:"Format",bold:"Bold",italic:"Italic",
deleted:"Deleted",link:"Link",list:"List",image:"Image",indent:"Indent",outdent:"Outdent",embed:"Embed",table:"Table",insert:"Insert",save:"Save",cancel:"Cancel",delete:"Delete",duplicate:"Duplicate",shortcut:"Shortcuts",underline:"Underline",undo:"Undo",redo:"Redo",code:"Code",mark:"Mark",subscript:"Subscript",superscript:"Superscript",kbd:"Shortcut","column-settings":"Column settings"},blocks:{text:"Text",paragraph:"Paragraph",image:"Image",embed:"Embed",line:"Line",table:"Table",quote:"Quote",
pre:"Code",address:"Address"},format:{p:"Normal Text",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6",address:"Address",ul:"Unordered List",ol:"Ordered List",dl:"Definition List"},embed:{embed:"Embed",caption:"Caption",description:"Paste any embed/html code or enter the url (vimeo or youtube video only)","responsive-video":"Responsive video"},image:{or:"or","alt-text":"Alt Text",link:"Link",width:"Width",caption:"Caption","link-in-new-tab":"Open link in new tab",
"url-placeholder":"Paste url of image...","upload-new-placeholder":"Drag to upload a new image<br>or click to select"},link:{link:"Link","edit-link":"Edit Link",unlink:"Unlink","link-in-new-tab":"Open link in new tab",text:"Text",url:"URL"},table:{width:"Width",nowrap:"Nowrap",column:"Column","add-head":"Add head","remove-head":"Remove head","add-row-below":"Add row below","add-row-above":"Add row above","remove-row":"Remove row","add-column-after":"Add column after","add-column-before":"Add column before",
"remove-column":"Remove column","delete-table":"Delete table"}};var z=function(a,b,c){for(var d="keycodes prefix dom ajax _repository _subscribe".split(" "),e=0;e<d.length;e++)this[d[e]]=p[d[e]];this.uuid=c;this.$win=this.dom(window);this.$doc=this.dom(document);this.$body=this.dom("body");this.$element=a;(this.app=this).initialSettings=b;this._initer=["setting","lang"];this._priority=["container","editor","state","accessibility"];this._plugins=[];this.started=!1;this.start()};z.prototype={start:function(a){this.isTextarea()&&
(this.isStarted()||(a&&(this.initialSettings=a),this._initCore(),this._plugins=this.setting.get("plugins"),this.broadcast("app.before.start"),this._initModules(),this._initPlugins(),this._startPriority(),this._startModules(),this._startPlugins(),this.started=!0,this.broadcast("app.start"),this._loadModulesAndPlugins()))},isStarted:function(){return this.started},isTextarea:function(){return"TEXTAREA"===this.$element.get().tagName},stop:function(){this.isStopped()||(this.broadcast("app.before.stop"),
this._stopPlugins(),this._stopPriority(),this._stopModules(),this.started=!1,this.broadcast("app.stop"))},isStopped:function(){return!this.started},destroy:function(){clearTimeout(this.app.sync.typingTimer);this.stop();this.broadcast("app.destroy");this.$element.dataset(p.namespace,!1);var a=p.instances.indexOf(this.uuid);-1<a&&p.instances.splice(a,1)},broadcast:function(a,b){b=b instanceof z.Event?b:new z.Event(a,b);if(void 0!==this._subscribe[a])for(var c=this._subscribe[a],d=0;d<c.length;d++){var e=
this[c[d].module];e&&c[d].func.call(e,b)}c=this.setting.has("subscribe")?this.setting.get("subscribe"):{};return"function"==typeof c[a]&&c[a].call(this,b),b},broadcastParams:function(a,b){return this.broadcast(a,b).getAll()},broadcastHtml:function(a,b){return this.broadcast(a,{html:b}).get("html")},create:function(a){void 0===this._repository[a]&&p.error('The class "'+a+'" does not exist.');var b=[].slice.call(arguments,1),c=new this._repository[a].proto;c._name=a;c.app=this;for(var d,e=["uuid","prefix",
"dom","ajax"],f=0;f<e.length;f++)c[e[f]]=this[e[f]];return this.lang&&(c.lang=this.lang),this.opts&&(c.opts=this.opts),c.init&&(d=c.init.apply(c,b)),d||c},api:function(a){for(var b=[].slice.call(arguments,1),c=a.split("."),d=c.pop(),e=this,f=0;f<c.length;f++)e=e[c[f]];if(e&&"function"==typeof e[d])return e[d].apply(e,b)},_initCore:function(){for(var a=0;a<this._initer.length;a++)this[this._initer[a]]=this.create(this._initer[a]);this.setting&&(this.opts=this.setting.dump())},_initModules:function(){for(var a in this._repository)"module"===
this._repository[a].type&&-1===this._initer.indexOf(a)&&(this[a]=this.create(a))},_initPlugins:function(){var a=this.setting.get("plugins"),b;for(b in this._repository)"plugin"===this._repository[b].type&&-1!==a.indexOf(b)&&(this[b]=this.create(b))},_startPriority:function(){for(var a=0;a<this._priority.length;a++)this._call(this[this._priority[a]],"start")},_startModules:function(){this._iterate("module","start")},_startPlugins:function(){this._iterate("plugin","start")},_stopPriority:function(){for(var a=
this._priority.slice().reverse(),b=0;b<a.length;b++)this._call(this[a[b]],"stop")},_stopModules:function(){this._iterate("module","stop")},_stopPlugins:function(){this._iterate("plugin","stop")},_loadModulesAndPlugins:function(){this._iterate("module","load");this._iterate("plugin","load")},_iterate:function(a,b){for(var c in this._repository)if(this._repository.hasOwnProperty(c)){var d="module"===a?"load"===b||-1===this._priority.indexOf(c):-1!==this._plugins.indexOf(c);this._repository[c].type===
a&&d&&this._call(this[c],b)}},_call:function(a,b){"function"==typeof a[b]&&a[b].apply(a)}};z.Event=function(a,b){this.name=a;this.params=void 0===b?{}:b;this.stopped=!1};z.Event.prototype={is:function(a){if(!Array.isArray(a))return this.get(a);for(var b=0;b<a.length;b++)if(this.params[a[b]])return!0},has:function(a){return void 0!==this.params[a]},getAll:function(){return this.params},get:function(a){return this.params[a]},set:function(a,b){this.params[a]=b},stop:function(){this.stopped=!0},isStopped:function(){return this.stopped}};
h.add("mixin","block",{defaults:{id:{getter:"getId",setter:"setId"},html:{getter:"getHtml",setter:"setHtml"}},init:function(a,b){this.$block=a?this.dom(a):this.create(b);this._build(b);this._buildData();this._render()},isType:function(a){return-1!==(Array.isArray(a)?a:[a]).indexOf(this.type)},isBlock:function(){return!0},isEditable:function(){return void 0!==this.editable&&!0===this.editable},isFigcaption:function(){return"figcaption"===this.type},isSecondLevel:function(){return-1!==["quoteitem",
"row","cell"].indexOf(this.type)},isNested:function(){return-1!==["quote","table"].indexOf(this.type)},isFirstLevel:function(){return this.$block.attr("data-"+this.prefix+"-first-level")},isAllSelected:function(){return!this.isEditable()||this.app.selection.isAll(this.$block)},isEmpty:function(){var a=this.$block.text();return""===this._cleanEmpty(a)},isCaretStart:function(){if("pre"===this.getType())return this.app.caret.is(this.$block,"start",!1,!1);if("list"!==this.getType())return!this.isEditable()||
this.app.caret.is(this.$block,"start");var a=this.app.selection.getCurrent();return 0===this.dom(a).closest("li").prev().length&&this.app.caret.is(this.$block,"start")},isCaretEnd:function(){return"pre"===this.getType()?this.app.caret.is(this.$block,"end",!1,!1):"address"===this.getType()?this.app.caret.is(this.$block,"end",!1,!0,!1):!this.isEditable()||this.app.caret.is(this.$block,"end")},isAllowedButton:function(a,b){var c=this.getType();if(void 0!==this.opts.buttons.hidden[c]){var d=this.opts.buttons.hidden[c];
if(Array.isArray(d)&&-1!==d.indexOf(a))return!1}if(void 0===b.blocks)return!0;a=b.blocks;return a.except&&-1!==a.except.indexOf(c)?!1:a.all&&(!0===a.all||"all"===a.all||"editable"===a.all&&-1!=="heading paragraph list address quote table".split(" ").indexOf(c)||"first-level"===a.all&&this.isFirstLevel()||"noneditable"===a.all&&-1!==["image","embed","layer","line"].indexOf(c))?!0:!(!Array.isArray(a.types)||-1===a.types.indexOf(c))},getData:function(a){var b={};return Object.keys(this.data).forEach(function(c){b[c]=
this[this.data[c].getter].apply(this)}.bind(this)),a?b[a]:b},getOffset:function(){return this.$block.offset()},getType:function(){return this.type},getTag:function(){return!!this.$block&&this.$block.get().tagName.toLowerCase()},getBlock:function(){return this.$block},getHtml:function(){return this.$block.html()},getPlainText:function(){var a=this.$block.html();return this.app.content.getTextFromHtml(a,{nl:!0})},getOuterHtml:function(){return this.$block.get().outerHTML},getFirstLevel:function(){var a=
this.$block.closest("[data-"+this.prefix+"-first-level]");return 0!==a.length&&a.dataget("instance")},getParent:function(a){a=a?"="+a:"";a=this.$block.parent().closest("[data-"+this.prefix+"-type"+a+"]");return 0!==a.length&&a.dataget("instance")},getNext:function(a){a=a?"="+a:"";var b=this.$block.nextElement();return!(0===b.length||!b.is("[data-"+this.prefix+"-type"+a+"]"))&&b.dataget("instance")},getPrev:function(a){a=a?"="+a:"";var b=this.$block.prevElement();return!(0===b.length||!b.is("[data-"+
this.prefix+"-type"+a+"]"))&&b.dataget("instance")},getChildFirst:function(a){a=this.$block.find("[data-"+this.prefix+"-type"+(a?"="+a:"")+"]").first();return 0!==a.length&&a.dataget("instance")},getChildLast:function(a){a=this.$block.find("[data-"+this.prefix+"-type"+(a?"="+a:"")+"]").last();return 0!==a.length&&a.dataget("instance")},getId:function(){return this.$block.attr("id")},getCaption:function(){var a=this.$block.find("figcaption");return 0!==a.length?a.html().trim():""},setData:function(a){for(var b in a)this.data[b]&&
this[this.data[b].setter].call(this,a[b])},setEmpty:function(){this.$block.html("")},setSelectAll:function(){this.isEditable()&&this.app.selection.select(this.$block)},setHtml:function(a){this.$block.html(a)},setId:function(a){""===a?this.$block.removeAttr("id"):this.$block.attr("id",a)},setCaption:function(a){if(""===a)this.$block.find("figcaption").remove();else{var b=this.$block.find("figcaption");0===b.length&&((b=this.dom("<figcaption>")).attr("data-placeholder",this.lang.get("placeholders.figcaption")),
this.$block.append(b),this.app.create("block.figcaption",b));b.html(a)}},setClassFromObj:function(a,b){this._removeObjClasses(a);a=a[b];"none"===a&&!1===a||this.$block.addClass(a)},setCaret:function(a){this.app.caret.set(this.$block,a)},moveUp:function(){var a=this.getPrev();a&&this._move(a,"before")},moveDown:function(){var a=this.getNext();a&&this._move(a,"after")},remove:function(a){var b=this.getType();this.$block.remove();a&&this.app.broadcast("block.remove",{type:b})},appendNext:function(){var a=
this.getNext();if(a.isEmpty())a.remove();else{if(this.isEmpty())return this.remove(),void this.app.block.set(a,"start");var b=a.getHtml(),c=this.getType(),d=a.getType(),e=!0,f=!0;if("pre"===c&&"pre"!==d&&(b=a.getPlainText()),"list"===d)"list"===c?(f=a.getBlock().children(),this.$block.append(f),f=!(e=!1)):(b=this._appendListHtml(a.getBlock(),b),f=a.isEmpty());e&&((c=this.app.selection.getTopInline())&&this.app.caret.set(c,"after"),this.app.insertion.insertHtml(b,"start"));f&&a.remove()}},appendToPrev:function(){var a=
this.getPrev();if(this.isEmpty())return this.remove(),void this.app.block.set(a,"end");if(a.isEmpty())a.remove();else{var b=a.getType(),c=this.getHtml(),d=this.getType(),e=!0,f=!0;if("pre"!==d&&"pre"===b&&(c=this.getPlainText()),"list"===d)"list"===b?(f=this.getBlock().children(),this.app.block.set(a,"end"),a.getBlock().append(f),f=!(e=!1)):(c=this._appendListHtml(this.getBlock(),c),f=this.isEmpty());e&&(this.app.block.set(a,"end"),(a=this.app.selection.getTopInline())&&this.app.caret.set(a,"after"),
this.app.insertion.insertHtml(c,"start"));f&&this.remove()}},insertEmpty:function(a){return(a=a||{}).instance=this.app.block.create(),this.insert(a)},insert:function(a){a=p.extend({},{instance:!1,position:"after",caret:!1,remove:!0,type:"input"},a);var b=a.instance.getBlock();return"list"===a.instance.getType()&&"list"===this.getType()?this.app.insertion.insertListToList(b,this.$block,a.caret):("split"===a.position?this.app.element.split(this.$block).before(b):this.$block[a.position](b),a.remove&&
this.isEditable()&&this.isEmpty()&&this.remove()),this.app.editor.build(),a.caret&&this.app.block.set(a.instance,a.caret),this.app.toolbar.observe(),this.app.context.observe(),this.app.broadcast("block.add",{instance:a.instance,type:a.type}),a.instance},change:function(a,b){var c=a.getBlock();this.$block.after(c);this.$block.remove();this.app.editor.build();this.app.block.set(a);!1!==b&&this.app.broadcast("block.change",{instance:a})},duplicate:function(a){var b=this.getType(),c=this.$block.clone();
return c.removeClass(this.prefix+"-block-focus"),a&&c.html(""),this.app.create("block."+b,c)},duplicateEmpty:function(){return this.duplicate(!0)},_build:function(a){this.build&&this.build(a)},_buildData:function(){this.data||(this.data={});this.data=p.extend({},!0,this.defaults,this.data)},_buildItems:function(a,b){a=this.$block.find(a);0!==a.length&&a.each(function(c){this.app.create("block."+b,c)}.bind(this))},_buildCaption:function(){"figure"===this.getTag()&&this.$block.find("figcaption").attr("data-placeholder",
this.lang.get("placeholders.figcaption"))},_render:function(){this._renderEdit()},_renderEdit:function(){this.$block.dataset("instance",this);this.$block.attr("data-"+this.prefix+"-type",this.getType());void 0!==this.editable&&!1===this.editable?this.$block.attr("contenteditable",!1):"figcaption"===this.type&&this.$block.attr("contenteditable",!0)},_cleanEmpty:function(a){return(-1!==(a=this.app.utils.removeInvisibleChars(a)).search(/^<br\s?\/?>$/)?"":a).replace(/\n/g,"")},_appendListHtml:function(a,
b){a=a.find("li").first();return b=(b=(b=a.html().trim()).replace(/<\/li>/gi,"</li><br>")).replace(/<(ul|ol)/gi,"<br><$1"),b=(b=(b=this.app.content.removeTags(b,["ul","ol","li"])).trim()).replace(/<br\s?\/?>$/gi,""),a.remove(),b},_move:function(a,b){var c=this;c.isNested()&&(c=c.getFirst());(this.isEditable()||this.isNested())&&this.app.selection.save(c.getBlock());a.getBlock()[b](this.$block);this.app.block.set(c,!1,!0);(this.isEditable()||this.isNested())&&this.app.selection.restore(!1)},_removeObjClasses:function(a){a=
this._buildObjClasses(a);this.$block.removeClass(a.join(" "));this.app.element.removeEmptyAttrs(this.$block,["class"])},_buildObjClasses:function(a){var b=[],c;for(c in a)a[c]&&b.push(a[c]);return b}});h.add("mixin","tool",{init:function(a,b,c,d){this.name=a;this.setter=c.get("setter");this.popup=c;this.data=d;(this.obj=this._observe(b))&&this._build()},getElement:function(){return this.$tool},getInput:function(){return this.$input},getValue:function(){return this.$input.val().trim()},setValue:function(a){this.$input.val(a)},
setFocus:function(){this.$input.focus()},trigger:function(a){this.setValue(a);this.setter&&this.app.api(this.setter,this.popup)},_build:function(){this._buildTool();this._buildLabel();this._buildInputElement();this._buildInput();this._buildEvent();this._has("placeholder")&&this.$input.attr("placeholder",this.lang.parse(this.obj.placeholder));this._has("width")&&this.$input.css("width",this.obj.width);this._has("classname")&&this.$input.addClass(this.obj.classname)},_buildInputElement:function(){this.$input=
this.dom("<"+this._getInputParam("tag")+">").addClass(this.prefix+this._getInputParam("classname"));this.$input.attr({name:this.name,type:this._getInputParam("type"),"data-type":this.type});this.$input.dataset("instance",this)},_buildInput:function(){},_buildEvent:function(){if(-1===["segment"].indexOf(this.type)&&this.setter){var a="checkbox"===this.type||"select"===this.type?"change":"keydown blur";a="number"===this.type?a+" change":a;this.$input.on(a,this._catchSetter.bind(this))}},_buildTool:function(){this.$tool=
this.dom("<div>").addClass(this.prefix+"-form-item").dataset("instance",this)},_buildLabel:function(){"checkbox"!==this.type&&this._has("label")&&(this.$label=this.dom("<label>").addClass(this.prefix+"-form-label").html(this.lang.parse(this.obj.label)),this.$tool.append(this.$label))},_getInputParam:function(a){return this.input&&void 0!==this.input[a]?this.input[a]:""},_get:function(a){return this.obj[a]},_has:function(a){return Object.prototype.hasOwnProperty.call(this.obj,a)},_observe:function(a){return Object.prototype.hasOwnProperty.call(a,
"observer")&&(a=this.app.api(a.observer,a,this.name)),a},_catchSetter:function(a){"keydown"===a.type&&13!==a.which||("keydown"===a.type&&a.preventDefault(),this.app.api(this.setter,this.popup))}});h.add("module","accessibility",{start:function(){this._buildRole();this._buildLabel()},_buildRole:function(){this.app.editor.getEditor().attr({"aria-labelledby":this.prefix+"-voice",role:"presentation"})},_buildLabel:function(){var a=this.lang.get("accessibility.help-label");a=this._createLabel(a);this.app.container.get("main").prepend(a)},
_createLabel:function(a){var b=this.dom("<span />").addClass(this.prefix+"-voice-label");return b.attr({id:this.prefix+"-voice-"+this.uuid,"aria-hidden":!1}),b.html(a),b}});h.add("module","lang",{init:function(){this.langKey=this.app.setting.get("editor.lang");this.vars=this._build()},get:function(a){var b=this._get(a,this.vars);return void 0===b&&"en"!==this.langKey&&(b=this._get(a,p.lang.en)),void 0===b?"":b},parse:function(a){if("string"!=typeof a)return a;var b=a.match(/## (.*?) ##/g);if(b)for(var c=
0;c<b.length;c++){var d=b[c].replace(/^##\s/g,"").replace(/\s##$/g,"");a=a.replace(b[c],this.get(d))}return a},_get:function(a,b){var c=a.split(".");return 1===c.length?b[a]:void 0!==b[c[0]]?b[c[0]][c[1]]:void 0},_build:function(){var a=p.lang.en;return"en"!==this.langKey&&(a="undefined"!==p.lang[this.langKey]?p.lang[this.langKey]:a),a}});h.add("module","setting",{init:function(){this.opts=this._build()},dump:function(){return this.opts},has:function(a){var b=a.split(".");return 1===b.length?void 0!==
this.opts[a]:void 0!==this.opts[b[0]]&&void 0!==this.opts[b[1]]},set:function(a,b,c){void 0===this.opts[a]&&(this.opts[a]={});void 0===c?this.opts[a]=b:this.opts[a][b]=c},get:function(a){var b=a.split(".");return 1===b.length?this.opts[a]:void 0!==this.opts[b[0]]?this.opts[b[0]][b[1]]:void 0},_build:function(){var a=p.extend(!0,{},p.opts,this.app.initialSettings);return p.extend(!0,a,p.settings)}});h.add("module","element",{is:function(a,b,c){var d=!1;a="text"===b?a:this._getNode(a);return"inline"===
b?d=this._isElement(a)&&this._isInlineTag(a.tagName,c):"blocks"===b?d=this._isElement(a)&&a.hasAttribute("data-"+this.prefix+"-type"):"blocks-first"===b?d=this._isElement(a)&&a.hasAttribute("data-"+this.prefix+"-first-level"):"block"===b?d=this._isElement(a)&&this._isBlockTag(a.tagName,c):"element"===b?d=this._isElement(a):"text"===b?d="string"==typeof a&&!/^\s*<(\w+|!)[^>]*>/.test(a)||this.isTextNode(a):"list"===b?d=this._isElement(a)&&-1!==["ul","ol"].indexOf(a.tagName.toLowerCase()):"heading"===
b&&(d=this._isElement(a)&&-1!=="h1 h2 h3 h4 h5 h6".split(" ").indexOf(a.tagName.toLowerCase())),d},isEmptyOrImageInline:function(a){a=this.dom(a).get();if(!a||3===a.nodeType)return!1;var b=a.tagName.toLowerCase(),c="false"===a.getAttribute("contenteditable"),d=this.is(a,"inline");return!!(d&&this.isEmpty(a)||d&&c||-1!==["svg","img"].indexOf(b))},isEmpty:function(a){a=this._getNode(a);return!!a&&(3===a.nodeType?""===a.textContent.trim().replace(/\n/,""):""===a.innerHTML)},isTag:function(a,b){return this._getNode(a).tagName.toLowerCase()===
b},isTextNode:function(a){return(a=this._getNode(a))&&a.nodeType&&3===a.nodeType},isVisible:function(a){a=this._getNode(a);return!!(a.offsetWidth||a.offsetHeight||a.getClientRects().length)},isScrollVisible:function(a){var b=this.app.scroll.getTarget();a=this.dom(a);b=b.scrollTop()+b.height();return a.offset().top<=b},getFirstLevel:function(a){return this.dom(a).closest("[data-"+this.prefix+"-first-level]")},getDataBlock:function(a){return this.dom(a).closest("[data-"+this.prefix+"-type]")},getType:function(a){return this.dom(a).attr("data-"+
this.prefix+"-type")},getAllInlines:function(a){for(var b=[];a;)this.is(a,"inline")&&b.push(a),a=a.parentNode;return b},getClosest:function(a,b){return this.dom(a).closest(this.getTypesSelector(b))},getParents:function(a,b){return this.dom(a).parents(this.getTypesSelector(b))},getChildren:function(a,b){return this.dom(a).find(this.getTypesSelector(b))},getTypesSelector:function(a){return"[data-"+this.prefix+"-type="+a.join("],[data-"+this.prefix+"-type=")+"]"},hasClass:function(a,b){b="string"==typeof b?
[b]:b;a=this.dom(a);for(var c=b.length,d=0,e=0;e<c;e++)a.hasClass(b[e])&&d++;return c===d},scrollTo:function(a,b){if(!this.isScrollVisible(a)){b=b||60;a=a.offset();var c=this.app.scroll.getTarget(),d=a.top-b;c.scrollTop(d);setTimeout(function(){c.scrollTop(d)},1)}},replaceToTag:function(a,b,c){return this.dom(a).replaceWith(function(d){var e=this.dom("<"+b+">");if(c||e.append(d.innerHTML),d.attributes)for(var f=d.attributes,g=0;g<f.length;g++)e.attr(f[g].nodeName,f[g].value);if(c)for(;0<d.childNodes.length;)e.append(this.dom(d.firstChild));
return e}.bind(this))},split:function(a){var b=this.dom(a),c=(a=b.get()).tagName.toLowerCase(),d=this.app.content.extractHtmlFromCaret(a);d.nodeType&&11===d.nodeType&&(d=this.dom(d.childNodes));c=this.dom("<"+c+" />");(c=this.cloneAttrs(a,c)).append(d);b.after(c);a=b.children().last();this.is(a,"inline")&&(d=a.html(),""===this.app.utils.removeInvisibleChars(d)&&a.remove());a=this.getType(c);return a&&this.app.create("block."+a,c,!0),""===b.html()&&b.remove(),c},cloneEmpty:function(a){a=this.dom(a).get().tagName.toLowerCase();
return this.dom("<"+a+">")},cloneAttrs:function(a,b){b=this.dom(b);a=this._getNode(a).attributes;for(var c=a.length;c--;){var d=a[c];b.attr(d.name,d.value)}return b},getAttrs:function(a){a=this._getNode(a);var b={};if(null!=a.attributes&&a.attributes.length)for(var c=0;c<a.attributes.length;c++){var d=a.attributes[c].nodeValue;d=this._isNumber(d)?parseFloat(d):this._getBooleanFromStr(d);b[a.attributes[c].nodeName]=d}return b},removeEmptyAttrs:function(a,b){a=this.dom(a);b=b.join(" ");var c=!1;return void 0===
a.attr(b)||null===a.attr(b)?c=!0:""===a.attr(b)&&(a.removeAttr(b),c=!0),c},getBlocks:function(a,b,c){a=this._getNode(a).childNodes;var d=[];b=b||this.opts.tags.parser;c&&(b=this.app.utils.extendArray(b,c));for(c=0;c<a.length;c++)1===a[c].nodeType&&-1!==b.indexOf(a[c].tagName.toLowerCase())&&d.push(a[c]);return d},hasBlocks:function(a){return 0!==this.getBlocks(a).length},hasTextSiblings:function(a){var b=this._getNode(a);a=b.previousSibling&&3===b.previousSibling.nodeType&&!this.isEmpty(b.previousSibling);
b=b.nextSibling&&3===b.nextSibling.nodeType&&!this.isEmpty(b.nextSibling);return a||b},_getNode:function(a){return this.dom(a).get()},_getBooleanFromStr:function(a){return"true"===a||"false"!==a&&a},_isBlockTag:function(a,b){return-1!==this.app.utils.extendArray(this.opts.tags.block,b).indexOf(a.toLowerCase())},_isInlineTag:function(a,b){return-1!==this.app.utils.extendArray(this.opts.tags.inline,b).indexOf(a.toLowerCase())},_isElement:function(a){return a&&a.nodeType&&1===a.nodeType},_isTag:function(a){return void 0!==
a&&a},_isNumber:function(a){return!isNaN(a)&&!isNaN(parseFloat(a))}});h.add("module","paragraphizer",{init:function(){this.remStart="#####replace";this.remEnd="#####";this.tags=this.opts.tags.parser.concat("form audio figcaption object style script iframe select input textarea button option map area math fieldset legend hgroup nav details menu summary".split(" "))},paragraphize:function(a){var b=[],c=[];a=this._storeTags(a,b);a=(a=this.app.content.storeComments(a,c)).trim();for(var d="",e=(a=(a=(a=
(a=(a=(a=this._trimLinks(a)).replace(/xparagraphmarkerz(?:\r\n|\r|\n)$/g,"")).replace(/xparagraphmarkerz$/g,"")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)/g,"\n")).replace(/xparagraphmarkerz/g,"\n")).replace(/[\n]+/g,"\n")).split("\n"),f=0;f<e.length;f++)d+="<p>"+e[f].trim()+"</p>\n";return a=(a=(a=(a=d.replace(/\n$/,"")).replace(/<p>\s+#####/gi,"#####")).replace(/<p>#####/gi,"#####")).replace(/#####<\/p>/gi,"#####"),a=this._restoreTags(a,b),this.app.content.restoreComments(a,c).replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>[\s\n]*<\/\1>/gi,
"<$1$2></$1>").replace(/<p(.*?)><\/?br\s?\/?><\/p>/gi,"<p$1></p>").replace(/<div(.*?)><\/?br\s?\/?><\/div>/gi,"<div$1></div>").replace(/<\/?br\s?\/?><\/div>/gi,"</div>").replace(/<\/?br\s?\/?><\/li>/gi,"</li>")},_storeTags:function(a,b){return this.app.utils.wrap(a,function(c){c.find(this.tags.join(", ")).each(function(d,e){this._replaceTag(d,e,b)}.bind(this))}.bind(this))},_restoreTags:function(a,b){for(var c=0;c<b.length;c++){var d=b[c].replace(/\$/gi,"&#36;");a=a.replace(this.remStart+c+this.remEnd,
d)}return a},_replaceTag:function(a,b,c){a=a.get();b=document.createTextNode(this.remStart+b+this.remEnd+"xparagraphmarkerz");c.push(a.outerHTML);a.parentNode.replaceChild(b,a)},_trimLinks:function(a){return this.app.utils.wrap(a,function(b){b.find("a").each(this._trimLink.bind(this))}.bind(this))},_trimLink:function(a){a.html(a.html().trim())}});h.add("module","utils",{isMobile:function(){return/(iPhone|iPad|iPod|Android)/.test(navigator.userAgent)},createInvisibleChar:function(){return document.createTextNode(this.opts.markerChar)},
searchInvisibleChars:function(a){return a.search(/^\uFEFF$/g)},removeInvisibleChars:function(a){return a.replace(/\uFEFF/g,"")},wrap:function(a,b){var c=this.dom("<div>").html(a);return b(c),a=c.html(),c.remove(),a},extendArray:function(a,b){if(a=a.concat(a),b)for(var c=0;c<b.length;c++)a.push(b[c]);return a},removeFromArrayByValue:function(a,b){var c;b=Array.isArray(b)?b:[b];for(var d=0;d<b.length;d++)-1<(c=a.indexOf(b[d]))&&a.splice(c,1);return a},sumOfArray:function(a){return a.reduce(function(b,
c){return parseInt(b)+parseInt(c)},0)},getObjectIndex:function(a,b){return Object.keys(a).indexOf(b)},insertToObject:function(a,b,c,d){return Object.keys(c).reduce(function(e,f,g){return g===d&&(e[a]=b),e[f]=c[f],e},{})},getRandomId:function(){for(var a="",b=0;12>b;b++)a+="abcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(36*Math.random()));return a},escapeRegExp:function(a){return a.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")},capitalize:function(a){return(a=a.toLowerCase()).charAt(0).toUpperCase()+
a.slice(1)},extendData:function(a,b){for(var c in b)a="elements"===c?this._extendDataElements(a,b[c]):this._setData(a,c,b[c]);return a},_extendDataElements:function(a,b){return this.dom(b).each(function(c){if("FORM"===c.get().tagName){var d=c.serialize(!0);Object.keys(d).forEach(function(f){a=this._setData(a,f,d[f])}.bind(this))}else{var e=c.attr("name")?c.attr("name"):c.attr("id");a=this._setData(a,e,c.val())}}.bind(this)),a},_setData:function(a,b,c){return a instanceof FormData?a.append(b,c):a[b]=
c,a}});h.add("module","scroll",{init:function(){this.scrolltop=!1},save:function(){this.scrolltop=this.getTarget().scrollTop()},restore:function(){!1!==this.scrolltop&&(this.getTarget().scrollTop(this.scrolltop),this.scrolltop=!1)},isTarget:function(){return this.opts.editor.scrollTarget!==window},getTarget:function(){return this.dom(this.opts.editor.scrollTarget)}});h.add("module","autosave",{send:function(){this.opts.autosave.url&&this._sending()},_getName:function(){return this.opts.autosave.name?
this.opts.autosave.name:this.app.$element.attr("name")||"content"+this.uuid},_sending:function(){var a=this._getName(),b={};b[a]=this.app.$element.val();b=this.app.utils.extendData(b,this.opts.autosave.data);this.ajax.request(this.opts.autosave.method,{url:this.opts.autosave.url,data:b,before:function(c){if(this.app.broadcast("autosave.before.send",{xhr:c,name:a,data:b}).isStopped())return!1}.bind(this),success:function(c){this._complete(c,a,b)}.bind(this)})},_complete:function(a,b,c){this.app.broadcast(a&&
a.error?"autosave.error":"autosave.send",{name:b,data:c,response:a})}});h.add("module","progress",{stop:function(){this.hide()},show:function(){this.hide();this.$progress=this.dom("<div>").addClass(this.prefix+"-editor-progress");this.$progress.attr("id",this.prefix+"-progress");this.$progressBar=this.dom("<span>");this.$progress.append(this.$progressBar);this.app.$body.append(this.$progress)},hide:function(){this.app.$body.find("#"+this.prefix+"-progress").remove()}});h.add("module","clipboard",
{getContent:function(a){var b=this.isPlainText(a)?"text/plain":"text/html";a=a.getData(b);return"text/plain"==b?this.app.content.escapeHtml(a):a},setContent:function(a,b,c){a=a.clipboardData;b=this.app.parser.unparse(b);b='<meta type="'+this.prefix+'-editor"/>'+b;c=c||this.app.content.getTextFromHtml(b,{nl:!0});a.setData("text/html",b);a.setData("text/plain",c)},isPlainText:function(a){var b=a.getData("text/plain");a=a.getData("text/html");return(!a||""===a.trim())&&null!==b}});h.add("module","fragment",
{build:function(a){return this.is(a)?a:this.create(a)},insert:function(a){var b=this.app.selection.get();if(b.range){if(b.collapsed){var c=b.range.startContainer;3!==c.nodeType&&"BR"===c.tagName&&c.parentNode.removeChild(c)}else b.range.deleteContents();a.frag?b.range.insertNode(a.frag):b.range.insertNode(a)}},createContainer:function(a){var b=this.dom("<div>");return"string"==typeof a?b.html(a):b.append(this.dom(a).clone(!0)),b.get()},create:function(a){var b,c;a="string"==typeof a?this.createContainer(a):
a;for(var d=document.createDocumentFragment(),e=[],f=0;b=a.firstChild;){f++;var g=d.appendChild(b);1===f&&(c=g);e.push(g)}return{frag:d,first:c,last:g,nodes:e}},is:function(a){return"object"==typeof a&&a.frag}});h.add("module","button",{init:function(a,b,c,d){"object"==typeof a?(this.name=a.name,this.obj=b,this._buildFromElement(a.element)):a&&(this.type=d||!1,this.name=a,d=this._observe(b),(this.obj=void 0===d?b:d)&&this._build(a,c))},setColor:function(a,b){a=a.getName();"background"!==a&&"text-color"!==
a||this.setBackground(b["background"===a?"background-color":"color"])},isButton:function(){return!0},isAddbar:function(){return this._has("addbar")},isControl:function(){return this._has("control")},getName:function(){return this.name},getTitle:function(){return this.title},getParams:function(){return!!this._has("params")&&this.obj.params},getOffset:function(){return this.$button.offset()},getDimension:function(){return{width:this.$button.width(),height:this.$button.height()}},getElement:function(){return this.$button},
setBackground:function(a){this._background("add",a)},resetBackground:function(){this._background("remove","")},_has:function(a){return Object.prototype.hasOwnProperty.call(this.obj,a)},_observe:function(a){return Object.prototype.hasOwnProperty.call(a,"observer")&&(a=this.app.api(a.observer,a,this.name)),a},_background:function(a,b){this.$icon["remove"===a?"removeClass":"addClass"](this.prefix+"-button-icon-color").css({"background-color":b,color:""!==b?this.app.color.invert(b):""})},_buildFromElement:function(a){this.$button=
this.dom(a);this.$button.addClass(this.prefix+"-button-target");this._buildData()},_build:function(a,b){this._buildTitle();this._buildElement();this._buildIcon();this._buildData(b)},_buildData:function(a){this.$button.attr({tabindex:"-1","data-name":this.name,"data-command":this.obj.command||!1});this.$button.dataset("instance",this);var b=this._has("command")?"_catch":"_stop";this.$button.on("click."+this.prefix+"-button",this[b].bind(this));this.$button.on("dragstart."+this.prefix+"-button",function(c){c.preventDefault()});
a&&(this._buildTooltip(),this._buildBackground(),this._buildPosition(a))},_buildTitle:function(){this.title=void 0!==this.obj.title?this.lang.parse(this.obj.title):""},_buildElement:function(){this.$button=this.dom('<a href="#"></a>');this.$button.addClass(this.prefix+"-button "+this.prefix+"-button-target");this.type&&this.$button.addClass(this.prefix+"-button-"+this.type);this._has("classname")&&this.$button.addClass(this.obj.classname)},_buildIcon:function(){var a=this._has("icon"),b='<span class="'+
this.prefix+"-icon-"+this.name+'"></span>';this.$icon=this._buildIconElement();a&&!0!==this.obj.icon&&(b=-1!==this.obj.icon.search(/</)?this.obj.icon:'<span class="'+this.prefix+"-icon-"+this.obj.icon+'"></span>');this.opts.buttons.icons&&void 0!==this.opts.buttons.icons[this.name]&&(b=this.opts.buttons.icons[this.name]);this.$icon.append(b);this.$button.append(this.$icon)},_buildIconElement:function(){return this.dom("<span>").addClass(this.prefix+"-button-icon")},_buildTooltip:function(){("toolbar"===
this.type||"context"===this.type&&this.opts.tooltip.context)&&this.app.tooltip.build(this.$button,this.title)},_buildBackground:function(){this._has("background")&&this.setBackground(this.obj.background)},_buildPosition:function(a){if(this._has("position")){var b=this.obj.position;if("first"===b)a.prepend(this.$button);else if("object"==typeof b){var c=Object.prototype.hasOwnProperty.call(b,"after")?"after":"before";(b=this._findPositionElement(b[c],a))?b[c](this.$button):a.append(this.$button)}}else a.append(this.$button)},
_findPositionElement:function(a,b){var c;if(Array.isArray(a))for(var d=0;d<a.length&&0===(c=b.find("[data-name="+a[d]+"]")).length;d++);else c=b.find("[data-name="+a+"]");return 0!==c.length?c:0},_stop:function(a){a.preventDefault();a.stopPropagation()},_catch:function(a){a.preventDefault();a.stopPropagation();var b=this.dom(a.target).closest("."+this.prefix+"-button-target");if(!b.hasClass("disable")){this.app.editor.setFocus();var c=b.attr("data-command"),d=b.attr("data-name");b=b.dataget("instance");
this.app.api(c,this.getParams(),b,d,a);this.app.tooltip.close()}}});h.add("module","tooltip",{init:function(){this.classname=this.prefix+"-tooltip";this.eventname=this.prefix+"-button-"+this.uuid},stop:function(){this.close()},build:function(a,b){(b=this._cleanTitle(b))&&(a.attr("data-tooltip",b),a.on("mouseover."+this.eventname,this.open.bind(this)),a.on("mouseout."+this.eventname,this.close.bind(this)))},open:function(a){a=this._getButton(a);this.app.popup.isOpen()||a.hasClass("disable")||(this.$tooltip=
this._create(a),this._setPosition(a),this._fixBSModal(),this.app.$body.append(this.$tooltip))},close:function(){this.app.$body.find("."+this.classname).remove()},_create:function(a){return this.dom("<span>").addClass(this.classname).html(a.attr("data-tooltip"))},_cleanTitle:function(a){return!!a&&a.replace(/(<([^>]+)>)/gi,"")},_setPosition:function(a){var b=a.offset();a=a.height();this.$tooltip.css({top:b.top+a+"px",left:b.left+"px"})},_fixBSModal:function(){this.opts.bsmodal&&this.$tooltip.css("z-index",
1060)},_getButton:function(a){return this.dom(a.target).closest("."+this.prefix+"-button-target")}});h.add("module","codemirror",{init:function(){this.cm=!1},create:function(a){if(this.is()){var b="object"==typeof this.opts.codemirror?this.opts.codemirror:{};return this.cm=(this.opts.codemirrorSrc?this.opts.codemirrorSrc:CodeMirror).fromTextArea(this.dom(a.el).get(),b),a.height&&this.cm.setSize(null,a.height),a.focus&&this.cm.focus(),this.cm}},destroy:function(){this.cm&&(this.cm.toTextArea(),this.cm=
!1)},is:function(){return this.opts.codemirror},val:function(a){return this.is()&&this.cm&&(a=this.cm.getValue()),a}});h.add("class","upload",{defaults:{type:"image",box:!1,url:!1,cover:!0,name:"file",data:!1,multiple:!0,placeholder:!1,hidden:!0,target:!1,success:!1,error:!1,remove:!1,trigger:!1,input:!1},init:function(a,b,c){this.eventname=this.prefix+"-upload";a&&this._build(a,b,c)},send:function(a,b,c,d){this.p=this._buildParams(c,d);this._send(a,b)},complete:function(a,b){this._complete(a,b)},
setImage:function(a){this.p.input||(this.$image&&this.$image.remove(),this.$remove&&this.$remove.remove(),""===a?this.$placeholder.show():(this.$placeholder.hide(),this._buildImage(a),this.p.remove&&this._buildRemove()))},_build:function(a,b,c){this.p=this._buildParams(b,c);this.$element=this.dom(a);"INPUT"===this.$element.get().tagName?this._buildByInput():this._buildByBox()},_buildImage:function(a){this.$image=this.dom("<img>");this.$image.attr("src",a);this.$box.append(this.$image);!1===this.p.input&&
(this.$box.off("click."+this.eventname),this.$image.on("click."+this.eventname,this._click.bind(this)))},_buildRemove:function(){this.$remove=this.dom("<span>");this.$remove.addClass(this.prefix+"-upload-remove");this.$remove.on("click",this._removeImage.bind(this));this.$box.append(this.$remove)},_buildParams:function(a,b){return a=p.extend(!0,this.defaults,a),b&&(a.trigger=b),a},_buildByInput:function(){this.$input=this.$element;this.p.box?(this._buildBox(),this._buildPlaceholder()):this.p.input=
!0;this._buildAccept();this._buildMultiple();this._buildEvents()},_buildByBox:function(){this._buildInput();this._buildAccept();this._buildMultiple();this._buildBox();this._buildPlaceholder();this._buildEvents()},_buildBox:function(){this.$box=this.dom("<div>").addClass(this.prefix+"-form-upload-box");this.$element.before(this.$box);!1===this.p.cover&&this.$box.addClass(this.prefix+"-form-upload-cover-off");this.p.hidden&&this.$element.hide()},_buildPlaceholder:function(){this.p.placeholder&&(this.$placeholder=
this.dom("<span>").addClass(this.prefix+"-form-upload-placeholder"),this.$placeholder.html(this.p.placeholder),this.$box.append(this.$placeholder))},_buildInput:function(){this.$input=this.dom("<input>");this.$input.attr("type","file");this.$input.attr("name",this._getUploadParam());this.$input.hide();this.$element.before(this.$input)},_buildAccept:function(){if("image"===this.p.type){var a=this.opts.image.types.join(",");this.$input.attr("accept",a)}},_buildMultiple:function(){"image"===this.p.type&&
(this.p.multiple?this.$input.attr("multiple","multiple"):this.$input.removeAttr("multiple"))},_buildEvents:function(){this.$input.on("change."+this.eventname+"-"+this.uuid,this._change.bind(this));!1===this.p.input&&(this.$box.on("click."+this.eventname,this._click.bind(this)),this.$box.on("drop."+this.eventname,this._drop.bind(this)),this.$box.on("dragover."+this.eventname,this._dragover.bind(this)),this.$box.on("dragleave."+this.eventname,this._dragleave.bind(this)))},_buildData:function(a,b,c){if("single"===
this.p.multiple)c.append(a,b[0]);else if(this.p.multiple)for(var d=0;d<b.length;d++)c.append(a+"[]",b[d]);else c.append(a+"[]",b[0]);return c},_removeImage:function(a){a&&(a.preventDefault(),a.stopPropagation());this.$image&&this.$image.remove();this.$remove&&this.$remove.remove();this.$placeholder.show();!1===this.p.input&&this.$box.on("click."+this.eventname,this._click.bind(this));a&&this.app.api(this.p.remove,a)},_getUploadParam:function(){return this.p.name},_click:function(a){a.preventDefault();
this.$input.click()},_change:function(a){this._send(a,this.$input.get().files)},_drop:function(a){a.preventDefault();this._send(a)},_dragover:function(a){return a.preventDefault(),this._setStatus("hover"),!1},_dragleave:function(a){return a.preventDefault(),this._removeStatus(),!1},_setStatus:function(a){!this.p.input&&this.p.box&&(this._removeStatus(),this.$box.addClass(this.prefix+"-form-upload-"+a))},_removeStatus:function(){if(!this.p.input&&this.p.box)for(var a=["hover","error"],b=0;b<a.length;b++)this.$box.removeClass(this.prefix+
"-form-upload-"+a[b])},_send:function(a,b){b=b||a.dataTransfer.files;var c=new FormData,d=this._getUploadParam();c=this._buildData(d,b,c);c=this.app.utils.extendData(c,this.p.data);this._sendData(a,b,c)},_sendData:function(a,b,c){"function"==typeof this.p.url?this.p.url.call(this.app,this,{data:c,files:b,e:a}):(this.app.progress.show(),this.ajax.post({url:this.p.url,data:c,before:function(d){if(this.app.broadcast("upload.before.send",{xhr:d,data:c,files:b,e:a}).isStopped())return this.app.progress.hide(),
!1}.bind(this),success:function(d){this._complete(d,a)}.bind(this),error:function(d){this._complete(d,a)}.bind(this)}))},_complete:function(a,b){a&&a.error?(this._setStatus("error"),this.p.error&&(this.app.broadcast("upload.error",{response:a}),this.app.api(this.p.error,a,b))):(this._removeStatus(),this._trigger(a),this.p.success&&(this.app.broadcast("upload.complete",{response:a}),this.app.api(this.p.success,a,b)));setTimeout(function(){this.app.progress.hide()}.bind(this),500)},_trigger:function(a){if(this.p.trigger&&
a&&a.url){var b=this.p.trigger.instance;b[this.p.trigger.method].call(b,a.url)}}});h.add("module","statusbar",{init:function(){this.classname=this.prefix+"-statusbar"},start:function(){this._build()},add:function(a,b){return this.update(a,b)},update:function(a,b){var c=this.get(a);return 0===c.length&&(c=this._buildItem(a)),c.html(b)},get:function(a){return this.$statusbar.find(a?"[data-name="+a+"]":"[data-name]")},remove:function(a){this.get(a).remove()},clear:function(){this.$statusbar.html("")},
_build:function(){this.$statusbar=this.dom("<div>").attr("dir",this.opts.editor.direction);this.$statusbar.addClass(this.classname+" "+this.classname+"-"+this.uuid);this.app.container.get("statusbar").append(this.$statusbar)},_buildItem:function(a){var b=this.dom("<span>").addClass(this.classname+"-item");return b.attr("data-name",a),this.$statusbar.append(b),b}});h.add("module","container",{init:function(){this.blurclass=this.prefix+"-in-blur";this.focusclass=this.prefix+"-in-focus"},start:function(){this._buildMain();
this._buildContainers(this.$main,this.opts.containers.main);this._buildBSModal()},stop:function(){this.$main.remove()},get:function(a){return this["$"+a]},setFocus:function(){this.$main.removeClass(this.blurclass).addClass(this.focusclass)},setBlur:function(){this.$main.removeClass(this.focusclass).addClass(this.blurclass)},isFocus:function(){return this.$main.hasClass(this.focusclass)},_buildMain:function(){this.$main=this.dom("<div>").attr(this.prefix+"-uuid",this.uuid);this.$main.addClass(this.prefix+
"-container "+this.prefix+"-container-"+this.uuid);this.app.$element.after(this.$main)},_buildContainers:function(a,b){for(var c=0;c<b.length;c++){var d=b[c],e="$"+d;this[e]=this._createContainer(d);void 0!==this.opts.containers[d]&&this._buildContainers(this[e],this.opts.containers[d]);a.append(this[e])}},_buildBSModal:function(){this.opts.bsmodal=0!==this.$main.closest(".modal-dialog").length},_createContainer:function(a){return this.dom("<div>").addClass(this.prefix+"-"+a+"-container")}});h.add("module",
"shortcut",{init:function(){if(this.opts.shortcutsRemove)for(var a=this.opts.shortcutsRemove,b=0;b<a.length;b++)this.remove(a[b]);this.shortcuts=this.opts.shortcuts;this.hotkeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",
107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};this.hotkeysShiftNums={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}},add:function(a,b){this.shortcuts[a]=b},remove:function(a){this.opts.shortcutsBase=
this._remove(a,this.opts.shortcutsBase);this.opts.shortcuts=this._remove(a,this.opts.shortcuts)},popup:function(a,b){a=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)?"<b>&#8984;</b>":"ctrl";var c={};var d=this._buildPopupItems(c,0,this.opts.shortcutsBase,a,"base");this._buildPopupItems(c,d,this.opts.shortcuts,a);this.app.popup.create("shortcuts",{width:"360px",items:c});this.app.popup.open({button:b})},handle:function(a){if((this.triggered=!1)===this.shortcuts)return!a.ctrlKey&&!a.metaKey||66!==
a.which&&73!==a.which||a.preventDefault(),!0;if(a.ctrlKey||a.metaKey||a.shoftKey||a.altKey)for(var b in this.shortcuts)this.shortcuts.hasOwnProperty(b)&&this._build(a,b,this.shortcuts[b]);return this.triggered},_buildPopupItems:function(a,b,c,d,e){for(var f in c)if(c.hasOwnProperty(f)){var g=this.dom("<div>").addClass(this.prefix+"-popup-shortcut-item"),l="base"===e?c[f]:c[f].title;l=this.dom("<span>").addClass(this.prefix+"-popup-shortcut-title").html(this.lang.parse(l));for(var m=this.dom("<span>").addClass(this.prefix+
"-popup-shortcut-kbd"),r=("base"===e?f.replace("meta",d):c[f].name.replace("meta",d)).split("+"),v=0;v<r.length;v++)r[v]="<span>"+r[v]+"</span>";m.html(r.join("+"));g.append(l);g.append(m);a[b]={html:g};b++}return b},_build:function(a,b,c){b=b.split(",");for(var d=b.length,e=0;e<d;e++)"string"!=typeof b[e]||Object.prototype.hasOwnProperty.call(c,"trigger")||this._handler(a,b[e].trim(),c)},_handler:function(a,b,c){b=b.toLowerCase().split(" ");for(var d=this.hotkeys[a.keyCode],e=91!==a.which&&String.fromCharCode(a.which).toLowerCase(),
f="",g={},l=["meta","ctrl","alt","shift"],m=0;m<l.length;m++){var r=l[m];a[r+"Key"]&&d!==r&&(f+=r+"+")}93===a.keyCode&&(f+="meta+");d&&(g[f+d]=!0);e&&(g[f+e]=!0,g[f+this.hotkeysShiftNums[e]]=!0,"shift+"===f&&(g[this.hotkeysShiftNums[e]]=!0));d=b.length;for(e=0;e<d;e++)if(g[b[e]])return a.preventDefault(),this.triggered=!0,void this.app.api(c.command,c.params,a)},_remove:function(a,b){return Object.keys(b).reduce(function(c,d){return d!==a&&(c[d]=b[d]),c},{})}});h.add("module","offset",{get:function(a){a=
this._getEl(a);var b=this.app.editor.getWinNode().getSelection(),c=!1;if(b&&0<b.rangeCount){var d=b.getRangeAt(0);a.contains(b.anchorNode)&&(b=d.cloneRange(),b.selectNodeContents(a),b.setEnd(d.startContainer,d.startOffset),a=b.toString().length,c={start:a,end:a+d.toString().length})}return c},set:function(a,b){!1===b&&(b={start:0,end:0});a=this._getEl(a);var c,d=0,e=this.app.editor.getDocNode().createRange(),f=[a],g=!1,l=!1;e.setStart(a,0);for(e.collapse(!0);!l&&(c=f.pop());)if(3===c.nodeType)a=d+
c.length,!g&&b.start>=d&&b.start<=a&&(e.setStart(c,b.start-d),g=!0),g&&b.end>=d&&b.end<=a&&(e.setEnd(c,b.end-d),l=!0),d=a;else for(a=c.childNodes.length;a--;)f.push(c.childNodes[a]);this.app.selection.setRange(e)},_getEl:function(a){return a?this.dom(a).get():this.app.editor.getLayout().get()}});h.add("module","marker",{build:function(a){a=this.dom("<span>").attr("id","selection-marker-"+a);return a.addClass(this.prefix+"-selection-marker"),a.html(this.opts.markerChar),a.get()},insert:function(){this.remove();
var a=this.app.selection.get(),b=!a.collapsed;if(a.range){var c=this.build("start"),d=this.build("end"),e=a.range.cloneRange();b&&(e.collapse(!1),e.insertNode(d));e.setStart(a.range.startContainer,a.range.startOffset);e.collapse(!0);e.insertNode(c);a.range.setStartAfter(c);b&&a.range.setEndBefore(d);this.app.selection.setRange(a.range)}},restore:function(){var a=this.find("start"),b=this.find("end"),c=this.app.selection.get();c=c.range?c.range:this.app.editor.getDocNode().createRange();if(a){var d=
!!b&&b.previousSibling,e=a.nextSibling;e=(!e||3!==e.nodeType||""!==e.textContent.replace(/[\n\t]/g,""))&&e;b?e&&"selection-marker-end"===e.id?this._restoreInject(c,a):d&&e?(c.selectNodeContents(d),c.collapse(!1),c.setStart(e,0)):d&&!e?(c.selectNodeContents(d),c.collapse(!1),c.setStartAfter(a)):(c.setStartAfter(a),c.setEndBefore(b)):e?(c.selectNodeContents(e),c.collapse(!0)):this._restoreInject(c,a);this.app.selection.setRange(c);c=a&&b?2:1;d=this.app.offset.get();d={start:d.start-c,end:d.end-c};a&&
a.parentNode.removeChild(a);b&&b.parentNode.removeChild(b);this.app.editor.setWinFocus();this.app.offset.set(!1,d)}},find:function(a){a=this.app.editor.getLayout().find("#selection-marker-"+a);return 0!==a.length&&a.get()},remove:function(){var a=this.find("start"),b=this.find("end");a&&a.parentNode.removeChild(a);b&&b.parentNode.removeChild(b)},_restoreInject:function(a,b){var c=this.app.utils.createInvisibleChar();this.dom(b).after(c);a.selectNodeContents(c);a.collapse(!1)}});h.add("module","state",
{init:function(){this.state=this.storage=this.started=!1;this.passed=!0;this.undoStorage=[];this.redoStorage=[]},load:function(){this.clear();this.trigger(!0)},stop:function(){this.clear()},clear:function(){this.state=this.storage=!1;this.passed=!0;this.undoStorage=[];this.redoStorage=[]},get:function(){return this.undoStorage},add:function(a){a&&(a.ctrlKey||a.metaKey||this._isUndo(a)||this._isRedo(a))||!this.app.observer.trigger||(this.state=this._createState(),!1===this.started&&(this._setState(this.state,
0),this.started=!0))},trigger:function(a){if(this.passed){var b=this._createState();this.state?b=this.state:this.state||a||(b=this.storage,this.started=!0);this._addState(b);this.storage=this._createState();this.state=!1}},listen:function(a){return this._isUndo(a)?(a.preventDefault(),this.undo(),!0):this._isRedo(a)?(a.preventDefault(),this.redo(),!0):void(this.passed=!0)},undo:function(){if(this._hasUndo()){this.passed=!1;var a=this._getUndo();this._setRedo();var b=this.app.parser.parse(a[0]);this.app.editor.getLayout().html(b.children());
this._rebuild(a,"undo");b=this.app.block.get();b=!(!b||!b.isEditable())&&b.getBlock();this.app.offset.set(b,a[1])}},redo:function(){if(this._hasRedo()){this.passed=!1;var a=this.redoStorage.pop();this._addState(a);var b=this.app.parser.parse(a[0]);this.app.editor.getLayout().html(b.children());this._rebuild(a,"redo");b=this.app.block.get();b=!(!b||!b.isEditable())&&b.getBlock();this.app.offset.set(b,a[1])}},_rebuild:function(a,b){this.app.editor.build();this.app.editor.getLayout().find("."+this.prefix+
"-block-state").each(function(c){this.app.block.set(c)}.bind(this));this.app.broadcast("state."+b,{html:a[0],offset:a[1]})},_isUndo:function(a){var b=a.which;return(a.ctrlKey||a.metaKey)&&90===b&&!a.shiftKey&&!a.altKey},_isRedo:function(a){var b=a.which;return(a.ctrlKey||a.metaKey)&&(90===b&&a.shiftKey||89===b&&!a.shiftKey)&&!a.altKey},_hasUndo:function(){return 0!==this.undoStorage.length},_hasRedo:function(){return 0!==this.redoStorage.length},_getUndo:function(){return 1===this.undoStorage.length?
this.undoStorage[0]:this.undoStorage.pop()},_createState:function(){var a=this.app.editor.getLayout().html();a=this.app.utils.wrap(a,function(c){c.find("."+this.prefix+"-block-focus").addClass(this.prefix+"-block-state")}.bind(this));var b=this.app.block.get();b=!(!b||!b.isEditable())&&b.getBlock();return{html:this.app.parser.unparse(a,!0),offset:this.app.offset.get(b)}},_setState:function(a,b){this.undoStorage[b]=[a.html,a.offset]},_addState:function(a){var b=this.undoStorage[this.undoStorage.length-
1];void 0===b||b[0]!==a.html?(this.undoStorage.push([a.html,a.offset]),this._removeOverStorage()):b[1]=a.offset},_setRedo:function(){var a=this._createState();this.redoStorage.push([a.html,a.offset]);this.redoStorage=this.redoStorage.slice(0,this.opts.state.limit)},_removeOverStorage:function(){this.undoStorage.length>this.opts.state.limit&&(this.undoStorage=this.undoStorage.slice(0,this.undoStorage.length-this.opts.state.limit))}});h.add("module","sync",{build:function(){this.syncedHtml=this.app.$element.val()},
trigger:function(){this.opts.editor.sync&&(this.typingTimer&&clearTimeout(this.typingTimer),this.typingTimer=setTimeout(function(){var a=this._getHtml();this.is(a)&&this._sync(a)}.bind(this),300))},invoke:function(){var a=this._getHtml();this.syncedHtml=a;this._sync(a)},is:function(a){var b=!1;return this.syncedHtml!==a&&(this.syncedHtml=a,b=!0),b},_getHtml:function(){var a=this.app.editor.getLayout().html();return this.app.parser.unparse(a)},_sync:function(a){a=this.app.broadcast("editor.before.change",
{html:a});a.isStopped()||(this.app.$element.val(a.get("html")),this.app.autosave.send(),this.app.state.trigger(),this.app.broadcast("editor.change",a))}});h.add("module","placeholder",{start:function(){this.placeholder=!1;this.$layout=this.app.editor.getLayout();this._build()},handleClick:function(a){this.dom(a.target).hasClass(this.prefix+"-placeholder")&&(a.preventDefault(),a.stopPropagation(),this.app.editor.setFocus("start"))},trigger:function(){this.placeholder&&this.app.editor.isEmpty(!0)?this.show():
this.hide()},toggle:function(){this.observerTimer&&clearTimeout(this.observerTimer);this.observerTimer=setTimeout(this.trigger.bind(this),10)},show:function(){this.$layout.addClass(this.prefix+"-placeholder")},hide:function(){this.$layout.removeClass(this.prefix+"-placeholder")},_build:function(){var a=this.opts.placeholder,b=this.app.$element.attr("placeholder");!1===a&&!b||(this.$layout.attr("placeholder",!1!==a?a:b),this.placeholder=!0,this.toggle())}});h.add("module","list",{indent:function(){var a=
this.app.selection.get(),b=this.app.selection.getBlock(),c=this.dom(b),d=c.prevElement();d=d.get();a=a.collapsed&&b&&d&&"LI"===d.tagName;if(this.app.selection.save(b),a){b=(d=this.dom(d)).children("ul, ol");var e=c.closest("ul, ol");0!==b.length?b.append(c):(b=e.get().tagName.toLowerCase(),b=this.dom("<"+b+">"),b.append(c),d.append(b))}return this.app.selection.restore(),a},outdent:function(){var a=this.app.selection.get(),b=this.app.selection.getBlock(),c=this.dom(b),d=!1;if(a.collapsed&&b){var e=
c.parent();a=e.closest("li");var f=c.prevElement(),g=c.nextElement();f=f.get();var l=g.get();g=!1===f;f=!1!==f&&!1!==l;if(this.app.selection.save(b),0!==a.length){if(f){b=this._getAllNext(c.get());d=this.dom("<"+e.get().tagName.toLowerCase()+">");for(e=0;e<b.length;e++)d.append(b[e]);a.after(c);c.append(d)}else a.after(c),0===e.children().length?e.remove():g&&c.append(e);d=!0}this.app.selection.restore()}return d},_getAllNext:function(a){for(var b=[];a&&(a=this.dom(a).nextElement().get());)b.push(a);
return b}});h.add("module","cleaner",{cleanHtml:function(a){a=this.app.broadcastHtml("editor.before.clean",a);var b={},c=this.opts.paste.blockTags.concat(this.opts.paste.inlineTags).concat(this.opts.paste.formTags),d=this._isPages(a),e=this._isHtmlMsWord(a),f=this._isEditor(a);a=this.app.content.store(a,"embed",b,0);a=this.app.content.removeDoctype(a);a=(a=this.app.content.removeTags(a,this.opts.tags.denied)).trim();a=this.app.content.removeComments(a);a=this.app.content.removeTagsWithContent(a,["script",
"style"]);a=d?this._cleanPages(a):a;a=e?a:this._cleanGDocs(a);a=this._encodePhp(a);a=this.app.content.removeTagsExcept(a,c);a=e?this._cleanMsWord(a):a;c=!1;if(!f&&this.app.event.pasteEvent&&(a=this.app.content.restore(a,"embed",b),c=!0),!f){var g=0!==this.opts.paste.keepClass.length?this.opts.paste.keepClass.join(","):"",l=0!==this.opts.paste.keepAttrs.length?this.opts.paste.keepAttrs.join(","):"";a=this.app.utils.wrap(a,function(m){m=m.find("*");m.not(g).removeAttr("class");m.not(l).each(function(r){r=
r.get();for(var v=r.attributes,x=v.length-1;0<=x;x--){var w=v[x].name;"class"!==w&&"dir"!==w&&-1===w.search(/^data-/)&&("IMG"!==r.tagName||"src"!==w&&"alt"!==w)&&("A"!==r.tagName||"href"!==w&&"target"!==w)&&r.removeAttribute(w)}})})}return c||(a=this.app.content.restore(a,"embed",b)),a=f?this.app.content.cacheStyle(a):this.app.content.removeStyleAttr(a),a=(a=(a=(a=(a=(a=this.app.content.removeEmptyInlines(a)).replace(/<figure[^>]*><\/figure>/gi,"")).replace(/<p>&nbsp;<\/p>/gi,"<p></p>")).replace(/<p><br\s?\/?><\/p>/gi,
"<p></p>")).replace(/^<li/gi,"<ul><li")).replace(/<\/li>$/gi,"</li></ul>"),(e||d)&&(a=(a=a.replace(/<p><\/p>/gi,"")).replace(/<p>\s<\/p>/gi,"")),a=this.app.utils.wrap(a,function(m){m.find(".Apple-converted-space").unwrap();m.find("ul, ol").each(this._placeListToItem.bind(this));m.find("li p").unwrap()}.bind(this)),this.app.broadcastHtml("editor.clean",a)},_encodePhp:function(a){return a.replace("<?php","&lt;?php").replace("<?","&lt;?").replace("?>","?&gt;")},_isEditor:function(a){return a.match(new RegExp('meta\\stype="'+
this.prefix+'-editor"',"i"))},_isHtmlMsWord:function(a){return a.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)},_isPages:function(a){return a.match(/name="Generator"\scontent="Cocoa\sHTML\sWriter"/i)},_placeListToItem:function(a){a=a.get();var b=a.previousSibling;b&&"LI"===b.tagName&&(b=this.dom(b),b.find("p").unwrap(),b.append(a))},_cleanPages:function(a){return a.replace(/\sclass="s[0-9]"/gi,"").replace(/\sclass="p[0-9]"/gi,"")},_cleanGDocs:function(a){return a.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,
"$2").replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3").replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?(bold|600|700)|font-weight:\s?(bold|600|700);\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$4</i></b>").replace(/<span[^>]*font-style:\s?italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1</i>").replace(/<span[^>]*font-weight:\s?(bold|600|700)[^>]*>([\w\W]*?)<\/span>/gi,"<b>$2</b>")},_cleanMsWord:function(a){a=(a=(a=(a=(a=(a=a.replace(/\x3c!--[\s\S]+?--\x3e/gi,"")).trim()).replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|meta|link|style|\w:\w+)(?=[\s/>]))[^>]*>/gi,
"")).replace(/<(\/?)s>/gi,"<$1strike>")).replace(/&nbsp;/gi," ")).replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(e,f){return 0<f.length?f.replace(/./," ").slice(Math.floor(f.length/2)).split("").join("\u00a0"):""});var b="",c=(a=(a=(a=(a=(a=(a=this.app.utils.wrap(a,function(e){e.find("p").each(function(f){var g=/mso-list:\w+ \w+([0-9]+)/.exec(f.attr("style"));g&&f.attr("data-listLevel",parseInt(g[1],10))});this._parseWordLists(e);e.find("[align]").removeAttr("align");
e.find("[name]").removeAttr("name");e.find("span").each(function(f){var g=f.attr("style");/mso-list:Ignore/.exec(g)?f.remove():f.unwrap()});e.find("[style]").removeAttr("style");e.find("[class^='Mso']").removeAttr("class");e.find("a").filter(function(f){return!f.attr("href")}).unwrap()}.bind(this))).replace(/<p><img(.*?)>/gi,"<p><img$1></p><p>")).replace(/<p[^>]*><\/p>/gi,"")).replace(/<li>\u00b7/gi,"<li>")).trim()).replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,
"/$1>\n<$2")).split(/\n/);for(a=0;a<c.length;a++){var d=""!==c[a]&&-1===c[a].search(/>$/)?" ":"\n";b+=c[a]+d}return b=b.trim()},_parseWordLists:function(a){var b=0,c=null,d=null,e=null;a.find("p").each(function(f){var g=f.attr("data-listLevel");if(null===g&&f.hasClass("MsoListParagraphCxSpMiddle")&&(g=1),null!==g){var l=f.text();l=/^\s*\w+\./.test(l)?"<ol></ol>":"<ul></ul>";if(f.hasClass("MsoListParagraphCxSpFirst")||f.hasClass("MsoNormal")?(d=this.dom(l),f.before(d)):b<g&&0!==b&&(e=this.dom(l),c.append(e),
d=e),g<b)for(var m=b-g+1,r=0;r<m;r++)d=d.parent();f.find("span").first().unwrap();c=this.dom("<li>"+f.html().trim()+"</li>");null===d&&(f.before(l),d=f.prev());d.append(c);f.remove();b=g}else d=null,b=0}.bind(this))}});h.add("module","tidy",{init:function(){},parse:function(a){a=this.app.content.encodeAttrSings(a);var b=["li"],c=["li"];this.lineBefore=new RegExp("^<(/?"+b.join("|/?")+"|"+c.join("|")+")[ >]");this.lineAfter=new RegExp("^<(/?"+b.join("|/?")+"|/"+c.join("|/")+")[ >]");this.newLevel=
/^<\/?(p|ul|ol|li|div|h1|h2|h3|h4|h5|h6|blockquote|figure|figcaption|table|thead|tbody|tfoot|tr|td|th|dl|dt|dd)[ >]/;b=0;c=a.length;var d,e,f=null,g,l="",m="";for(this.cleanlevel=0;b<c;b++){if(d=b,-1===a.substr(b).indexOf("<"))return l+=a.substr(b),this.finish(l);for(;d<c&&"<"!==a.charAt(d);)d++;b!==d&&((m=a.substr(b,d-b)).match(/^\s{2,}$/g)||("\n"===l.charAt(l.length-1)?l+=this.getTabs():"\n"===m.charAt(0)&&(l+="\n"+this.getTabs(),m=m.replace(/^\s+/,"")),l+=m));for(e=d;d<c&&">"!==a.charAt(d);)d++;
if(b=d,"!--"===(g=a.substr(e,d-e)).substr(1,3)){if(!g.match(/--$/)){for(;"--\x3e"!==a.substr(d,3);)d++;d+=2;g=a.substr(e,d-e);b=d}"\n"!==l.charAt(l.length-1)&&(l+="\n");l+=this.getTabs();l+=g+">\n"}else"!"===g[1]?l=this.placeTag(g+">",l):"?"===g[1]?l+=g+">\n":void 0===g.match(/^<(script|style|pre)/i)?((void 0)[1]=(void 0)[1].toLowerCase(),g=this.cleanTag(g),l=this.placeTag(g,l),(f=String(a.substr(b+1)).toLowerCase().indexOf("</"+(void 0)[1]))&&(m=a.substr(b+1,f),b+=f,l+=m)):(g=this.cleanTag(g),l=
this.placeTag(g,l))}return this.finish(l)},getTabs:function(){for(var a="",b=0;b<this.cleanlevel;b++)a+="    ";return a},finish:function(a){return a=(a=(a=(a=(a=(a=(a=a.replace(/\n\s*\n/g,"\n")).replace(/^[\s\n]*/,"")).replace(/[\s\n]*$/,"")).replace(/<li(.*?)>[\s\n]*/gi,"<li$1>")).replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>[\s\n]*<\/\1>/gi,"<$1$2></$1>")).replace(/[\s\n]*<\/li>/gi,"</li>")).replace(/<script(.*?)>\n<\/script>/gi,"<script$1>\x3c/script>"),a=this.app.content.decodeAttrSings(a),this.cleanlevel=
0,a},cleanTag:function(a){var b,c="",d="";for((a=(a=(a=a.replace(/\n/g," ")).replace(/\s{2,}/g," ")).replace(/^\s+|\s+$/g," ")).match(/\/$/)&&(d="/",a=a.replace(/\/+$/,""));b=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(a);)b[2]?c+=b[1].toLowerCase()+"="+b[2]:b[1]&&(c+=b[1].toLowerCase()),c+=" ",a=a.substr(b[0].length);return c.replace(/\s*$/,"")+d+">"},placeTag:function(a,b){var c=a.match(this.newLevel);return(a.match(this.lineBefore)||c)&&(b=b.replace(/\s*$/,""),b+="\n"),c&&"/"===a.charAt(1)&&this.cleanlevel--,
"\n"===b.charAt(b.length-1)&&(b+=this.getTabs()),c&&"/"!==a.charAt(1)&&this.cleanlevel++,b+=a,(a.match(this.lineAfter)||a.match(this.newLevel))&&(b=b.replace(/ *$/,""),b+="\n"),b}});h.add("module","source",{start:function(){this.eventname=this.prefix+"-source-events";this._build()},toggle:function(){this.is()?this.close():this.open()},is:function(){return"none"!==this.app.container.get("source").css("display")},open:function(){this.app.broadcast("source.before.open");var a=this.app.editor.getContent();
a=this.app.tidy.parse(a);var b=this.app.container.get("editor").height();this.$source.height(b);this.$source.val(a);this.$source.on("focus."+this.eventname,this._handleFocus.bind(this));this.$source.on("input."+this.eventname,this._handleChanges.bind(this));this.$source.on("keydown."+this.eventname,this.app.input.handleTextareaTab.bind(this));this.app.editor.unselectAll();this.app.container.get("editor").hide();this.app.container.get("source").show();(a=this.app.codemirror.create({el:this.$source,
height:b,focus:!0}))&&(a.on("change",this._handleChanges.bind(this)),a.on("focus",this._handleFocus.bind(this)));this.app.editor.disableUI();this.app.toolbar.setToggled("html");this.app.broadcast("source.open")},close:function(){this.app.broadcast("source.before.close");var a=this.getContent();this.app.codemirror.destroy();this.$source.off("."+this.eventname);this.app.container.get("source").hide();this.app.container.get("editor").show();this.app.editor.setContent({html:a,caret:"start"});this.app.editor.enableUI();
this.app.toolbar.unsetToggled("html");this.app.broadcast("source.close")},update:function(a){var b=this.app.editor.isTextarea()?"val":"html";this.app.$element[b](a)},getContent:function(){var a=this.$source.val();return this.app.codemirror.val(a)},_build:function(){this.opts.source&&(this.$source=this.dom("<textarea>").addClass(this.prefix+"-source"),this.$source.attr("data-gramm_editor",!1),this.app.container.get("source").append(this.$source))},_handleFocus:function(){this.app.editor.setFocus()},
_handleChanges:function(a){var b=this.getContent();this.update(b);this.app.broadcast("source.change",{e:a})}});h.add("module","content",{init:function(){this._selectors={code:["pre","code"],embed:["figure"],noneditable:["."+this.opts.noneditable.classname],images:["img"],links:["a"]}},paragraphize:function(a){return this.app.paragraphizer.paragraphize(a)},encodeEntities:function(a){return this.decodeEntities(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},
encodeCode:function(a){return a=(a=(a=(a=(a=(a=(a=(a=this.encodeAttrSings(a)).replace(/<\s/gi,"&lt; ")).replace(/<([^>]+)</gi,"&lt;$1<")).replace(/<(.*?)>/gi,"xtagstartz$1xtagendz")).replace(/xtagstartzpre(.*?)xtagendz/g,"<pre$1>")).replace(/xtagstartzcode(.*?)xtagendz/g,"<code$1>")).replace(/xtagstartz\/codextagendz/g,"</code>")).replace(/xtagstartz\/prextagendz/g,"</pre>"),a=(a=(a=this._encodeCode(a)).replace(/xtagstartz([\w\W]*?)xtagendz/g,"<$1>")).replace(/xtagstartz\/(.*?)xtagendz/g,"</$1>"),
this.decodeAttrSings(a)},encodeAttrSings:function(a){var b=a.match(/="(.*?)"/g);if(null!==b)for(var c=0;c<b.length;c++)if(-1===b[c].search(/^"</)&&-1===b[c].search(/>"$/)){var d=b[c].replace(">","xmoresignz");d=d.replace("<","xlesssignz");a=a.replace(b[c],d)}return a},decodeAttrSings:function(a){return a.replace(/xmoresignz/gi,">").replace(/xlesssignz/gi,"<")},decodeEntities:function(a){return String(a).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},decodeHref:function(a){var b=
a.match(/(href=".*?)(&amp;)(.*?">)/g);if(null!==b)for(var c=0;c<b.length;c++)a=a.replace(b[c],b[c].replace(/&amp;/g,"&"));return a},sanitize:function(a){return a=this.app.utils.wrap(a,function(b){b.find("[src]").each(this._sanitizeSrc);b.find("a").each(this._sanitizeHref);b.find("a,b,i,strong,em,svg,img,details,audio").each(this._sanitizeEvents)}.bind(this))},escapeHtml:function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},
store:function(a,b,c,d){for(var e=this._selectors[b],f=0;f<e.length;f++){var g=this._getElementsFromHtml(a,e[f]);a=this._store(a,b,g,c,d)}return a},restore:function(a,b,c){if(void 0===c[b])return a;for(var d=0;d<c[b].length;d++)a=a.replace("####_"+b+d+"_####",c[b][d]);return a},storeComments:function(a,b){var c=a.match(/\x3c!--([\w\W]*?)--\x3e/gi);if(null===c)return a;for(var d=0;d<c.length;d++)a=a.replace(c[d],"#####xstarthtmlcommentzz"+d+"xendhtmlcommentzz#####"),b.push(c[d]);return a},restoreComments:function(a,
b){for(var c=0;c<b.length;c++){var d=b[c].replace(/\$/gi,"&#36;");a=a.replace("#####xstarthtmlcommentzz"+c+"xendhtmlcommentzz#####",d)}return a},cacheStyle:function(a){var b=this.opts.tags.block.join(",")+",img,"+this.opts.tags.inline.join(",");return this.app.utils.wrap(a,function(c){c.find(b).each(this._cacheStyle.bind(this))}.bind(this))},recacheStyle:function(a){return this.app.utils.wrap(a,function(b){b.find("[data-"+this.prefix+"-style-cache]").each(this._recacheStyle.bind(this))}.bind(this))},
fixListMargin:function(a){var b=parseInt(a.css("margin-left"));if(0!==b){var c=parseInt(a.css("padding-left"));a.css({"margin-left":0,"padding-left":c+b+"px"});a.attr(this.prefix+"-list-left",b)}},unfixListMargin:function(a){a.attr(this.prefix+"-list-left")&&(a.css({"padding-left":"","margin-left":""}),a.removeAttr(this.prefix+"-list-left"))},addNofollow:function(a){return this.opts.link.nofollow?this.app.utils.wrap(a,function(b){b.find("a").attr("rel","nofollow")}):a},addHttps:function(a){return this.opts.editor.https?
a.replace('href="http://','href="https://').replace('src="http://','src="https://').replace('srcset="http://','srcset="https://'):a},addSpaceToBlocks:function(a){return a.replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1> ")},addBrToBlocks:function(a){return a.replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1><br>")},addPredefinedTagClass:function(a){var b=a.get().tagName.toLowerCase(),c=void 0!==this.opts.classes.tags?this.opts.classes.tags:this.opts.classes;void 0!==c[b]&&a.addClass(c[b])},
addPredefinedBlockClass:function(a){var b=a.attr("data-"+this.prefix+"-type"),c=this.opts.classes.blocks;void 0!==c[b]&&a.addClass(c[b])},getPredefinedBlocks:function(){var a=[];return Object.keys(this.opts.classes.blocks).forEach(function(b){a.push(b)}),a},getPredefinedTags:function(){var a=[];return Object.keys(void 0!==this.opts.classes.tags?this.opts.classes.tags:this.opts.classes).forEach(function(b){a.push(b)}),a},getText:function(a){var b="";if(3===a.nodeType)b=a.nodeValue;else{for(var c=0;c<
a.childNodes.length;c++)b+=this.getText(a.childNodes[c]);c=1===a.nodeType?getComputedStyle(a).getPropertyValue("display"):"";(c.match(/^block/)||c.match(/list/)||"BR"===a.tagName||"HR"===a.tagName)&&(b+="\n")}return b},getTextFromHtml:function(a,b){var c={};b=p.extend({},{br:!1,nl:!1,trimlines:!0,images:!1,links:!1},b);a=this.store(a,"code",c,0);a=b.links?this.store(a,"links",c,0):a;a=(a=(a=(a=(a=(a=(a=(a=(a=b.images?this.store(a,"images",c,0):a).replace(/<(ul|ol)>\s+<li>/gi,"<$1><li>")).replace(/<li[^>]*>\n/gi,
"<li$1>")).replace(/<p[^>]*>(\s+|)<\/p>/gi,"xemptyz")).replace(/\x3c!--[\s\S]*?--\x3e/gi,"")).replace(/<style[\s\S]*?style>/gi,"")).replace(/<script[\s\S]*?script>/gi,"")).replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1>\n")).replace(/&(lt|gt);/gi,"x$1z");var d=this.dom("<div>").html(a);if(a=this.getText(d.get()),b.trimlines){d="";a=a.split("\n");for(var e=0;e<a.length;e++)d+=a[e].trim()+"\n";a=d}return a=(a=(a=a.replace(/[\n]+/g,"\n")).replace("xemptyz","\n")).replace(/x(lt|gt)z/gi,"&$1;"),a=
b.br?(a=a.replace(/\n/g,"<br>\n")).replace(/<br\s?\/?>\n?$/gi,""):b.nl?a:a.replace(/\n/gi," "),a=this.restore(a,"code",c),a=b.links?this.restore(a,"links",c):a,a=(a=(a=(a=(a=b.images?this.restore(a,"images",c):a).replace(/<pre[^>]*>/g,"")).replace(/<code[^>]*>/g,"")).replace(/<\/pre>\n?/g,"")).replace(/<\/code>/g,""),b.images||(a=(a=a.replace(/<img[\s\S]*?>/gi,"")).replace(/<a[^>]*>(\s+|)<\/a>/gi,"")),a.trim()},extractHtmlFromCaret:function(a){a=this.dom(a).get();var b=this.app.selection.getRange();
if(b){var c=b.cloneRange();return c.selectNodeContents(a),c.setStart(b.endContainer,b.endOffset),c.extractContents()}},isEmptyHtml:function(a,b){return a=a.trim(),a=(a=(a=(a=(a=(a=(a=(a=(a=this.app.utils.removeInvisibleChars(a)).replace(/^&nbsp;$/gi,"1")).replace(/&nbsp;/gi,"")).replace(/<\/?br\s?\/?>/g,"")).replace(/\s/g,"")).replace(/^<p>\s\S<\/p>$/i,"")).replace(/<hr(.*?[^>])>$/i,"hr")).replace(/<iframe(.*?[^>])>$/i,"iframe")).replace(/<source(.*?[^>])>$/i,"source"),a=this.removeComments(a),""===
(b?a.replace(/<p[^>]*><\/p>/gi,""):a).replace(/<[^/>]><\/[^>]+>/gi,"").replace(/<[^/>]><\/[^>]+>/gi,"").trim()},isLine:function(a){var b=document.createElement("div");return b.innerHTML=a,0===this.dom(b).find(this.opts.tags.block.join(",")+",img").length},removeDoctype:function(a){return a.replace(/<!doctype[^>]*>/gi,"")},removeComments:function(a){return a.replace(/\x3c!--[\s\S]*?--\x3e\n?/g,"")},removeTags:function(a,b){return a.replace(b?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,b?function(c,
d){return-1===b.indexOf(d.toLowerCase())?c:""}:"")},removeTagsExcept:function(a,b){return void 0===b?a.replace(/(<([^>]+)>)/gi,""):a.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(c,d){return-1===b.indexOf(d.toLowerCase())?"":c})},removeTagsWithContent:function(a,b){return this.app.utils.wrap(a,function(c){c.find(b.join(",")).remove()})},removeMarkers:function(a){return this.app.utils.wrap(a,function(b){b.find("."+this.prefix+"-plus-button").remove();b.find("."+this.prefix+"pastemarker").removeClass(this.prefix+
"pastemarker");b.find("."+this.prefix+"pasteitems").removeClass(this.prefix+"pasteitems");b.find("."+this.prefix+"-selection-marker").remove()}.bind(this))},removeEmptySpans:function(a){return this.app.utils.wrap(a,function(b){b.find("span").each(this._removeEmptySpan.bind(this))}.bind(this))},removeEmptyInlines:function(a){return this.app.utils.wrap(a,function(b){b.find(this.opts.tags.inline.join(",")).each(this._removeEmptyTag.bind(this))}.bind(this))},removeEmptyAttrs:function(a,b){return this.app.utils.wrap(a,
function(c){for(var d=0;d<b.length;d++)c.find("["+b[d]+'=""]').removeAttr(b[d])})},removeBlockTags:function(a,b,c){var d=this.opts.tags.block.concat();return c&&(d=this.app.utils.removeFromArrayByValue(d,c)),b=b&&(b?this.app.utils.extendArray(d,b):d),this.removeTags(a,b)},removeBlockTagsInside:function(a,b){return this.blockListTags=this.app.utils.removeFromArrayByValue(this.opts.tags.block.concat(),["ul","ol","li"]),this.app.utils.wrap(a,function(c){c.find(b.join(",")).each(this._removeBlockTagsInside.bind(this))}.bind(this))},
removeInlineStyles:function(a){var b=this.app.utils.removeFromArrayByValue(this.opts.tags.inline,"a");return this.app.utils.wrap(a,function(c){c.find(b.join(",")).removeAttr("style")})},removeStyleAttr:function(a,b){return b=b||"",this.app.utils.wrap(a,function(c){c.find("*").not("[data-"+this.prefix+"-style-cache]"+b).removeAttr("style")}.bind(this))},_cacheStyle:function(a){var b="data-"+this.prefix+"-style-cache",c=a.attr("style");c?(c=c.replace(/"/g,""),a.attr(b,c)):c&&""!==c||a.removeAttr(b)},
_recacheStyle:function(a){var b="data-"+this.prefix+"-style-cache",c=a.attr(b);a.attr("style",c).removeAttr(b)},_cleanEmpty:function(a){return a=a.trim(),this.app.utils.removeInvisibleChars(a).replace(/<\/?br\s?\/?>/g,"").replace(/\s/g,"")},_removeEmptySpan:function(a){0===a.get().attributes.length&&a.unwrap()},_removeEmptyTag:function(a){var b=a.html().trim();0===a.get().attributes.length&&""===b&&a.unwrap()},_removeBlockTagsInside:function(a){var b="LI"===a.get().tagName?this.blockListTags:this.opts.tags.block;
a.find(b.join(",")).append("<br>").unwrap()},_store:function(a,b,c,d,e){if(!c)return a;void 0===d[b]&&(d[b]=[]);for(var f=0;f<c.length;f++)d[b][e]=c[f],a=a.replace(c[f],"####_"+b+e+"_####"),e++;return a},_getElementsFromHtml:function(a,b){var c=[];return this.dom("<div>").html(a).find(b).each(function(d){c.push(d.get().outerHTML)}),c},_sanitizeSrc:function(a){a=a.get();var b=a.getAttribute("src");(-1!==b.search(/^javascript:/i)||"IMG"!==a.tagName&&-1!==b.search(/^data:/i))&&a.setAttribute("src","")},
_sanitizeHref:function(a){a=a.get();var b=a.getAttribute("href");b&&-1!==b.search(/^javascript:/i)&&a.setAttribute("href","")},_sanitizeEvents:function(a){a.removeAttr("onload onerror ontoggle onwheel onmouseover oncopy")},_encodeCode:function(a){return this.app.utils.wrap(a,function(b){b.find("pre code, pre, code").each(this._encodeNode.bind(this))}.bind(this))},_encodeNode:function(a){a=a.get();var b=a.firstChild,c=a.innerHTML;"PRE"===a.tagName&&b&&"CODE"===b.tagName||(c=(c=c.replace(/xtagstartz/g,
"<")).replace(/xtagendz/g,">"),b=this.decodeEntities(c),a.textContent=this._encodeNodeHtml(b))},_encodeNodeHtml:function(a){return a=a.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,"\n"),this.opts.code.spaces?a.replace(/\t/g,Array(this.opts.code.spaces+1).join(" ")):a}});h.add("module","autoparse",{parse:function(a){if(!this.opts.paste.autoparse)return a;var b=this.app.block.get(),c=[];a=this.app.content.storeComments(a,c);a=this.app.content.removeDoctype(a);var d,e="figure html form pre div span video object iframe code a img link script".split(" "),
f=["div","img","html","span"],g=[],l=0;for(d=0;d<e.length;d++){var m=-1!==f.indexOf(e[d])?"<"+e[d]+"[^>]*>":"<"+e[d]+"[^>]*>([\\w\\W]*?)</"+e[d]+">";m=a.match(new RegExp(m,"gi"));if(null!==m)for(var r=0;r<m.length;r++)a=a.replace(m[r],"#####replaceparse"+l+"#####"),g.push(m[r]),l++}if(!(a=a.replace("&amp;","&")).match(this.opts.regex.aurl1)&&!a.match(this.opts.regex.aurl2)||a.match(this.opts.regex.imageurl)||(a=this._formatLinks(a)),a.match(this.opts.regex.imageurl))for(e=a.match(this.opts.regex.imageurl),
d=0;d<e.length;d++)a=a.replace(e[d],this._splitBlock(b,'<img src="'+e[d]+'">'));return a=this._restoreReplaced(g,a),a=this.app.content.restoreComments(a,c),this._restoreReplaced(g,a)},_splitBlock:function(a,b){return a?"\n"+b+"\n":b},_formatLinks:function(a){var b=!1!==this.opts.paste.linkTarget?' target="'+this.opts.paste.linkTarget+'"':"",c=this.opts.editor.https?"https":"http",d=this;return a=(a=a.replace(this.opts.regex.aurl1,function(e){return'<a href="'+e+'"'+b+">"+d._subLinkText(e)+"</a>"})).replace(this.opts.regex.aurl2,
function(e,f,g){return f+'<a href="'+c+"://"+g+'"'+b+">"+d._subLinkText(g)+"</a>"})},_subLinkText:function(a){return-1===(a=a.length>this.opts.link.size?a.substring(0,this.opts.link.size)+"...":a).search("%")?decodeURIComponent(a):a},_restoreReplaced:function(a,b){for(var c=0;c<a.length;c++)b=b.replace("#####replaceparse"+c+"#####",a[c]);return b}});h.add("module","caret",{set:function(a,b){a=this.dom(a).get();var c=this.app.editor.getDocNode().createRange();a&&this._isInPage(a)&&(this.app.editor.setWinFocus(),
this._isInline(a)&&this._isNon(a)&&("start"===b?b="before":"end"===b&&(b="after")),this[{start:"_setStart",end:"_setEnd",before:"_setBefore",after:"_setAfter"}[b]](c,a),this.app.selection.setRange(c))},is:function(a,b,c,d,e){var f=this.dom(a).get(),g=this.app.editor.getWinNode().getSelection();a=!1;if(!f||!g.isCollapsed)return a;e=this._getPosition(f,d,e);c=this._getSize(f,c,d);return"end"===b?a=e===c:"start"===b&&(a=0===e),a},_setStart:function(a,b){a.setStart(b,0);a.collapse(!0);var c=this._getInlineInside(b);
c&&(a=this._setStartInline(a,c));this._isInline(b)&&this._insertInvisibleNode(a)},_setStartInline:function(a,b){b=this.app.element.getAllInlines(b)[0];a.selectNodeContents(b);a.collapse(!0)},_setEnd:function(a,b){var c=1===b.nodeType&&b.lastChild;c&&this._isInline(c)&&(b=c);a.selectNodeContents(b);a.collapse(!1)},_setBefore:function(a,b){a.setStartBefore(b);a.collapse(!0);this._isInline(b)&&this._insertInvisibleNode(a,b)},_setAfter:function(a,b){a.setStartAfter(b);a.collapse(!0);var c=3!==b.nodeType&&
b.tagName.toLowerCase();!this._isInline(b)&&"br"!==c&&"svg"!==c||this._insertInvisibleNode(a)},_insertInvisibleNode:function(a,b){var c=this.app.utils.createInvisibleChar();return b?b.parentNode.insertBefore(c,b):a.insertNode(c),a.selectNodeContents(c),a.collapse(!1),c},_getInlineInside:function(a){a=a.firstChild;if(this._isInline(a)){for(var b=a.firstChild;b;){if(this._isInline(b))return b;b=b.firstChild}return a}},_getSize:function(a,b,c){var d=3===a.nodeType;b&&0!==b.length?(a=this.dom(a).clone(),
a.find(b.join(",")).remove(),b=a.html().trim()):(b=d?a.textContent:a.innerHTML,b=d||!1===c?b:b.trim());return this._trimmed(b,d,c).length},_getPosition:function(a,b,c){var d=this.app.editor.getWinNode().getSelection().getRangeAt(0),e=d.cloneRange(),f=document.createElement("div"),g=3===a.nodeType;e.selectNodeContents(a);e.setEnd(d.endContainer,d.endOffset);f.appendChild(e.cloneContents());a=g||!1===b?f.innerHTML:f.innerHTML.trim();d=-1!==a.search(/<\/?br\s?\/?>$/g)?1:0;return!1===c&&(d=0),this._trimmed(a,
g,b).length+d},_trimmed:function(a,b,c){return!1===c?a.replace(/\n$/g,""):(""===(a=(a=(a=this.app.utils.removeInvisibleChars(a)).replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,"")).replace(/\s+/g," "))||b||(a=a.replace(/\s$/,"")),a)},_isInline:function(a){return this.app.element.is(a,"inline")},_isInPage:function(a){var b=!1,c=this.app.editor.getDocNode();return a&&a.nodeType&&(b=a!==c.body&&c.body.contains(a)),b},_isNon:function(a){return"false"===a.getAttribute("contenteditable")}});h.add("module","selection",
{init:function(){this.savedRange=this.savedPosition=this.savedMarker=this.savedSelection=!1},get:function(){var a=this._getSelection(),b=this._getRange(a),c=this._getCurrent(a);return{selection:a,range:b,collapsed:this._getCollapsed(a,b),current:c,parent:this._getParent(c)}},getRange:function(){return this._getRange(this.get().selection)},getNodes:function(a){var b=this.get(),c=a&&(a.type&&"inline"===a.type||a.tags&&-1!==a.tags.indexOf("a")),d=c?"_getAllRangeNodes":"_getRangeNodes",e=[];return 0<
(e=this.app.editor.isAllSelected()?this.app.editor.getLayout().children().getAll():b.selection&&b.range?this[d](b.range):e).length?this._filterNodes(e,b.range,c,a):e},getCurrent:function(){var a=this._getSelection();return this._getCurrent(a)},getParent:function(){var a=this.getCurrent();return this._getParent(a)},getElement:function(a){return this._getElement(a,"element")},getInline:function(a){return this._getElement(a,"inline")},getTopInline:function(a){a=a?this.dom(a).get():this.getCurrent();
for(var b=[];a&&this._getElement(a,"inline");)b.push(a),a=a.parentNode;return b[b.length-1]},getDataBlock:function(a){var b=this._getSelection();if(a=a||this._getCurrent(b))for(a=this.dom(a).get();a;){if(1===a.nodeType&&a.getAttribute("data-"+this.prefix+"-type"))return this.dom(a);a=a.parentNode}return this.dom()},getBlock:function(a){return this._getElement(a,"block")},getText:function(a,b){var c=this.get(),d=!1;if(!c.selection)return!1;if(a&&c.range){b=void 0===b?1:b;var e=this.app.editor.getLayout().get(),
f=c.range.cloneRange();"before"===a?(f.collapse(!0),f.setStart(e,0),d=f.toString().slice(-b)):"after"===a&&(f.selectNodeContents(e),f.setStart(c.range.endContainer,c.range.endOffset),d=f.toString().slice(0,b))}else d=c.selection?c.selection.toString():"";return d},getHtml:function(){var a="",b=this.get();b.selection&&(a=b.range.cloneContents(),b=document.createElement("div"),b.appendChild(a),a=(a=b.innerHTML).replace(/<p><\/p>$/i,""));return a},getPosition:function(){var a=this.getRange(),b={top:0,
left:0,width:0,height:0};this.app.editor.getWinNode().getSelection&&a.getBoundingClientRect&&(b=(a=a.cloneRange()).startOffset-1,a.setStart(a.startContainer,0>b?0:b),a=a.getBoundingClientRect(),b={top:a.top,bottom:a.bottom,left:a.left,width:a.right-a.left,height:a.bottom-a.top});return b},set:function(a,b){a&&(a.removeAllRanges(),a.addRange(b))},setRange:function(a){this.set(this.app.editor.getWinNode().getSelection(),a)},is:function(a){if(void 0===a)return this.get().selection;a=this.dom(a).get();
for(var b=this.getNodes(),c=0;c<b.length;c++)if(b[c]===a)return!0;return!1},isCollapsed:function(){var a=this.get();return this._getCollapsed(a.selection,a.range)},isIn:function(a){a=this.dom(a).get();var b=this.getCurrent();return!(!b||!a)&&a.contains(b)},isAll:function(a){var b=!a;a=a?this.dom(a).get():this.app.editor.getLayout().get();var c=this.app.editor.getWinNode().getSelection(),d=this._getRange(c);b=b||this.is(a);return!c.isCollapsed&&!!b&&void 0!==a.textContent&&a.textContent.trim().length===
d.toString().trim().length},select:function(a){a=a?this.dom(a).get():this.app.editor.getLayout().get();var b=this.app.editor.getDocNode().createRange();b.selectNodeContents(a);this.setRange(b)},removeAllRanges:function(){var a=this._getSelection();a&&a.removeAllRanges()},deleteContents:function(){var a=this.getRange();!this.isCollapsed()&&a&&a.deleteContents()},collapse:function(a){a=a||"start";var b=this.get();b.selection&&!b.collapsed&&("start"===a?b.selection.collapseToStart():b.selection.collapseToEnd())},
save:function(a){a||(a=(a=this.app.block.get())?a.getBlock():this.app.editor.getLayout());this.savedSelection={el:a,offset:this.app.offset.get(a)}},restore:function(a){if(!this.savedMarker&&this.savedSelection){this.app.editor.setWinFocus();var b=this.savedSelection.el;this.dom(b).dataget("instance")&&!1!==a&&this.app.block.set(b);b&&(b.focus(),this.app.offset.set(b,this.savedSelection.offset));this.savedSelection=!1}},saveMarker:function(){this.savedMarker=!0;this.app.marker.insert()},restoreMarker:function(){this.app.marker.restore();
this.savedSelection=this.savedMarker=!1},_getSelection:function(){return this.app.editor.getSelection()},_getRange:function(a){return!!a&&0<a.rangeCount&&a.getRangeAt(0)},_getCurrent:function(a){return!!a&&a.anchorNode},_getParent:function(a){return!!a&&a.parentNode},_getElement:function(a,b){var c=this._getSelection();if(c)for(a=a||this._getCurrent(c),a=this.dom(a).get();a;){if(this.app.element.is(a,b))return a;a=a.parentNode}return!1},_getCollapsed:function(a,b){var c=!1;return a&&a.isCollapsed?
c=!0:b&&0===b.toString().length&&(c=!0),c},_getNextNode:function(a){if(a.firstChild)return a.firstChild;for(;a;){if(a.nextSibling)return a.nextSibling;a=a.parentNode}},_getRangeNodes:function(a,b){var c=a.startContainer.childNodes[a.startOffset]||a.startContainer,d=a.endContainer.childNodes[a.endOffset]||a.endContainer;a=a.commonAncestorContainer;var e=[];if(b){this.app.editor.isLayout(c)||e.push(c);for(b=c.parentNode;b&&!this.app.editor.isLayout(b)&&(e.push(b),b!==a);b=b.parentNode);e.reverse();
for(b=c;b&&(3===b.nodeType||0!==this.dom(b.parentNode).closest(a).length)&&(e.push(b),b!==d);b=this._getNextNode(b));}else for(3===c.nodeType&&e.push(this.getBlock(c)),b=c;b&&b!==a&&(3===b.nodeType||0!==this.dom(b.parentNode).closest(a).length)&&(e.push(b),b!==d);b=this._getNextNode(b));return e},_getAllRangeNodes:function(a){return this._getRangeNodes(a,!0)},_filterNodes:function(a,b,c,d){var e=this.getText();e=e?e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"):"";for(var f=[],g=0;g<a.length;g++){var l=
!0;this.app.editor.isLayout(a[g])&&(l=!1);d&&(l=d.types?this._filterByTypes(l,d,a[g]):l,l=d.selected?this._filterBySelected(l,d,a[g],b,e):l,l=d.type?this._filterByType(l,d,a[g],c):l,l=d.tags?this._filterByTags(l,d,a[g]):l);l&&f.push(a[g])}a=[];if(d&&("blocks"===d.type||"blocks-first"===d.type)){for(b=0;b<f.length;b++){var m;"blocks-first"===d.type?m=this.app.element.is(f[b],"blocks-first")?f[b]:this.app.element.getFirstLevel(f[b]).get():"blocks"===d.type&&(m=this.app.element.is(f[b],"blocks")?f[b]:
this.app.element.getDataBlock(f[b]).get());this._isInNodesArray(a,m)||a.push(m)}f=a}return f},_filterByTypes:function(a,b,c){var d;return!0===b.types?this.app.element.getType(c)||(a=!1):(d=this.app.element.getType(c),-1===b.types.indexOf(d)&&(a=!1)),a},_filterByType:function(a,b,c,d){var e=b.type;return"blocks"!==e&&"blocks-first"!==e||(e="block"),d?b.links?this.app.element.is(c,e)||(a=!1):(1!==c.nodeType||"A"!==c.tagName)&&this.app.element.is(c,e)||(a=!1):this.app.element.is(c,e)||(a=!1),a},_filterByTags:function(a,
b,c){var d=void 0!==c.tagName;return d?d&&-1===b.tags.indexOf(c.tagName.toLowerCase())&&(a=!1):a=!1,a},_filterBySelected:function(a,b,c,d,e){return!0!==b.selected||this._containsNodeText(d,c)?"inside"===b.selected&&(1===c.nodeType&&"A"===c.tagName?a=!0:this._isTextSelected(c,e)||(a=!1)):a=!1,a},_isTextSelected:function(a,b){a=9!==a.nodeType?this.app.utils.removeInvisibleChars(a.textContent):"";return b===a||-1!==a.search(b)||-1!==b.search(new RegExp("^"+this.app.utils.escapeRegExp(a)+"$"))},_isBackwards:function(){var a=
!1,b=this.get();if(b&&!b.collapsed){var c=this.app.editor.getDocNode().createRange();c.setStart(b.selection.anchorNode,b.selection.anchorOffset);c.setEnd(b.selection.focusNode,b.selection.focusOffset);a=c.collapsed;c.detach()}return a},_containsNodeText:function(a,b){for(var c,d,e,f=this.app.editor.getDocNode().createTreeWalker(b,NodeFilter.SHOW_TEXT,{acceptNode:function(g){return NodeFilter.FILTER_ACCEPT}},!1);e=f.nextNode();)c=c||e,d=e;e=a.cloneRange();return c?(e.setStart(c,0),e.setEnd(d,d.length)):
e.selectNodeContents(b),1>a.compareBoundaryPoints(Range.START_TO_START,e)&&-1<a.compareBoundaryPoints(Range.END_TO_END,e)},_isInNodesArray:function(a,b){return-1!==a.indexOf(b)}});h.add("module","inline",{removeFormat:function(){this.app.popup.close();var a=this.app.block.get().getBlock();this.app.selection.save(a);a=this.app.selection.getNodes({type:"inline"});for(var b=0;b<a.length;b++){var c=this.dom(a[b]);c.attr("data-"+this.prefix+"-type")||c.unwrap()}this.app.selection.restore();this.app.editor.observeUI()},
set:function(a){this.app.popup.isOpen()&&this.app.popup.close();this.params=a;a=[];return a=this.app.selection.get().collapsed?this.formatCollapsed():this.formatUncollapsed(),this.app.editor.observeUI(),this.app.broadcast("inline.format",{nodes:a}),this.app.sync.trigger(),a},formatCollapsed:function(){var a=this.app.selection.getInline(),b=this.dom(a),c=this._getParamsTags(),d=this._isSameTag(a,c);c=!(!this.params||!this.params.caret)&&this.params.caret;if(a)if(this.app.content.isEmptyHtml(a.innerHTML))d?
(this.app.caret.set(a,c||"after"),b.remove()):(a=this.app.element.replaceToTag(a,this.params.tag),this.app.caret.set(a,c||"start"));else if(d){d=a;if(this.app.caret.is(a,"end"))c="after";else{d=this.app.content.extractHtmlFromCaret(a);var e=this.dom("<"+this.params.tag+" />");e=this.app.element.cloneAttrs(a,e);b.after(e.append(d));d=e}this.app.caret.set(d,c||"before")}else var f=this._insertInline(this.params.tag,c);else f=this._insertInline(this.params.tag,c);if(f&&this.params&&void 0!==this.params.attr){var g=
this.dom(f);Object.keys(this.params.attr).forEach(function(l){g.attr(l,this.params.attr[l])}.bind(this))}return f||[]},formatUncollapsed:function(){var a=this.app.block.get(),b=this._getBlock(a);this.app.selection.save();this._convertTags("u",a);this._convertTags("del",a);this.app.selection.restore();var c=this.app.selection.getNodes({type:"inline"});this.app.selection.save();this._convertToStrike(c);this.app.selection.restore();this.app.selection.save();this.app.editor.getDocNode().execCommand("strikethrough");
var d=this._revertToInlines(a);this.app.selection.restore();c=[];for(var e=this.app.selection.getText(),f=0;f<d.length;f++)this._isInSelection(d[f],e)&&c.push(d[f]);if(this._clearEmptyStyle(),this.params&&void 0!==this.params.attr)for(d=0;d<c.length;d++)this._applyAttrs(c[d]);(1===b.length&&b.get().normalize(),this.app.selection.save(),this._revertTags("u",a),this._revertTags("del",a),this.app.selection.restore(),this.params&&this.params.caret)&&this.app.caret.set(c[c.length-1],this.params.caret);
return c},_applyAttrs:function(a){Object.keys(this.params.attr).forEach(function(b){a.setAttribute(b,this.params.attr[b])}.bind(this))},_clearEmptyStyle:function(){for(var a=this.app.selection.getNodes({type:"inline"}),b=0;b<a.length;b++){this._clearEmptyStyleAttr(a[b]);var c=a[b].childNodes;if(c)for(var d=0;d<c.length;d++)this._clearEmptyStyleAttr(c[d])}},_clearEmptyStyleAttr:function(a){3!==a.nodeType&&""===a.getAttribute("style")&&a.removeAttribute("style")},_isSameTag:function(a,b){return a&&
-1!==b.indexOf(a.tagName.toLowerCase())},_isInSelection:function(a,b){a=this.app.utils.removeInvisibleChars(a.textContent);return-1!==b.search(new RegExp(this.app.utils.escapeRegExp(a)))},_insertInline:function(a,b){return this.app.insertion.insertNode(document.createElement(a),b||"start")},_convertTags:function(a,b){this.params.tag!==a&&this._getBlock(b).find(a).each(function(c){this.app.element.replaceToTag(c,"span").addClass(this.prefix+"-convertable-"+a)}.bind(this))},_revertTags:function(a,b){this._getBlock(b).find("span."+
this.prefix+"-convertable-"+a).each(function(c){c=this.app.element.replaceToTag(c,a);c.removeClass(this.prefix+"-convertable-"+a);this.app.element.removeEmptyAttrs(c,["class"])&&c.removeAttr("class")}.bind(this))},_convertToStrike:function(a){for(var b=this._getParamsTags(),c=0;c<a.length;c++){var d=this.dom(a[c]),e=a[c].tagName.toLowerCase();-1!==b.indexOf(e)&&this._replaceToStrike(d)}},_getParamsTags:function(){var a=[this.params.tag];return"b"===this.params.tag||"strong"===this.params.tag?a=["b",
"strong"]:"i"!==this.params.tag&&"em"!==this.params.tag||(a=["i","em"]),a},_replaceToStrike:function(a){a.replaceWith(function(){return this.dom("<strike>").append(a.html())}.bind(this))},_revertToInlines:function(a){var b=[];return this._getBlock(a).find("strike").each(function(c){c=this.app.element.replaceToTag(c,this.params.tag);b.push(c.get())}.bind(this)),b},_getBlock:function(a){return this.app.editor.isBlocksSelection()?this.dom(this.app.blocks.getSelectedBlocks()):a.getBlock()}});h.add("module",
"popup",{init:function(){this.stack=!1;this.stacks=[];this.supername=this.name=!1;this.autoclose=!0;this.saved=this.control=!1},start:function(){this._build();this._buildDepth()},stop:function(){this._stopEvents();this._stop()},stopStack:function(){this._stopEvents();this.app.toolbar.unsetToggled();this.$popup.removeAttr("data-"+this.prefix+"-popup-name");this.$popup.removeClass("open")},isOpen:function(a){var b=this.$popup.hasClass("open");return a?this._getName()===a&&b:b},create:function(a,b){return this.isOpen(a)||
(this._reset(),this.name=a,this.supername=a,this.stack=this._createStack(a,b)),this.stack},add:function(a,b){return this._createStack(a,b,!0)},setStack:function(a){this.stack=a;this.name=a.getName()},setData:function(a){this.stack.setData(a)},setFocus:function(a){this.stack.setFocus(a)},setWidth:function(a){this.stack.setWidth(a)},getName:function(){return this.name},getElement:function(){return this.$popup},getButton:function(){return this.button},getStack:function(a){return a?this.stacks[a]:this.stack},
getBody:function(){return this.stack.getBody()},getItems:function(){return this.stack.getItems()},getFooter:function(){return this.stack.getFooter()},getFooterPrimary:function(){return this.stack.getFooterPrimary()},getTool:function(a){return this.stack.getTool(a)},getInput:function(a){return this.stack.getInput(a)},getFormItem:function(a){return this.stack.getFormItem(a)},getData:function(a){return this.stack.getData(a)},open:function(a){this.isOpen()?this.isOpen(this.supername)?(this.saved=!0,this.close(!1)):
(this.saved=!0,this.close(!1),this._open(a,!1)):(this.saved=!1,this._open(a))},openStack:function(a){a=this.getStack(a);var b={};this.stack&&this.stack.isCollapsed()&&(b={collapse:!0},this.removeStack(this.stack));a.open(b)},close:function(a,b){(!1!==this.autoclose||!0===a||b)&&this.isOpen()&&(a&&this._isPopupTarget(a)||(this._stopEvents(),this._resetToolbarToggledButton(),!1!==a&&!1===this.saved&&(this.app.scroll.save(),this.app.selection.restore(),this.app.scroll.restore()),this.$popup.hide(),this._closed()))},
closeStacks:function(){for(var a in this.stacks)"object"==typeof this.stacks[a]&&this.stacks[a].close()},removeStack:function(a){a=a.getName();delete this.stacks[a];this.$popup.find("[data-"+this.prefix+"-stack-name="+a+"]").remove()},updatePosition:function(a){this._buildPosition(a);this._buildHeight()},resize:function(){var a=this.$popup.attr("data-width"),b=this.app.editor.getWidth();"100%"!==a&&parseInt(a)<b||this.$popup.css("width",b+"px")},_build:function(){this.$popup=this.dom("<div>").addClass(this.prefix+
"-popup "+this.prefix+"-popup-"+this.uuid);this.$popup.hide();this.$popup.attr("dir",this.opts.editor.direction);this.app.$body.append(this.$popup)},_buildDepth:function(){this.opts.bsmodal&&this.$popup.css("z-index",1061)},_buildButton:function(a){a&&(this.button=!!Object.prototype.hasOwnProperty.call(a,"button")&&a.button)},_buildControl:function(a){a&&(this.control=!!Object.prototype.hasOwnProperty.call(a,"control")&&a.control)},_buildName:function(){this.$popup.attr("data-"+this.prefix+"-popup-name",
this.name);this.$popup.addClass(this.prefix+"-popup-"+this.name)},_buildHeader:function(){this.header=this.app.create("popup.header",this)},_buildHeight:function(){var a,b=this.app.scroll.getTarget(),c=this.$popup.offset();b=(this.app.scroll.isTarget()?(a=c.top-b.offset().top,b.height()-parseInt(b.css("border-bottom-width"))):(a=c.top-b.scrollTop(),b.height()))-a-10;this.$popup.css("max-height",b+"px")},_buildPosition:function(){var a=this._isButton()&&this.button.isControl()||this._isControl()?this._buildPositionControl():
this._isButton()?this._buildPositionButton():this._buildPositionModal();this.$popup.css({top:a.top-1+"px",left:a.left+"px"})},_buildPositionButton:function(){var a=this.app.editor.getRect(),b=this.button.getOffset(),c=this.button.getDimension(),d=this.$popup.width(),e={};return this._isToolbarButton()||this._isTopbarButton()?(e={top:b.top+c.height,left:b.left}).left+d>a.right&&(e.left=b.left+c.width-d):(e={top:b.top+a.top+c.height,left:b.left+a.left+c.width/2-d/2}).left+d>a.right&&(e.left=a.left+
a.width-d),(e.left<a.left||0>e.left)&&(e.left=a.left),e},_buildPositionControl:function(){var a=this.app.block.get();a.isSecondLevel()&&(a=a.getFirstLevel());a=a.getBlock().offset();return{top:a.top,left:a.left}},_buildPositionModal:function(){if(this.opts.toolbar){var a=this.app.container.get("toolbar");var b=a.height();b=(a=a.offset()).top+b}else a=this.app.block.get(),a.isSecondLevel()&&(a=a.getFirstLevel()),b=(a=a.getBlock().offset()).top;return{top:b,left:a.left}},_getName:function(){return this.$popup.attr("data-"+
this.prefix+"-popup-name")},_setToolbarToggledButton:function(){if(this.app.toolbar.unsetToggled(),this._isToolbarButton()){var a=this.button.getName();this.app.toolbar.setToggled(a)}},_createStack:function(a,b,c){Object.prototype.hasOwnProperty.call(b,"collapse")&&!1===b.collapse&&(c=!1);Object.prototype.hasOwnProperty.call(b,"autoclose")&&(this.autoclose=b.autoclose);b=this.app.create("popup.stack",a,b,c,this);return this.stacks[a]=b},_open:function(a,b){this._buildButton(a);this._buildControl(a);
this._buildName();this._buildHeader();this.app.broadcast("popup.before.open").isStopped()?this.stopStack():(this._setToolbarToggledButton(),this._startEvents(),!1!==b&&this.app.editor.isPopupSelection()&&this.app.selection.save(),this.stack=this._findActiveStack(),this.stack.open(a,!1,!1),this._buildPosition(),!1===b?(this.$popup.show(),this._opened()):this.$popup.fadeIn(100,this._opened.bind(this)))},_opened:function(){this._buildHeight();this.$popup.addClass("open");this.app.broadcast("popup.open");
this.stack.renderFocus()},_closed:function(){var a="data-"+this.prefix+"-popup-name",b=this.$popup.attr(a);this.$popup.removeAttr(a);this.$popup.removeClass("open "+this.prefix+"-popup-"+b);this.saved=!1;this.app.broadcast("popup.close")},_isPopupTarget:function(a){return 0!==this.dom(a.target).closest("."+this.prefix+"-popup").length},_isButton:function(){return this.button},_isControl:function(){return this.control},_isToolbarButton:function(){return this.button&&("toolbar"===this.button.type||
"context"===this.button.type)},_isTopbarButton:function(){return this.button&&"topbar"===this.button.type},_findActiveStack:function(){for(var a in this.stacks)"object"==typeof this.stacks[a]&&this.stacks[a].isActive()&&(this.stack=this.stacks[a]);return this.stack},_reset:function(){this.control=this.button=!1;this.autoclose=!0;this.stack=!1;this.stacks=[];this.$popup.html("");this.$popup.removeClass("has-footer has-items has-form")},_resetToolbarToggledButton:function(){if(this.button){var a=this.button.getName();
this.app.toolbar.unsetToggled(a)}},_startEvents:function(){var a=this.prefix+"-popup";this.app.scroll.getTarget().on("resize."+a+" scroll."+a,this.updatePosition.bind(this))},_stopEvents:function(){this.app.scroll.getTarget().off("."+this.prefix+"-popup")},_stop:function(){this.$popup&&this.$popup.remove()}});h.add("class","popup.item",{defaults:{container:!1,title:!1,html:!1,toggle:!0,active:!1,divider:!1,remover:!1,classname:!1,params:!1,instance:!1,observer:!1,command:!1},init:function(a,b,c){this.popup=
a;this.name=b;this.params=this._buildParams(c);this._build();this._buildContainer();this._buildIcon();this._buildTitle();this._buildImage();this._buildShortcut();this._buildActive();this._buildHidden();this._buildDivider();this._buildCommand();this._buildRemover()},getPopup:function(){return this.popup},getName:function(){return this.name},getParams:function(){return this.params.params},getElement:function(){return this.$item},getInstance:function(){return this.params.instance},isControl:function(){return this.params.control},
_build:function(){this.$item=this.params.html?this.dom(this.params.html):this.dom("<div>");this.$item.addClass(this.prefix+"-popup-item "+this.prefix+"-popup-stack-item");this.$item.attr({"data-name":this.name})},_buildContainer:function(){this.params.container&&this.$item.addClass(this.prefix+"-popup-item-container")},_buildTitle:function(){this.params.title&&(this.$title=this.dom("<span>").addClass(this.prefix+"-popup-item-title"),this.$title.html(this.lang.parse(this.params.title)),this.$item.append(this.$title))},
_buildImage:function(){this.params.image&&(this.$image=this.dom("<span>").addClass(this.prefix+"-popup-item-image"),this.$image.html(this.params.image),this.$item.append(this.$image))},_buildIcon:function(){this.params.icon&&(this.$icon=this.dom("<span>").addClass(this.prefix+"-popup-item-icon"),this.opts.buttons.icons&&void 0!==this.opts.buttons.icons[this.name]?this.$icon.html(this.opts.buttons.icons[this.name]):!0===this.params.icon?this.$icon.addClass(this.prefix+"-icon-"+this.name):-1!==this.params.icon.search(/</)?
this.$icon.html(this.params.icon):this.$icon.addClass(this.prefix+"-icon-"+this.params.icon),this.$item.append(this.$icon))},_buildShortcut:function(){if(this.params.shortcut){var a=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)?"<b>&#8984;</b>":"ctrl";a=this.params.shortcut.replace("Ctrl",a);this.$shortcut=this.dom("<span>").addClass(this.prefix+"-popup-item-shortcut");this.$shortcut.html(a);this.$item.append(this.$shortcut)}},_buildParams:function(a){return p.extend({},!0,this.defaults,a)},
_buildActive:function(){this.params.active&&this.$item.addClass("active")},_buildHidden:function(){this.params.hidden&&this.$item.addClass(this.prefix+"-popup-item-hidden")},_buildDivider:function(){this.params.divider&&this.$item.addClass(this.prefix+"-popup-item-divider-"+this.params.divider)},_buildCommand:function(){this.params.command&&(this.$item.on("click."+this.prefix+"-popup-item-"+this.uuid,this._catch.bind(this)),this.$item.attr("data-command",this.params.command))},_buildRemover:function(){if(this.params.title&&
this.params.remover){var a=this.dom("<span>").addClass(this.prefix+"-popup-item-trash "+this.prefix+"-icon-trash");a.attr("data-command",this.params.remover);a.on("click."+this.prefix+"-popup-item-"+this.uuid,this._catchRemover.bind(this));this.$item.append(a)}},_catchRemover:function(a){a.preventDefault();a.stopPropagation();var b=this.dom(a.target).closest("."+this.prefix+"-popup-stack-item");a=this.dom(a.target).closest("."+this.prefix+"-popup-item-trash").attr("data-command");var c=b.attr("data-name");
this.app.api(a,this,c);b.fadeOut(200,function(d){d.remove()})},_catch:function(a){a.preventDefault();a.stopPropagation();var b=this.dom(a.target).closest("."+this.prefix+"-popup-stack-item"),c=b.attr("data-name"),d=b.attr("data-command");this.popup.$items.find("."+this.prefix+"-popup-stack-item").removeClass("active");this.params.toggle&&b.addClass("active");this.app.api(d,this.getParams(),this,c,a)}});h.add("class","popup.stack",{defaults:{active:!1,title:!1,type:!1,width:!1,setter:!1,getter:!1,
builder:!1,observer:!1,instance:!1,collapse:!1,form:!1,items:!1,focus:!1,footer:!1},init:function(a,b,c,d){this.defaultWidth="240px";this.popup=d;this.name=a;this.tools={};this.formitems=this.items=this.data=!1;this.params=p.extend({},!0,this.defaults,b);c&&(this.params.collapse=!0);this._build();this._observe()},set:function(a,b){this.params[a]=b},setData:function(a){this.data=a},setFocus:function(a){void 0!==this.tools[a]&&this.tools[a].setFocus()},setWidth:function(a){var b=this.app.popup.getElement();
b.attr("data-width",a);"100%"===a&&(a=this.app.editor.getWidth()+"px");b.css("width",a);this.app.$win.on("resize."+this.prefix+"-popup-"+this.uuid,this.popup.resize.bind(this.popup));this.popup.resize()},setItemsData:function(a){this.items=a},get:function(a){return this.params[a]},getElement:function(){return this.$stack},getName:function(){return this.name},getBody:function(){return this.$body},getInstance:function(){return this.get("instance")},getItemsData:function(){return this.items},getItems:function(){return this.$items},
getFooter:function(){return this.$footer},getFooterPrimary:function(){return this.$footer.find("."+this.prefix+"-form-button-primary")},getTool:function(a){return void 0!==this.tools[a]&&this.tools[a]},getInput:function(a){return(a=this.getTool(a))?a.getInput():this.dom()},getFormItem:function(a){return(a=this.getTool(a))?a.getInput().closest("."+this.prefix+"-form-item"):this.dom()},getData:function(a){var b;return a?void 0!==this.tools[a]&&(b=this.tools[a].getValue()):(b={},Object.keys(this.tools).forEach(function(c){b[c]=
this.tools[c].getValue()}.bind(this))),b},hasForm:function(){return this.formitems},hasFooter:function(){return 0!==this.footerbuttons},hasItems:function(){return!1!==this.items},isCollapsed:function(){return this.get("collapse")},isActive:function(){return this.get("active")},open:function(a,b,c){if((a&&a.focus&&this.set("focus",a.focus),this.popup.closeStacks(),this.app.popup.setStack(this),!1!==c)&&this.app.broadcast("popup.before.open").isStopped())return void this.popup.stopStack();a&&a.collapse?
(this._buildItems(),this._renderItems()):this.render();this.popup.header.render(this.popup.stacks);this.popup.header.setActive(this);this.$stack.show();this._renderWidth();!1!==b&&this.renderFocus();!1!==c&&this.app.broadcast("popup.open")},close:function(){this.$stack.hide()},collapse:function(){var a=this._getPrev();this.isCollapsed()&&this.popup.removeStack(this);a.open({collapse:!0})},render:function(){this._renderType();this._renderItems();this._renderForm();this._renderFooter();this._renderEnv()},
renderFocus:function(){this.get("focus")&&this.setFocus(this.get("focus"))},_observe:function(){this.params.observer&&this.app.api(this.params.observer,this)},_getPrev:function(){var a;for(a in this.popup.stacks)if(this.popup.stacks.hasOwnProperty(a)){if(a===this.name)return b;var b=this.popup.stacks[a]}},_build:function(){this._buildElement();this._buildBody();this._buildFooter();this._buildParams()},_buildElement:function(){this.$stack=this.dom("<div>").addClass(this.prefix+"-popup-stack "+this.prefix+
"-popup-stack-"+this.name);this.$stack.hide();this.$stack.attr("data-"+this.prefix+"-stack-name",this.name);this.popup.getElement().append(this.$stack)},_buildBody:function(){this.$body=this.dom("<div>").addClass(this.prefix+"-popup-body");this.$stack.append(this.$body)},_buildFooter:function(){this.$footer=this.dom("<div>").addClass(this.prefix+"-popup-footer");this.$stack.append(this.$footer)},_buildParams:function(){this.params.width=this.params.width?this.params.width:this.defaultWidth;this.params.setter=
!!this.params.setter&&this.params.setter;this.params.getter=!!this.params.getter&&this.params.getter;this.data=!!this.params.getter&&this.app.api(this.params.getter,this);this._buildItems()},_buildItems:function(){this.params.builder?this.items=this.app.api(this.params.builder,this):this.params.items&&(this.items=this.params.items)},_renderWidth:function(){this.setWidth(this.get("width"))},_renderType:function(){this.$stack.removeClass(this.prefix+"-popup-type-grid");var a=this.get("type");a&&this.$stack.addClass(this.prefix+
"-popup-type-"+a)},_renderItems:function(){if(this.items)for(var a in this.$items?this.$items.html(""):(this.$items=this.dom("<div>").addClass(this.prefix+"-popup-items"),this.$body.append(this.$items)),this.items)if(this.items.hasOwnProperty(a)){if(Object.prototype.hasOwnProperty.call(this.items[a],"observer")&&this.items[a].observer){var b=this.app.api(this.items[a].observer,this.items[a],a,this);void 0!==b&&(this.items[a]=b)}!1!==this.items[a]&&(b=this.app.create("popup.item",this,a,this.items[a]).getElement(),
this._renderItemPosition(this.$items,b,this.items[a]))}},_renderItemPosition:function(a,b,c){if(c.position){var d=c.position;"first"===d?a.prepend(b):"object"==typeof d&&(c=Object.prototype.hasOwnProperty.call(d,"after")?"after":"before",(d=this._findPositionElement(d[c],a))?d[c](b):a.append(b))}else a.append(b)},_renderEnv:function(){var a=this.popup.getElement();a.removeClass("has-footer has-items has-form");this.hasForm()&&a.addClass("has-form");this.hasFooter()&&a.addClass("has-footer");this.hasItems()&&
a.addClass("has-items")},_renderForm:function(){(this.formitems=this.get("form"))&&(this.$form?this.$form.html(""):(this.$form=this.dom("<form>").addClass(this.prefix+"-popup-form"),this.$body.append(this.$form)),this._renderTools(),this._renderData(),this.$form.find("input[type=text],input[type=url],input[type=email]").on("keydown."+this.prefix+"-popup",function(a){if(13===a.which)return a.preventDefault(),this.app.popup.close(),!1}.bind(this)))},_renderTools:function(){Object.keys(this.formitems).forEach(function(a){this._renderTool(a,
this.formitems[a])}.bind(this))},_renderTool:function(a,b){b=this.app.create("tool."+b.type,a,b,this,this.data);var c=b.getElement();c&&(this.tools[a]=b,this.$form.append(c))},_renderData:function(){if(this.data)for(var a in this.data)void 0!==this.tools[a]&&this.tools[a].setValue(this.data[a])},_renderFooter:function(){this.footerbuttons=0;var a=this.get("footer");if(a)for(var b in this.$footer.html(""),a)if(a.hasOwnProperty(b)&&!1!==a[b]){var c=this.app.create("popup.button",b,this,a[b]);this.$footer.append(c.getElement());
this.footerbuttons++}},_findPositionElement:function(a,b){var c;if(Array.isArray(a))for(var d=0;d<a.length&&0===(c=b.find("[data-name="+a[d]+"]")).length;d++);else c=b.find("[data-name="+a+"]");return 0!==c.length?c:0}});h.add("class","popup.button",{init:function(a,b,c){this.name=a;this.obj=c;this.popup=b;this.$button=this.dom("<button>").addClass(this.prefix+"-form-button");this.$button.attr("data-name",this.name);this.$button.html(this.lang.parse(this.obj.title));this.$button.dataset("instance",
this);this._has("type")&&this.$button.addClass(this.prefix+"-form-button-"+this.obj.type);this._has("classname")&&this.$button.addClass(this.obj.classname);this._has("fullwidth")&&this.$button.addClass(this.prefix+"-form-button-fullwidth");this._has("right")&&this.$button.addClass(this.prefix+"-form-button-push-right");this.$button.on("click."+this.prefix+"-popup-button"+this.uuid,this._catch.bind(this))},getName:function(){return this.name},getElement:function(){return this.$button},invokeCommand:function(){this._invoke()},
_has:function(a){return Object.prototype.hasOwnProperty.call(this.obj,a)},_catch:function(a){a.preventDefault();a.stopPropagation();this._has("command")?this._invoke(a):this._has("close")&&this.app.popup.close()},_invoke:function(a){this.app.api(this.obj.command,this.popup,this.name,a)}});h.add("class","popup.header",{init:function(a){this.popup=a;this._build()},setActive:function(a){this.$headerbox.find("."+this.prefix+"-popup-header-item").removeClass("active");this.$headerbox.find("[data-"+this.prefix+
"-name="+a.getName()+"]").addClass("active")},render:function(a){this._reset();0<this._buildItems(a)&&this._buildClose()},_build:function(){this.$header=this.dom("<div>").addClass(this.prefix+"-popup-header");this.$headerbox=this.dom("<div>").addClass(this.prefix+"-popup-header-box");this.$header.append(this.$headerbox);this.popup.getElement().prepend(this.$header)},_buildClose:function(){var a=this.dom("<span>").addClass(this.prefix+"-popup-close");a.one("click",this._catchClose.bind(this));this.$header.append(a)},
_buildItems:function(a){var b=Object.keys(a).length,c=0,d=0,e;for(e in a)if(a.hasOwnProperty(e)&&"object"==typeof a[e]){d++;var f=a[e].get("title");f?(c++,this._buildItem(a[e],f,b)):1===d&&1<b&&(c++,this._buildItem(a[e],"## popup.back ##",b))}return c},_buildItem:function(a,b,c){var d=(c=1<c)?this.dom("<a>").attr("href","#"):this.dom("<span>");c&&(d.dataset("stack",a),d.addClass(this.prefix+"-popup-header-item-link"),d.on("click",this._catchStack.bind(this)));d.attr("data-"+this.prefix+"-name",a.getName());
d.addClass(this.prefix+"-popup-header-item");d.html(this.lang.parse(b));this.$headerbox.append(d)},_reset:function(){this.$headerbox.html("");this.$header.find("."+this.prefix+"-popup-close").remove()},_catchStack:function(a){a.preventDefault();a.stopPropagation();a=this.dom(a.target).dataget("stack");var b=this.app.popup.getStack();b.isCollapsed()&&this.app.popup.removeStack(b);a.open()},_catchClose:function(a){a.preventDefault();a.stopPropagation();this.popup.close()}});h.add("module","editor",
{start:function(){this._buildEditor();this._buildBlurClass();this._buildOptions();this._buildContent()},stop:function(){this.app.$element.show()},load:function(){this._setFocusOnStart()},build:function(){this.app.blocks.build();this.app.embed.build();this.app.image.observeStates();this.app.parser.buildPredefinedClasses();this.app.broadcast("editor.build")},isEditor:function(a){return this.dom(a).get()===this.$editor.get()},isLayout:function(a){return this.isEditor(a)},isTextarea:function(){return!1===
this.opts.content},isFocus:function(){return this.app.container.isFocus()},isAllSelected:function(){return this._classSelect("has")},isEmpty:function(a){return!(1<this.app.blocks.getFirstLevel().length)&&this.app.content.isEmptyHtml(this.$editor.html(),a)},isPopupSelection:function(){return!this.app.blocks.isMeta()},isBlocksSelection:function(){return this.app.blocks.isMeta()||this.app.blocks.is()||this.app.editor.isAllSelected()},addButton:function(a,b){this.opts.buttonsObj[a]=b;this.opts.buttons.editor.push(a)},
selectAll:function(){if(!this.isAllSelected()){this._classSelect("add");this.app.block.unset();this.app.blocks.unset();this.app.toolbar.build();this.app.control.close();this.app.context.close();var a=this.app.blocks.getLast(),b=!1;a&&"layer"===a.getType()&&(b=a.getBlock()).attr("contenteditable",!0);this.app.selection.select();this.app.broadcast("editor.select");b&&setTimeout(function(){b.attr("contenteditable",!1)},0)}},unselectAll:function(){this.isAllSelected()&&(this.unsetSelectAll(),this.app.block.unset(),
this.app.blocks.unset(),this.app.broadcast("editor.unselect"))},unsetSelectAll:function(){this._classSelect("remove")},observeBlocks:function(a){this.blocks=[];var b=this.app.blocks.getSelectedBlock(a);this.app.editor.setFocus();a=this.app.blocks.getSelectedBlocks();if(1===a.length)this.app.block.set(b);else if(this.app.selection.isAll()){b=this.app.blocks.getBlocks();var c=this.app.selection.getNodes({type:"blocks-first"});b.length===c.length?this.app.editor.selectAll():this.blocksSelection(a)}else 1<
a.length?this.blocksSelection(a):this.app.block.set(b)},blocksSelection:function(a){this.app.block.unset();this.app.blocks.set(a);this.app.toolbar.build()},insertContent:function(a){this.app.insertion.insertContent(a)},setContent:function(a){this.app.insertion.setContent(a)},setEmpty:function(){this.app.insertion.setContent({html:""})},setWinFocus:function(){},setFocus:function(a){if(a){a=!0===a?"start":a;var b="start"===a?this.app.blocks.getFirst():this.app.blocks.getLast();this.app.block.set(b,
a)}else if(!this.isFocus()){for(a=0;a<p.instances.length;a++)p.instances[a]!==this.app&&p.instances[a].editor.setBlur();this.app.container.setFocus();this.app.broadcast("editor.focus")}},setBlur:function(a){this.isFocus()&&this.$editor.get&&(this.app.broadcast("editor.before.blur",{e:a}).isStopped()?a&&a.preventDefault():(this.app.container.setBlur(),this.app.selection.removeAllRanges(),this.app.source.is()||(this.app.block.unset(),this.app.blocks.unset(),this.app.popup.close(!1),this.app.context.close(),
this.app.control.close(),this.app.toolbar.build()),this.app.broadcast("editor.blur",{e:a})))},getContent:function(a){var b="";return b=this.app.source.is()?this.app.source.getContent():(b=this._getContent(),a?this.app.tidy.parse(b):b),this.app.content.decodeHref(b)},getSelection:function(){var a=this.getWinNode().getSelection();return 0<a.rangeCount?0!==this.dom(a.anchorNode).closest("."+this.prefix+"-container-"+this.uuid).length&&a:!1},getWinNode:function(){return this.app.$win.get()},getDocNode:function(){return this.app.$doc.get()},
getEditor:function(){return this.$editor},getLayout:function(){return this.getEditor()},getWidth:function(){var a=this.getEditor(),b=parseInt(a.css("padding-left")),c=parseInt(a.css("padding-right"));return a.width()-b-c},getRect:function(){var a=this.$editor.offset(),b=this.$editor.width(),c=this.$editor.height(),d=Math.round(a.top);a=Math.round(a.left);return{top:d,left:a,bottom:d+c,right:a+b,width:b,height:c}},getButtonsFromArr:function(a){var b={};if(!Array.isArray(a)&&"object"==typeof a)return a;
if(a)for(var c=p.extend(!0,{},this.opts.buttonsObj),d=0;d<a.length;d++){var e=a[d];void 0!==c[e]&&(b[e]=c[e])}return b},observeUI:function(){this.app.toolbar.observe();this.app.context.observe()},enableUI:function(){this.app.toolbar.enable();this.app.toolbar.enableSticky()},disableUI:function(){this.app.popup.close();this.app.control.close();this.app.context.close();this.app.toolbar.disable();this.app.toolbar.disableSticky()},_buildEditor:function(){this.app.$element.hide();this.$editor=this.dom("<div>");
this.$editor.addClass(this.prefix+"-editor "+this.prefix+"-reset "+this.prefix+"-"+this.opts.editor.classname);this.$editor.attr("contenteditable",!0);var a=this.opts.paddingNormal;(this.opts.control||this.opts.reorder)&&(a=this.opts.paddingControl);this.$editor.css("padding",a);this.app.container.get("editor").append(this.$editor)},_buildBlurClass:function(){this.app.container.setBlur()},_buildOptions:function(){var a=this.$editor,b=this.opts.editor;this.opts.code=this.opts.pre;a.attr("dir",b.direction);
b.minHeight&&a.css("min-height",b.minHeight);b.maxHeight&&a.css({"max-height":b.maxHeight,overflow:"auto"});b.notranslate&&a.addClass("notranslate");b.spellcheck||a.attr("spellcheck",!1);b.grammarly||a.attr("data-gramm_editor",!1)},_buildContent:function(){var a=this._getContentValue();a=this.app.broadcastHtml("editor.before.load",a);a=this.app.parser.parse(a,!0,!0);this.$editor.html(a.get().childNodes);a=this.app.parser.unparse(this.$editor.html());this.app.$element.val(a);this._load()},_buildDraggable:function(){this.app.$body.find("[data-"+
this.prefix+"-drop-id]").each(function(a){a.attr("draggable",!0);a.on("dragstart",function(b){var c=this.dom(b.target).attr("data-"+this.prefix+"-drop-id");b.dataTransfer.setData("item",c)}.bind(this))}.bind(this))},_load:function(){this.app.blocks.build();this.app.event.build();this.app.observer.build();this.app.embed.build();this.app.sync.build();this.app.image.observeStates();this._buildDraggable();this.app.broadcast("editor.load")},_getContent:function(){var a=this.$editor.html();return this.app.parser.unparse(a)},
_getContentValue:function(){return this.opts.content?this.opts.content:this.app.$element.val()},_setFocusOnStart:function(){this.opts.editor.focus&&(this.setFocus(),this.setFocus(this.opts.editor.focus))},_classSelect:function(a){return this.$editor[a+"Class"](this.prefix+"-select-all")}});h.add("module","parser",{build:function(a){return this.$layout=this.dom("<div>"),this.$layout.html(a),this.$layout.find("[data-"+this.prefix+"-type]").each(this._build.bind(this)),this.$layout},buildPredefinedClasses:function(a){if(this.opts.classes){a=
a||this.app.editor.getEditor();var b=this.app.content,c=!0,d=!1;if(void 0!==this.opts.classes.blocks&&(d=!0,void 0===this.opts.classes.tags&&(c=!1)),c&&a.find(b.getPredefinedTags().join(",")).each(b.addPredefinedTagClass.bind(this)),d)c=b.getPredefinedBlocks(),d="data-"+this.prefix+"-type",c="["+d+"="+c.join("],["+d+"=")+"]",a.find(c).each(b.addPredefinedBlockClass.bind(this))}},parse:function(a,b,c){return a=a.trim(),a=this.app.broadcastHtml("editor.before.parse",a),a=this.app.content.isEmptyHtml(a)?
this.app.block.createHtml():(a=this._clean(a,c),this._parse(a)),a=this.app.broadcastHtml("editor.parse",a),!1!==b?this.build(a):a},parseLine:function(a,b){return a=" "===a?"&nbsp;":(a=(a=this.app.broadcastHtml("editor.before.parse",a)).replace(/\r?\n/g,"<br>"),a=this.app.content.encodeCode(a),a=this.app.content.sanitize(a),a=this.app.content.removeEmptySpans(a),a=this.app.content.addHttps(a),this.app.broadcastHtml("editor.parse",a)),!1!==b?this.build(a):a},unparse:function(a,b){var c={},d=this.app.content;
return a=a.trim(),a=this.app.broadcastHtml("editor.before.unparse",a),d.isEmptyHtml(a)?"":(a=this._revertForms(a),a=this._revertFrames(a),a=d.store(a,"embed",c,0),a=d.addNofollow(a),a=d.removeMarkers(a),a=this.app.utils.removeInvisibleChars(a),a=d.recacheStyle(a),a=d.restore(a,"embed",c),a=d.removeEmptyAttrs(a,["style","class","rel","alt","title"]),a=this._unparseAllTags(a),a=this._unparseDataType(a,b),a=d.removeEmptyAttrs(a,["style","class","rel","alt","title"]),this.opts.classes&&(a=this.app.utils.wrap(a,
this.buildPredefinedClasses.bind(this))),"<p></p>"===a&&(a=""),this.app.broadcastHtml("editor.unparse",a))},_build:function(a){var b=a.attr("data-"+this.prefix+"-type");this.app.create("block."+b,a)},_clean:function(a,b){var c={},d=[],e=this.app.content;return a=(a=e.storeComments(a,d)).replace(/\u00a4t/gi,"&current"),b&&this.app.editor.isTextarea()&&(a=e.encodeCode(a)),a=e.sanitize(a),a=this._convertForms(a),a=this._convertFrames(a),a=e.store(a,"embed",c,0),a=e.removeTags(a,this.opts.tags.denied),
a=e.removeDoctype(a),a=e.removeTagsWithContent(a,["script","style"]),a=e.removeEmptySpans(a),a=e.addHttps(a),a=e.removeBlockTagsInside(a,"th td li dt dd address".split(" ")),a=e.cacheStyle(a),a=e.restore(a,"embed",c),a=e.restoreComments(a,d),this.opts.clean.comments&&(a=e.removeComments(a)),e.isEmptyHtml(a)?this.app.block.createHtml():e.paragraphize(a)},_parse:function(a){return this.app.utils.wrap(a,function(b){for(var c=this.app.element.getBlocks(b),d=0;d<c.length;d++)this._parseHtml(c[d]);this.buildPredefinedClasses(b)}.bind(this))},
_parseHtml:function(a){var b=a.tagName.toLowerCase();a=this.dom(a);var c=this._parseType(a,b);c&&(a.attr("data-"+this.prefix+"-type",c),"image"===c&&b!==this.opts.image.tag&&this.app.element.replaceToTag(a,this.opts.image.tag,!0))},_parseType:function(a,b){return a.attr("data-"+this.prefix+"-type")?a.attr("data-"+this.prefix+"-type"):this._parseTypeByTag(a,b)},_parseTypeByTag:function(a,b){switch(b){case "p":b="paragraph";this._isImageBlock(a,"p")&&(b="image");break;case "figure":b="embed";this._isImageBlock(a,
"figure")?b="image":this._hasChild(a,"pre")?b="pre":this._hasChild(a,"blockquote")&&(b="quote");break;case "div":b="layer";this._isImageBlock(a,"div")&&(b="image");break;case "h1":case "h2":case "h3":case "h4":case "h5":case "h6":b="heading";break;case "blockquote":b="quote";break;case "table":b="table";break;case "pre":b="pre";break;case "hr":b="line";break;case "dl":b="dlist";break;case "address":b="address";break;case "ul":case "ol":b="list";break;default:b="layer"}return b},_isImageBlock:function(a,
b){var c=a.find("img");if(0!==c.length&&("div"!==b||0===c.closest("figure").length)){var d=c;c=c.parent();var e=0!==c.length&&c.get().tagName;if(!e||"A"!==e&&"SPAN"!==e){if(e&&c.get()!==a.get())return}else d=c;if(0===d.prevElement().length&&("figure"===b||0===d.nextElement().length))return!0}},_hasChild:function(a,b){if("pre"===b){if(0!==a.find("pre").length)return!0}else if("blockquote"===b&&(b=a.find("blockquote"),0===a.find("script").length&&0!==b.length))return!0},_unparseAllTags:function(a){return this.app.utils.wrap(a,
function(b){b.find("*").removeAttr("contenteditable data-gramm_editor");this.opts.image.states||b.find("img").removeAttr("data-image")}.bind(this))},_unparseDataType:function(a,b){return this.app.utils.wrap(a,function(c){var d=c.find("[data-"+this.prefix+"-type]");!0!==b&&d.removeClass(this.prefix+"-block-state");d.removeAttr("tabindex data-"+this.prefix+"-parsed data-"+this.prefix+"-first-level");d.removeClass(this.prefix+"-block-focus "+this.prefix+"-block-multiple-focus "+this.prefix+"-block-multiple-hover "+
this.prefix+"-editable-pause");d.removeClass(this.prefix+"-nowrap");d.each(this._unparseByType.bind(this));d.removeAttr("data-"+this.prefix+"-type");c.find("figcaption").removeAttr("data-"+this.prefix+"-type data-placeholder").each(this.app.content._removeEmptyTag.bind(this))}.bind(this))},_unparseByType:function(a){var b=a.attr("data-"+this.prefix+"-type");"embed"===b?this._unparseEmbed(a):"list"===b&&this._unparseList(a)},_unparseEmbed:function(a){var b,c=decodeURI(a.attr("data-embed-code")),d=
a.find("."+this.opts.embed.responsive),e=a.find("figcaption");0!==e.length&&(b=e.clone(),e.remove());0===d.length?a.html(c):d.html(c);b&&a.append(b);a.removeAttr("data-embed-code")},_unparseList:function(a){this.app.content.unfixListMargin(a)},_convertFrames:function(a){return this.app.utils.wrap(a,function(b){b.find("iframe").each(this._convertFrame.bind(this))}.bind(this))},_convertFrame:function(a){0===a.closest("figure").length&&(a.wrap("<figure>"),a.parent().addClass(this.prefix+"-figure-iframe"))},
_convertForms:function(a){return this.app.utils.wrap(a,function(b){b.find("form").each(this._convertForm.bind(this))}.bind(this))},_convertForm:function(a){this.app.element.replaceToTag(a,"div").addClass(this.prefix+"-div-form")},_revertFrames:function(a){return this.app.utils.wrap(a,function(b){b.find("."+this.prefix+"-figure-iframe").each(this._revertFrame.bind(this))}.bind(this))},_revertFrame:function(a){0!==a.find("figcaption").length?a.removeClass(this.prefix+"-figure-iframe"):a.unwrap()},_revertForms:function(a){return this.app.utils.wrap(a,
function(b){b.find("."+this.prefix+"-div-form").each(this._revertForm.bind(this))}.bind(this))},_revertForm:function(a){this.app.element.replaceToTag(a,"form").removeClass(this.prefix+"-div-form")}});h.add("module","blocks",{init:function(){this.selected=[];this.focusclass=this.prefix+"-block-meta-focus"},start:function(){this.$editor=this.app.editor.getEditor()},build:function(){this._buildFirstLevel()},is:function(){return 0<this.selected.length},isMeta:function(){return 0<this.getSelected().length},
set:function(a){this.selected=a},setMeta:function(a){a=a.closest("[data-"+this.prefix+"-first-level]");this.app.block.unset();this._classFocus(a,"add");this.app.toolbar.build();setTimeout(function(){this.app.selection.removeAllRanges()}.bind(this),0)},unset:function(){this._classFocus(this.getFirstLevel(),"remove");this.selected=[]},getBlocks:function(){return this.$editor.find("[data-"+this.prefix+"-type]")},getFirstLevel:function(){return this.$editor.find("[data-"+this.prefix+"-first-level]")},
getFirst:function(){return this.getBlocks().first().dataget("instance")},getLast:function(){return this.getBlocks().last().dataget("instance")},getFirstSelected:function(){return this.getSelected().first().dataget("instance")},getLastSelected:function(){return this.getSelected().last().dataget("instance")},getSelected:function(){return this.$editor.find("."+this.focusclass)},getSelectedBlocks:function(a){var b=this.app.selection.getNodes({type:"blocks-first"});if("editable"===a){a=[];for(var c=0;c<
b.length;c++){var d=this.dom(b[c]).dataget("instance").getType();-1!==["paragraph","heading","list","address"].indexOf(d)&&a.push(b[c])}b=a}return b},getSelectedBlock:function(a){var b=this.app.selection.getDataBlock();return a&&0===b.length&&(b=this.app.element.getDataBlock(a.target)),b},getFirstSelectedBlock:function(){return 0<this.selected.length&&this.selected[0]},getLastSelectedBlock:function(){return 0<this.selected.length&&this.selected[this.selected.length-1]},removeSelected:function(a){var b,
c=this.getLastSelected();!1!==a&&c&&(b=c.getNext());this.getSelected().each(this._removeSelectedBlock.bind(this));b&&this.app.block.set(b,"start")},_buildFirstLevel:function(){var a="data-"+this.prefix+"-first-level",b=this.app.editor.getEditor();b.find("["+a+"]").removeAttr(a);b.children("[data-"+this.prefix+"-type]").attr(a,!0)},_removeSelectedBlock:function(a){a.dataget("instance").remove({traverse:!1})},_classFocus:function(a,b){return a[b+"Class"](this.focusclass)}});h.add("module","event",{init:function(){this.trigger=
!0;this.pasteEvent=this.isBlockMouseUp=this.isEditorMouseUp=this.isPopupMouseUp=this.dragoverEvent=this.imageDrag=!1;this.events={editor:"click touchstart mouseover mouseup mousedown keyup drop dragstart dragover dragleave".split(" "),doc:"keydown mousedown mouseup click paste cut copy".split(" "),win:["focus"]}},build:function(){this.$editor=this.app.editor.getEditor();this._buildPreventLinks();this._buildEvents()},run:function(){this._buildEvents()},pause:function(){this._pauseEvents()},onmouseover:function(a){this.app.broadcast("editor.mouseover",
{e:a})},ontouchstart:function(a){this.app.state.add(a)},onclick:function(a){this.app.broadcast("editor.click",{e:a});this._isEditorClick(a)&&!this.isBlockMouseUp&&this._setByClick(a);3===a.detail&&setTimeout(function(){this._setBlockFocus(a,!0)}.bind(this),0)},onmouseup:function(a){this.trigger&&(!this.isEditorMouseUp&&this._isEditorClick(a)||setTimeout(function(){this._observeBlockFocus(a);this.isEditorMouseUp=!1;this.app.broadcast("editor.mouseup",{e:a})}.bind(this),0))},onmousedown:function(a){this.app.placeholder.handleClick(a);
this._isEditorClick(a)?this.isBlockMouseUp=!1:(this.isBlockMouseUp=!0,this._setCaretInline(a),this.isEditorMouseUp=!0,this.app.state.add(a),this.app.broadcast("editor.mousedown",{e:a}))},onkeyup:function(a){if(this.app.broadcast("editor.keyup",this._buildEventKeysObj(a)).isStopped())return a.preventDefault();var b=a.which;if(b===this.app.keycodes.DOWN||b===this.app.keycodes.UP){var c=this.app.selection.getDataBlock();0===c.length||this.app.block.is(c)||this.app.block.set(c)}b===this.app.keycodes.BACKSPACE&&
this.app.editor.isEmpty()&&this.app.editor.setEmpty();b!==this.app.keycodes.TAB||this.app.block.is()||this._setBlock(a)},ondrop:function(a){if(!this.opts.editor.drop)return a.preventDefault();var b;if(this.app.broadcast("editor.drop",{e:a}).isStopped())return a.preventDefault();var c=a.dataTransfer,d=c.getData("item");""!==d?(a.preventDefault(),(b=this.opts.draggable&&void 0!==this.opts.draggable[d]?this.opts.draggable[d]:(b=this.dom("[data-"+this.prefix+"-drop-item="+d+"]").html()).trim())&&this._drop(a,
b,"after",!1)):this.opts.image&&this.opts.image.upload&&null!==c.files&&0<c.files.length?(a.preventDefault(),this.app.image.drop(a,c)):(b=""===(b=c.getData("text/html")).trim()?c.getData("Text"):b,a=this._drop(a,b),this.imageDrag&&0!==a.instances.length&&a.instances[0].change(this.imageDrag,!1));this._removeDragPlaceholder();this.imageDrag=!1;this.app.observer.trigger=!0},ondragstart:function(a){var b=this._getBlock(a.target);0!==b.length&&"image"===this.app.element.getType(b)&&(this.imageDrag=b.dataget("instance"));
this.app.broadcast("editor.dragstart",{e:a})},ondragover:function(a){if(a.preventDefault(),this.dragoverEvent=!0,this.app.observer.trigger=!1,this._removeDragPlaceholder(),-1!==a.dataTransfer.types.indexOf("item")){var b=this._getBlockFirst(a.target);if(0!==b.length){var c=this.dom("<div>").addClass(this.prefix+"-draggable-placeholder");b.after(c)}}this.app.broadcast("editor.dragover",{e:a})},ondragleave:function(a){a.preventDefault();this.dragoverEvent=!0;this.app.observer.trigger=!0;this._removeDragPlaceholder();
this.app.broadcast("editor.dragleave",{e:a})},onwinfocus:function(){var a=this.app.block.get();!a||a.isEditable()||setTimeout(function(){this.app.selection.removeAllRanges()}.bind(this),0)},ondocpaste:function(a){this._isFocusEditor()&&this._paste(a)},ondoccopy:function(a){this._isFocusEditor()&&this._copy(a)},ondoccut:function(a){this._isFocusEditor()&&this._cut(a)},ondockeydown:function(a){if(this.app.popup.isOpen()){if(this._isEnter(a)&&!1!==this.app.popup.hasForm()&&"TEXTAREA"!==a.target.tagName)return a.preventDefault(),
void this.app.popup.getFooterPrimary().dataget("instance").invokeCommand();this._isEsc(a)&&this.app.popup.close(!1)}if(!this._isOutsideEditor(a)&&this.app.editor.isFocus()&&!this.app.popup.isOpen()&&!this.app.source.is()){var b=this.app.broadcast("editor.keydown",this._buildEventKeysObj(a));if(b.isStopped())return a.preventDefault();if(!1===this.opts.editor.enterKey&&13===a.which)return void a.preventDefault();this.app.state.listen(a)||(this._isEsc(a)&&(this.app.block.unset(),this.app.selection.removeAllRanges()),
this.app.shortcut.handle(a))||this.app.input.handle(b)}},ondocmousedown:function(a){this.isPopupMouseUp=0!==this.dom(a.target).closest("."+this.prefix+"-popup-"+this.uuid).length;this.app.broadcast("editor.docmousedown",{e:a})},ondocmouseup:function(a){this.app.selection.is()&&!this.app.editor.isFocus()&&this._observeBlockFocus(a);this.app.broadcast("editor.docmouseup",{e:a})},ondocclick:function(a){if(!this.app.popup.isOpen()||!this._isEditorContainer(a))return!this._isOutsideEditor(a)||!1===this.trigger||
void(this.isEditorMouseUp?this.isEditorMouseUp=!1:(this.app.popup.isOpen()?!1===this.isPopupMouseUp&&this.app.popup.close(!1):this.app.editor.setBlur(a),this.app.broadcast("editor.docclick",{e:a})));this.app.popup.close(!1)},_buildPreventLinks:function(){var a=this.prefix+"-prevent-events";this.$editor.on("click."+a+" dblclick."+a,this._preventLinks.bind(this))},_buildEventKeysObj:function(a){var b=a.which,c=this.app.keycodes;return{e:a,key:b,ctrl:a.ctrlKey||a.metaKey,shift:a.shiftKey,alt:a.altKey,
select:(a.ctrlKey||a.metaKey)&&!a.altKey&&65===b,enter:b===c.ENTER,space:b===c.SPACE,esc:b===c.ESC,tab:!(b!==c.TAB||a.shiftKey||a.altKey||a.ctrlKey||a.metaKey),delete:b===c.DELETE,backspace:b===c.BACKSPACE,alpha:!a.ctrlKey&&!a.metaKey&&(48<=b&&57>=b||65<=b&&90>=b),arrow:-1!==[this.app.keycodes.UP,this.app.keycodes.DOWN,this.app.keycodes.LEFT,this.app.keycodes.RIGHT].indexOf(b),left:b===c.LEFT,right:b===c.RIGHT,up:b===c.UP,down:b===c.DOWN,"left-right":b===c.LEFT||b===c.RIGHT,"up-left":b===c.UP||b===
c.LEFT,"down-right":b===c.DOWN||b===c.RIGHT}},_buildEvents:function(){var a=this.prefix+"-events";this._buildTargetEvents(this.$editor,this.events.editor,a,"");this._buildTargetEvents(this.app.$doc,this.events.doc,a,"doc");this._buildTargetEvents(this.app.$win,this.events.win,a,"win")},_buildTargetEvents:function(a,b,c,d){for(var e=0;e<b.length;e++)a.on(b[e]+"."+c,this["on"+d+b[e]].bind(this))},_pauseEvents:function(){var a=this.prefix+"-events";this.$editor.off("."+a);this.app.$doc.off("."+a);this.app.$win.off("."+
a)},_preventLinks:function(a){0!==this.dom(a.target).closest("a").length&&a.preventDefault()},_isEditorClick:function(a){if(this.app.editor.isEditor(a.target))return a.preventDefault(),!0},_isEsc:function(a){return a.which===this.app.keycodes.ESC},_isEnter:function(a){return a.which===this.app.keycodes.ENTER},_isEditorContainer:function(a){return 0!==this.dom(a.target).closest("."+this.prefix+"-container-"+this.uuid).length},_isOutsideEditor:function(a){return 0===this.dom(a.target).closest("."+this.prefix+
["-container-","-popup-","-toolbar-","-control-"].join(this.uuid+",."+this.prefix)+this.uuid).length},_isFocusEditor:function(){return!this.app.popup.isOpen()&&!this.app.source.is()&&(this.app.block.is()||this.app.blocks.is()||this.app.blocks.isMeta()||this.app.editor.isAllSelected())},_removeDragPlaceholder:function(){this.app.editor.getEditor().find("."+this.prefix+"-draggable-placeholder").remove()},_getBlock:function(a){return this.dom(a).closest("[data-"+this.prefix+"-type]")},_getBlockFirst:function(a){return this.dom(a).closest("[data-"+
this.prefix+"-first-level]")},_observeBlockFocus:function(a){this.app.selection.isCollapsed()?this._setBlockFocus(a):this.app.editor.observeBlocks(a);this.app.toolbar.observe();this.app.state.add(a)},_setByClick:function(a){var b=this.app.blocks.getFirstLevel(),c=[];b.each(function(g){g=g.get().getBoundingClientRect();c.push([g.x,g.y,g.y+g.height])});var d=[],e=!1;c.forEach(function(g,l){var m=parseInt(a.clientY),r=parseInt(a.clientX);g[1]<m&&m<g[2]?e=l:d.push(parseInt(Math.hypot(g[0]-r,g[1]-m)))});
var f=!1!==e?e:d.indexOf(Math.min.apply(Math,d));b=b.eq(f);this.app.block.set(b.dataget("instance"),"start");this.app.editor.setFocus()},_setBlock:function(a){this.app.editor.setFocus();a=a?this._getBlock(a.target):this.app.selection.getDataBlock();var b=!1;0===a.length&&(a=this.app.blocks.getFirst(),b="start");this.app.block.set(a,b)},_setBlockFocus:function(a,b){a=this._getBlock(a.target);0!==a.length&&(this.app.editor.setFocus(),b&&this.app.selection.select(a),this.app.block.set(a))},_setCaretInline:function(a){var b=
this.app.block.get(),c=!1;b&&b.isEditable()&&(this.app.element.isEmptyOrImageInline(a.target)?this.app.caret.set(a.target,"after"):this.app.selection.isCollapsed()&&"CODE"===a.target.tagName&&(c=!0,setTimeout(function(){var d=this.app.selection.getElement();d&&c&&"CODE"!==d.tagName&&(this.app.caret.set(a.target,"start"),c=!1)}.bind(this),1)))},_drop:function(a,b,c,d){var e=this.app.element["after"===c?"getFirstLevel":"getDataBlock"](a.target);e=0===e.length?this.app.blocks.getFirst():e;this.app.block.set(e);
c||this.app.insertion.insertPoint(a);e=a=!0;var f=this.app.block.get(),g=this.app.editor.isAllSelected();if(f&&"pre"===f.getType()&&!g&&(e=a=!1,b=this.app.content.getTextFromHtml(b,{nl:!0,trimlines:!1})),!1===d&&(a=!1,b=this.app.autoparse.parse(b)),""!==b)return b=a?this.app.autoparse.parse(b):b,this.app.insertion.insertContent({html:b,clean:a,parse:e,position:c})},_paste:function(a){a.preventDefault();var b=a.clipboardData;if(!this.app.image.insertFromClipboard(b)){var c=b.getData("URL"),d=this.app.clipboard.getContent(b);
this.pasteEvent=!0;d=this.app.broadcast("editor.before.paste",{e:a,html:d});if(!d.isStopped()){d=d.get("html");d=c&&""!==c?c:d;var e=this.app.block.get();a=c=!0;var f=this.app.editor.isAllSelected();if(this.opts.paste.plaintext?(a=c=!1,d=this.app.content.getTextFromHtml(d,{br:!0})):e&&"pre"===e.getType()&&!f?(a=c=!1,d=this.app.content.getTextFromHtml(d,{nl:!0,trimlines:!1})):this.opts.paste.clean||(c=!1),d=this.opts.paste.links?d:this.app.content.removeTags(d,["a"]),""!==(d=this.opts.paste.images?
d:this.app.content.removeTags(d,["img"]))){if(b=b.getData("text/rtf"))e=this._findLocalImages(d),d=this._replaceLocalImages(d,e,this._extractImagesFromRtf(b));d=c?this.app.autoparse.parse(d):d;d=this.app.insertion.insertContent({html:d,clean:c,parse:a});this.opts.image.upload&&this.app.image.parseInserted(d);this.app.placeholder.toggle();this.app.broadcast("editor.paste",d)}}this.pasteEvent=!1}},_copy:function(a){this._action(a,"copy")},_cut:function(a){this._action(a,"cut")},_action:function(a,b){var c=
!1,d={},e=this.app.block.get();e&&e.isEditable()&&this.app.selection.isCollapsed()||(this.app.blocks.isMeta()&&(e=this.app.blocks.getLastSelected()),a.preventDefault(),this.app.editor.isAllSelected()?d={html:this.app.editor.getLayout().html(),remove:"all"}:this.app.blocks.is()?d={html:this.app.selection.getHtml(),remove:"content"}:e&&e.isEditable()?d=this._copyFromEditable(b,e):e&&(d=this._copyFromNonEditable(b,e)),e=this.app.broadcast("editor.before."+b,{e:a,html:d.html}),e.isStopped()||("cut"===
b&&this._cutDeleteContent(d),c=e.get("html"),c=this.app.clipboard.setContent(a,c),this.app.broadcastHtml("editor."+b,c)))},_cutDeleteContent:function(a){"instance"===a.remove?(a.instance.remove(!0),this.app.control.close()):"all"===a.remove?this.app.editor.setEmpty():!1!==a.remove&&this.app.selection.deleteContents()},_copyFromEditable:function(a,b){var c=b.getType();a=this.app.selection.getHtml();var d="content";"figcaption"===c||"cell"===c?d="content":b.isAllSelected()?(a=b.getOuterHtml(),d="instance"):
"list"===c&&(c=b.getTag(),-1!==(a=this.app.selection.getHtml()).search(/<li/gi)&&(-1===a.search(/^<li/g)&&(a="<li>"+a+"</li>"),a="<"+c+">"+a+"</"+c+">"));return{html:a,remove:d,instance:b}},_copyFromNonEditable:function(a,b){var c=b.getOuterHtml(),d=!1;return"cut"!==a||b.isSecondLevel()||(d="instance"),{html:c,remove:d,instance:b}},_findLocalImages:function(a){var b=[];return this.app.utils.wrap(a,function(c){c.find("img").each(function(d){-1!==d.attr("src").search(/^file:\/\//)&&b.push(d.attr("src"))})}),
b},_extractImagesFromRtf:function(a){if(!a)return[];var b=/{\\pict[\s\S]+?\\bliptag-?\d+(\\blipupi-?\d+)?({\\\*\\blipuid\s?[\da-fA-F]+)?[\s}]*?/;a=a.match(new RegExp("(?:("+b.source+"))([\\da-fA-F\\s]+)\\}","g"));if(!a)return[];for(var c=[],d=0;d<a.length;d++){var e=!1;-1!==a[d].indexOf("\\pngblip")?e="image/png":-1!==a[d].indexOf("\\jpegblip")&&(e="image/jpeg");e&&c.push({hex:a[d].replace(b,"").replace(/[^\da-fA-F]/g,""),type:e})}return c},_convertHexToBase64:function(a){return btoa(a.match(/\w{2}/g).map(function(b){return String.fromCharCode(parseInt(b,
16))}).join(""))},_replaceLocalImages:function(a,b,c){if(b.length===c.length)for(var d=0;d<b.length;d++){var e="data:"+c[d].type+";base64,"+this._convertHexToBase64(c[d].hex);a=a.replace(new RegExp('src="'+b[d]+'"',"g"),'src="'+e+'"')}return a}});h.add("module","block",{init:function(){this.$block=this.instance=!1},create:function(a){var b=this.app.create("block.paragraph");return a&&b.getBlock().html(a),b},createHtml:function(a){return this.create(a).getOuterHtml()},is:function(a){return a?this._isBlockActive(a):
this.get()},isType:function(a){if(this.is())return this.get().isType(a)},get:function(){return this.instance},set:function(a,b,c){a&&(a.isBlock&&(a=a.isNested()?b&&"end"===b?a.getLast().getBlock():a.getFirst().getBlock():a.getBlock()),this.app.blocks.unset(),this.app.editor.unsetSelectAll(),!0!==c&&this._isBlockActive(a)||(this.unset(),this.instance=this._getInstance(a),this.$block=this.instance.getBlock(),this.$block.addClass(this.prefix+"-block-focus"),this._setCaret(b),this.app.toolbar.build(),
this.app.control.build(),this.app.broadcast("block.set")))},unset:function(){this.instance&&(this.$block.removeClass(this.prefix+"-block-focus"),this.instance=!1,this.$block=!1,this.app.popup.close(),this.app.control.close(),this.app.context.close(),this.app.broadcast("block.unset"))},observe:function(a,b){if(-1!==["line","quote","pre"].indexOf(b)&&!this.opts[b])return!1},format:function(a){this.app.format.set(a)},add:function(a){this.app.popup.close();var b=this.get();this.app.blocks.isMeta()&&(b=
this.app.blocks.getLastSelected());a.type&&"image"===a.type&&b&&"cell"===b.getType()&&(current=current.getParent("table"));var c="after";if(a&&a.template)return b||(c=this.opts.editor.add),void this.app.insertion.insertContent({html:a.template,position:c});var d=a.instance?a.instance:this.app.create("block."+a.name,a.source);b?(b.isSecondLevel()&&(b=b.getFirstLevel()),b.isEditable()&&(c=this.app.insertion.detectPosition(b.getBlock(),!1))):c="top"===this.opts.editor.add?(b=this.app.blocks.getFirst(),
"before"):(b=this.app.blocks.getLast(),"after");var e=!0;if(b){var f=b.getType();"paragraph"===a.name&&-1!==["paragraph","heading"].indexOf(f)&&(e=!1)}return b.insert({instance:d,caret:a.caret?a.caret:"end",position:c,remove:e,type:"add"}),d},change:function(a){var b=this._getCurrentInstance();b&&b.change(a)},duplicate:function(){if(this.app.popup.close(),this.is()){var a=this.get();a.isSecondLevel()&&(a=a.getFirstLevel());var b=a.duplicate();a=a.insert({instance:b,caret:"start",type:"duplicate"});
return this.app.broadcast("block.duplicate",{instance:a}),a}},remove:function(a){var b;this.app.popup.close();var c=this.get();if(c){c.isSecondLevel()&&(c=c.getFirstLevel());var d=c.getType();if("image"===d&&(b={url:c.getSrc(),id:c.getId()}),a&&void 0!==a.tarverse&&!1===a.tarverse)this.unset(),c.remove();else{a=c.getNext();var e=c.getPrev();c.remove();a?this.app.block.set(a,"start"):e?this.app.block.set(e,"end"):this.unset()}"image"===d&&this.app.broadcast("image.remove",b);this.app.broadcast("block.remove",
{type:d});this.app.editor.isEmpty()&&this.app.editor.setEmpty()}},moveUp:function(){var a=this._getCurrentInstance();a&&(a.isSecondLevel()&&(a=a.getFirstLevel()),a.moveUp())},moveDown:function(){var a=this._getCurrentInstance();a&&(a.isSecondLevel()&&(a=a.getFirstLevel()),a.moveDown())},getData:function(){if(this.is())return this.get().getData()},setData:function(a){this.is()&&(a=a.getData(),this.get().setData(a))},_isBlockActive:function(a){return this.instance&&this.dom(a).get()===this.$block.get()},
_getCurrentInstance:function(){var a;return this.app.blocks.isMeta()?a=this.app.blocks.getLastSelected():this.is()&&(a=this.get()),a},_getInstance:function(a){return this.dom(a).dataget("instance")},_setCaret:function(a){var b=this.instance.getType(),c=this.get();-1!==["embed","image","line","layer"].indexOf(b)?(this.app.scroll.save(),this.$block.attr("tabindex","-1"),this.$block.focus(),setTimeout(function(){this.app.selection.removeAllRanges()}.bind(this),1),this.app.scroll.restore()):c.isEditable()&&
a&&this.instance.setCaret(a)}});h.add("module","observer",{init:function(){this.observer=!1;this.trigger=!0},build:function(){if(window.MutationObserver){var a=this.app.editor.getEditor().get();this.observer=this._build(a);this.observer.observe(a,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0})}},stop:function(){this.observer&&this.observer.disconnect();this.trigger=!0},isButtons:function(){return!this.app.blocks.isMeta()&&!this.app.editor.isAllSelected()&&!(!this.opts.buttons.tags&&
!this.opts.buttons.types)},buildButtons:function(a,b){var c,d=this.app.block.get(),e=!!d&&d.getType();d=!!d&&d.getTag();var f=this.app.selection.getNodes({type:"inline",selected:"inside",links:!0});d=this._getObservedTags(d,f);f=[];for(var g=0;g<d.length;g++)(c=a[d[g]])&&(f=f.concat(c));return e&&(c=b[e])&&(f=f.concat(c)),f},buildActiveButtons:function(a){var b={},c;for(c in b.tags=this.opts.buttons.tags?this.opts.buttons.tags:{},b.types=this.opts.buttons.types?this.opts.buttons.types:{},a)if(a.hasOwnProperty(c)){var d=
a[c].active;d&&(this._buildActiveButton(c,d.tags,b.tags),this._buildActiveButton(c,d.types,b.types))}return b},_build:function(a){var b=this;return new MutationObserver(function(c){b._observe(c[c.length-1],a)})},_observe:function(a,b){"attributes"===a.type&&a.target===b||this.trigger&&(this.app.broadcast("observer.change"),this.app.placeholder.toggle(),this.app.sync.trigger())},_buildActiveButton:function(a,b,c){if(b){for(var d=0;d<b.length;d++){var e=b[d];c[e]?c[e].push(a):c[e]=[a]}return c}},_getObservedTags:function(a,
b){var c=[];if(a&&c.push(a),0<b.length)for(a=0;a<b.length;a++)c.push(b[a].tagName.toLowerCase());return c}});h.add("module","input",{handle:function(a){var b=a.get("e"),c=a.get("key");this._doSelectAll(b,a)||(a.is("enter")&&a.is("shift")?this.handleShiftEnter(b,c,a):a.is("enter")?this.handleEnter(b,c,a):a.is("space")&&a.is("shift")?this.handleShiftSpace(b,c,a):a.is("space")?this.handleSpace(b,c,a):a.is("tab")&&this.opts.tab.key?this.handleTab(b,c,a):a.is("arrow")?a.is(["shift","alt","ctrl"])||this.handleArrow(b,
c,a):a.is(["delete","backspace"])&&this.handleDelete(b,c,a))},handleDelete:function(a,b,c){var d,e=this.app.block.get(),f=c.is("backspace"),g=c.is("delete");if(this.app.editor.isEmpty(!0))a.preventDefault();else{if(this.app.blocks.isMeta())return a.preventDefault(),void this.app.blocks.removeSelected();if(this.app.blocks.is())return a.preventDefault(),a=this.app.blocks.getFirstSelectedBlock(),a=this.dom(a),this.app.selection.deleteContents(),this.app.block.set(a,"end"),void this.app.block.get().appendNext();
if(!this._deleteInsideSelection(a)){if(!e)return a.preventDefault(),void this.app.selection.deleteContents();if(!(e&&e.isEditable()&&this._trimInvisibleChar(a,c.is("backspace")?"left":"right",g))){var l=this.app.selection.getInline();if(l&&1===l.innerHTML.length)return a.preventDefault(),void(l.innerHTML="");if(!e.handleDelete||!e.handleDelete(a,b,c))if(b=e.getNext(),c=e.getPrev(),e.isEditable()){if(e.isEditable()){if(e.isAllSelected())return a.preventDefault(),e.setEmpty(),this.app.caret.set(e.getBlock(),
"start"),void this.app.toolbar.observe();if(!e.isSecondLevel()&&!e.isFigcaption()){if(g&&b&&e.isCaretEnd())return a.preventDefault(),void(b.isEditable()?"pre"===b.getType()?(this.app.blocks.setMeta(b.getBlock()),e.isEmpty()&&e.remove(!0)):e.appendNext():(b.isNested()?this.app.blocks.setMeta(b.getBlock()):this.app.block.set(b),e.isEmpty()&&e.remove(!0)));if(f&&c&&e.isCaretStart())return a.preventDefault(),void(c.isEditable()?"pre"===c.getType()?(this.app.blocks.setMeta(c.getBlock()),e.isEmpty()&&e.remove(!0)):
(e.appendToPrev(),this.app.control.updatePosition()):(c.isNested()?this.app.blocks.setMeta(c.getBlock()):this.app.block.set(c),e.isEmpty()&&e.remove(!0)));if(!this.app.selection.isCollapsed())return a.preventDefault(),void this.app.selection.deleteContents()}}}else a.preventDefault(),"image"===e.getType()&&(d={url:e.getSrc(),id:e.getId()}),e.remove(!0),"image"===e.getType()&&this.app.broadcast("image.remove",d),b?this.app.block.set(b,"start"):c?this.app.block.set(c,"end"):this.app.editor.isEmpty()?
this.app.editor.setEmpty():this.app.block.unset()}}}},handleArrow:function(a,b,c){var d=this.app.block.get();if(this.app.editor.isAllSelected())return a.preventDefault(),a=c.is("down-right")?this.app.blocks.getLast():this.app.blocks.getFirst(),c=c.is("down-right")?"end":"start",this.app.editor.unselectAll(),this.app.selection.removeAllRanges(),void this.app.block.set(a,c);if(!this.app.blocks.is()){if(this.app.blocks.isMeta())return d=this.app.blocks.getLastSelected(),void this._doArrow(a,c,d);if(d.isEditable()){var e=
this.app.selection.getTopInline();if(c.is("right")&&e&&"CODE"===e.tagName){var f=this.app.caret.is(e,"end"),g=this.app.caret.is(d.getBlock(),"end");if(f&&g)return a.preventDefault(),void this.app.caret.set(e,"after")}}d.isEditable()&&this._trimInvisibleChar(a,c.is("left")?"left":"right")||d.handleArrow&&d.handleArrow(a,b,c)||this._doArrow(a,c,d)}},handleTab:function(a,b,c){var d,e=this.app.block.get();if(this.app.blocks.isMeta())return a.preventDefault(),void((d=this.app.blocks.getLastSelected().getNext())&&
this.app.block.set(d,"start"));if(this.app.blocks.is()){var f=this.app.blocks.getLastSelectedBlock();(e=this.dom(f).dataget("instance")).isSecondLevel()&&(e=e.getFirstLevel())}e.handleTab&&e.handleTab(a,b,c)||(this.opts.tab.spaces&&e.isEditable()?(a.preventDefault(),a=document.createTextNode(Array(this.opts.tab.spaces+1).join("\u00a0")),this.app.insertion.insertNode(a,"end")):(a.preventDefault(),(d=e.getNext())&&this.app.block.set(d,"start")))},handleShiftSpace:function(a){var b=this.app.block.get();
if(this.app.blocks.isMeta())a.preventDefault();else{if(this.app.blocks.is())return a.preventDefault(),a=this.app.blocks.getFirstSelectedBlock(),a=this.dom(a),this.app.selection.deleteContents(),this.app.caret.set(a,"end"),void this.app.insertion.insertHtml("&nbsp;","end");if(b.isEditable()){if(b.isAllSelected())return a.preventDefault(),void b.setEmpty();if("pre"!==b.getType())return a.preventDefault(),void this.app.insertion.insertHtml("&nbsp;","end")}}},handleSpace:function(a,b,c){var d=this.app.block.get();
return this.app.blocks.isMeta()?(a.preventDefault(),this.app.blocks.getLastSelected().insertEmpty({position:"after",caret:"start"}),void this.app.blocks.removeSelected(!1)):this.app.blocks.is()?(a=this.app.blocks.getFirstSelectedBlock(),a=this.dom(a),this.app.selection.deleteContents(),void this.app.caret.set(a,"end")):d.handleSpace&&d.handleSpace(a,b,c)?void 0:d.isEditable()&&d.isAllSelected()?(a.preventDefault(),void d.setEmpty()):void(d.isEditable()||(a.preventDefault(),d.insertEmpty({position:"after",
caret:"start"}),d.remove(!0)))},handleShiftEnter:function(a){if(this.app.blocks.isMeta())a.preventDefault();else{if(this.app.blocks.is())return a.preventDefault(),a=this.app.blocks.getFirstSelectedBlock(),a=this.dom(a),this.app.selection.deleteContents(),this.app.caret.set(a,"end"),void this.app.insertion.insertBreakline();if(!this._deleteInsideSelection(a)){var b=this.app.block.get();b.isEditable()?(a.preventDefault(),this.app.insertion.insertBreakline()):(a.preventDefault(),b.insertEmpty({position:"after",
caret:"start"}))}}},handleEnter:function(a,b,c){if(this.app.blocks.isMeta())return a.preventDefault(),void this.app.blocks.getLastSelected().insertEmpty({position:"after",caret:"start"});if(this.app.blocks.is())return a.preventDefault(),void this.app.selection.deleteContents();if(!this._deleteInsideSelection(a)){var d=this.app.block.get();if(d.isEditable()){if(d.isAllSelected())return a.preventDefault(),void d.setEmpty();if(!this.app.selection.isCollapsed())return a.preventDefault(),void("pre"===
d.getType()?this.app.insertion.insertNewline():this.app.insertion.insertBreakline())}d.isEditable()||(a.preventDefault(),d.insertEmpty({position:"after",caret:"start"}));d.handleEnter&&d.handleEnter(a,b,c)}},handleTextareaTab:function(a){if(9!==a.keyCode)return!0;a.preventDefault();a=a.target;var b=a.value,c=a.selectionStart;a.value=b.substring(0,c)+"    "+b.substring(a.selectionEnd);a.selectionStart=a.selectionEnd=c+4},_deleteInsideSelection:function(a){if(!this.app.selection.isCollapsed()){var b=
this.app.selection.getNodes({type:"blocks"});if(1<b.length)return a.preventDefault(),this.app.selection.deleteContents(),this.app.caret.set(b[0],"end"),!0}return!1},_doSelectAll:function(a,b){return this._isAllSelected(b)?(this._setEditorEmpty(a,b),!0):b.is("select")?(a.preventDefault(),this.app.editor.selectAll(),!0):void 0},_doArrow:function(a,b,c){var d,e,f=c.getType(),g=["pre","line","image","embed","layer"];if(b.is("up-left")&&c.isCaretStart()){if(e="end",!(d=c.getPrev())&&-1!==g.indexOf(f))return void this.app.insertion.insertEmptyBlock({position:"before",
caret:"start"})}else if(b.is("down-right")&&c.isCaretEnd()&&(e="start",!(d=c.getNext())&&-1!==g.indexOf(f)))return void this.app.insertion.insertEmptyBlock({position:"after",caret:"start"});d&&(a.preventDefault(),this.app.block.set(d,e))},_isAllSelected:function(a){return this.app.editor.isAllSelected()&&a.is(["enter","delete","backspace","alpha","space"])},_setEditorEmpty:function(a,b){b.is(["alpha","space"])||a.preventDefault();this.app.editor.setEmpty()},_trimInvisibleChar:function(a,b,c){var d=
"left"===b?"before":"after",e=this.app.selection.get();if((d=this._isInvisibleChar(d))&&"left"===b)a=e.current,this.dom(a).replaceWith(a.textContent.replace(/\uFEFF/g,""));else if(d&&c&&e.current&&e.current.nextSibling)a=e.current.nextSibling,this.dom(a).replaceWith(a.textContent.replace(/\uFEFF/g,""));else if(d&&"right"===b)return a.preventDefault(),a=this.app.offset.get(),this.app.offset.set(!1,{start:a.start+1,end:a.end+1}),!0},_isInvisibleChar:function(a){var b=this.app.selection.get();a=this.app.selection.getText(a);
return b.current&&3===b.current.nodeType&&0===this.app.utils.searchInvisibleChars(a)}});h.add("module","insertion",{init:function(){this._clear()},start:function(){this.win=this.app.$win.get();this.doc=this.app.$doc.get()},getFirstInserted:function(){return this.inserted.instances[0]},getLastInserted:function(){var a=this.inserted.instances[this.inserted.instances.length-1];return a&&a.isFigcaption()&&(a=a.getFigure()),a},getInserted:function(){return this.inserted},setContent:function(a){this._insert(a,
"set");a=this.getInserted();return this.inserted=!1,a},insertContent:function(a){this._insert(a,"insert");a=this.getInserted();return this.inserted=!1,a},insertEmptyBlock:function(a){(a=a||{}).html=this.app.block.createHtml();this._insert(a,"insert");a=this.getInserted();return this.inserted=!1,this.app.broadcast("block.add",{instance:a.instances[0],type:"input"}),a},insertNewline:function(a,b){return this._insertFragment({node:document.createTextNode(b?"\n\n":"\n")},a||"after")},insertPoint:function(a){var b=
this.app.utils.createInvisibleChar();var c=a.clientX;a=a.clientY;this.doc.caretPositionFromPoint?(a=this.doc.caretPositionFromPoint(c,a),(c=this.doc.getSelection().getRangeAt(0)).setStart(a.offsetNode,a.offset),c.collapse(!0),c.insertNode(b)):this.doc.caretRangeFromPoint&&this.doc.caretRangeFromPoint(c,a).insertNode(b);this.app.caret.set(b,"after")},insertBreakline:function(a){var b=this.app.selection.getNodes({type:"inline"});return this.app.selection.isCollapsed()&&0!==b.length?this._splitInline(b,
document.createElement("br")):this._insertFragment({node:document.createElement("br")},a||"after")},insertNode:function(a,b,c){return c&&(c=this.app.selection.getNodes({type:"inline"}),0!==c.length)?this._splitInline(c,a):this._insertFragment({node:this.dom(a).get()},b)},insertHtml:function(a,b){return this._insertFragment({html:a},b)},insertText:function(a,b){var c=this.app.block.get();if(!(c&&!c.isEditable()||this.app.blocks.isMeta())){c=this.win.getSelection();if(c.getRangeAt&&c.rangeCount){a=
this.app.content.getTextFromHtml(a,{nl:!0});var d=document.createTextNode(a);a=c.getRangeAt(0);a.deleteContents();a.insertNode(d);this.app.caret.set(d,b||"end")}return d}this.insertContent({html:a,caret:b})},insertListToList:function(a,b,c){var d=a.find("li"),e=d.last();d.addClass(this.prefix+"-pasteitems");e.addClass(this.prefix+"-pastemarker");a=a.children();d=this.dom(this.app.selection.getBlock());var f=this.app.caret.is(b,"start"),g=this.app.caret.is(b,"end"),l=this.app.caret.is(d,"start"),m=
this.app.caret.is(d,"end",["ul","ol"]),r=this.app.content.isEmptyHtml(d.html());f?(r&&d.remove(),b.prepend(a)):g?(r&&d.remove(),b.append(a)):r?(d.after(a),d.remove()):l?d.before(a):m?(b=d.find("ul, ol"),0!==b.length?b.prepend(a):d.after(a)):this.app.element.split(d).before(a);b=this.prefix+"-pastemarker";a=this.prefix+"-pasteitems";return c&&(e=this.app.editor.getEditor().find("."+b).removeClass(b),this.app.caret.set(e,"end")),this.app.editor.getEditor().find("."+a).removeClass(a)},detectPosition:function(a,
b){if(b)return b;b=this.app.caret.is(a,"start");return this.app.caret.is(a,"end")?"after":b?"before":"split"},_insert:function(a,b){this.html=a.html;this.html=this.app.broadcastHtml("editor.before.insert",this.html);this.isParse=void 0===a.parse||a.parse;this.isClean=void 0!==a.clean&&a.clean;this.isCaret=void 0===a.caret||a.caret;this.isPosition=void 0!==a.position&&a.position;this.isCurrent=void 0!==a.current&&a.current;"set"===b||this.app.editor.isAllSelected()?this._setContent():this._insertContent();
this.app.broadcast("editor.insert",this.inserted)},_insertContent:function(){var a,b,c=this.isCurrent?this.isCurrent:this.app.block.get(),d=!1,e=!1;if(this._checkEmpty(),this._checkLine(),this.app.blocks.isMeta()||this.app.blocks.is()){if(this.isEmpty)return;if(this.isLine&&(this.html=this.app.block.createHtml(this.html)),this._clean(),this._parse(),this._parseBuild(),a=this._buildParsedNodes(),this.app.blocks.is()){if(!(b=this.app.blocks.getLastSelectedBlock()))return;c=(b=this.dom(b)).dataget("instance");
this.app.selection.deleteContents();this._insertToEditable(c,b,a)}else this.app.blocks.getLastSelected().getBlock().after(a),this.app.blocks.removeSelected(!1)}else if(!c||this.isPosition){if(this.isEmpty)return;this.isLine&&(this.html=this.app.block.createHtml(this.html));this._clean();this._parse();this._parseBuild();a=this._buildParsedNodes();d="top"===this.isPosition||!this.isPosition&&"top"===this.opts.editor.add?(c=this.app.blocks.getFirst(),"before"):c&&-1!==["after","before","append"].indexOf(this.isPosition)?
this.isPosition:(c=this.app.blocks.getLast(),"after");c.getBlock()[d](a)}else if(this._isListToList(c))this.app.selection.deleteContents(),this._clean(),this._parse(),this._parseBuild(),b=c.getBlock(),a=this.$parsed.children().first(),this.$nodes=this.insertListToList(a,b,"end"),this.isCaret=!1;else{if(!c)return;if(c.isEditable()){if(this.isEmpty)return;this._clean();this._cleanSpecial(c);this.isLine?this._parseLine():this._parse();this._parseBuild();c.isEmpty()?(e=!0,d="after"):this.app.selection.deleteContents();
a=this._buildParsedNodes();b=c.getBlock();this._insertToEditable(c,b,a,d,e)}else{if(d="after",this.isEmpty)return;this.isLine&&(this.html=this.app.block.createHtml(this.html));this._clean();this.isLine?this._parseLine():this._parse();this._parseBuild();a=this._buildParsedNodes();c.getBlock()[d](a)}}this._buildInserted();this._buildEditor();this._buildCaret()},_insertToEditable:function(a,b,c,d,e){this.isLine?(this.$nodes=this._insertFragment({fragment:this.$parsed.get()},"end"),this.isCaret=!1):(this.app.content.isEmptyHtml(b.html())?
(d="after",e=!0):d=this.detectPosition(b,d),"split"===d?this.app.element.split(b).before(c):b[d](c),e&&a.remove())},_insertFragment:function(a,b){var c;(a.html||a.fragment?(c=this.app.fragment.build(a.html||a.fragment),this.app.fragment.insert(c)):this.app.fragment.insert(a.node),b)&&this.app.caret.set(a.node?a.node:"start"===b?c.first:c.last,b);return a.node?this.dom(a.node):this.dom(c.nodes)},_setContent:function(){this._checkEmpty();this._checkLine();this.isEmpty?this.html=this.app.block.createHtml():
this.isLine&&(this.html=this.app.block.createHtml(this.html));this._clean();this._parse();this._parseBuild();var a=this._buildParsedNodes();this.app.editor.unsetSelectAll();this.app.editor.getEditor().html("").append(a);this.isEmpty&&this.app.broadcast("editor.empty");this._buildInserted();this._buildEditor();this._buildCaret();this.app.broadcast("editor.set",this.inserted)},_splitInline:function(a,b){a=this.app.element.split(a[0]);return a.before(b),""===a.html()&&a.remove(),this.dom(b)},_buildEditor:function(){this.app.placeholder.trigger();
this.app.editor.build();this.app.editor.setFocus();this.app.toolbar.observe();this.app.context.observe()},_buildCaret:function(){if(this.isCaret){var a,b="end";"start"===this.isCaret?(a=this.getFirstInserted(),b="start"):a=this.getLastInserted();a&&this.app.block.set(a,b)}},_buildInserted:function(){this.inserted={$nodes:this.$nodes,instances:[]};this.inserted.$nodes.each(this._buildInstance.bind(this))},_buildInstance:function(a){(a=a.dataget("instance"))&&this.inserted.instances.push(a)},_buildParsedNodes:function(){return this.$parsed.get().childNodes},
_clear:function(){this.isClean=this.isSplit=this.isEmpty=this.isLine=this.html=!1;this.isCaret=this.isParse=!0;this.isPosition=this.isCurrent=!1},_clean:function(){this.isClean&&(this.html=this.app.cleaner.cleanHtml(this.html))},_cleanSpecial:function(a){var b,c;a=a.getType();-1!==["cell","address","figcaption","quoteitem"].indexOf(a)?b=!0:"list"===a&&(b=!0,c=["ul","ol","li"]);b&&(this.isLine=!0,this.html=this.app.content.addBrToBlocks(this.html),this.html=this.app.content.removeBlockTags(this.html,
void 0,c),this.html=this.html.replace(/<br\s?\/?>\n?$/gi,""))},_parse:function(){this.isParse&&(this.html=this.app.parser.parse(this.html,!1))},_parseLine:function(){this.isParse&&(this.html=this.app.parser.parseLine(this.html,!1))},_parseBuild:function(){this.$parsed=this.app.parser.build(this.html);this.$nodes=this.$parsed.children()},_checkEmpty:function(){this.isEmpty=this.app.content.isEmptyHtml(this.html)},_checkLine:function(){this.isLine=this.app.content.isLine(this.html)},_isListToList:function(a){a=
a.getBlock().attr("data-"+this.prefix+"-type");var b=this.dom("<div>").html(this.html);return b.find("meta").remove(),b.find("b").unwrap(),b=b.children().first(),"list"===a&&0!==b.length&&-1!==["ul","ol"].indexOf(b.get().tagName.toLowerCase())}});h.add("module","toolbar",{init:function(){this.eventname=this.prefix+"-toolbar";this.activeClass="active";this.toggledClass="toggled";this.disableClass="disable";this.customButtons={};this.aTags={};this.aTypes={}},start:function(){this.$container=this.app.container.get("toolbar");
this.opts.toolbar&&(this._build(),this._buildSticky())},load:function(){this.opts.toolbar&&(this._buildActiveButtons(),this.app.block.get()||(this.$toolbar.html(""),this._buildButtons()))},stop:function(){this.opts.toolbar&&(this.$toolbar.remove(),this.customButtons={},this.editorButtons={})},build:function(){if(this.opts.toolbar){var a=this.app.block.get();a&&a.isSecondLevel()&&(a=a.getFirstLevel());var b=this.app.editor.getButtonsFromArr(this.opts.buttons.editor);a&&a.toolbar&&(b=this.app.editor.getButtonsFromArr(a.toolbar));
this.$toolbar.html("");b=this._createButtons(b,a);a||this._checkIntialToolbar(b)}},observe:function(){if(this.opts.toolbar&&(this.unsetActive(),this.app.observer.isButtons())){var a=this.app.observer.buildButtons(this.aTags,this.aTypes);this._setActiveKeys(a)}},getElement:function(){return this.$toolbar},get:function(a){return this._findButton(a)},add:function(a,b){this.customButtons[a]=b},setActive:function(a){this.opts.toolbar&&(this._findButtons().removeClass(this.activeClass),this._findButton(a).removeClass(this.disableClass).addClass(this.activeClass))},
setToggled:function(a){this.opts.toolbar&&(this._findButtons().removeClass(this.toggledClass),this._findButton(a).removeClass(this.disableClass).addClass(this.toggledClass))},unsetActive:function(a){this.opts.toolbar&&(a?this._findButton(a):this._findButtons()).removeClass(this.activeClass)},unsetToggled:function(a){this.opts.toolbar&&(a?this._findButton(a):this._findButtons()).removeClass(this.toggledClass)},enable:function(){this.opts.toolbar&&this._findButtons().removeClass(this.disableClass)},
disable:function(){this.opts.toolbar&&this._findButtons().removeClass(this.toggledClass).removeClass(this.activeClass).addClass(this.disableClass)},disableSticky:function(){var a=this.app.container.get("toolbar");a.removeClass(this.prefix+"-toolbar-sticky");a.css("top","")},enableSticky:function(){if(this.opts.toolbar.sticky){var a=this.app.container.get("toolbar");a.addClass(this.prefix+"-toolbar-sticky");a.css("top",this.opts.toolbar.stickyTopOffset+"px")}},isSticky:function(){var a=this.app.container.get("toolbar"),
b=this.app.container.get("main");b=b.offset().top+parseInt(b.css("border-top-width"));a=a.offset().top;return b<a||a<b},_build:function(){this.$toolbar=this.dom("<div>").addClass(this.prefix+"-toolbar");this.$container.append(this.$toolbar);this.$container.addClass("is-"+this.prefix+"-toolbar")},_buildSticky:function(){this.opts.toolbar.sticky&&(this._toggleSticky("add",this.opts.toolbar.stickyTopOffset+"px"),this._startEvent())},_buildButtons:function(){var a=this.app.editor.getButtonsFromArr(this.opts.buttons.editor);
a=this._createButtons(a);this._checkIntialToolbar(a)},_buildActiveButtons:function(){var a=this.app.observer.buildActiveButtons(this.customButtons);this.aTags=a.tags;this.aTypes=a.types},_checkIntialToolbar:function(a){if(0===a&&!this.opts.topbar){a=this.app.blocks.getFirst();var b=this.app.editor.getButtonsFromArr(a.toolbar);this.$toolbar.html("");this._createButtons(b,a);this.disable()}},_findButtons:function(){return this.$toolbar.find("."+this.prefix+"-button-toolbar")},_findButton:function(a){return this.$toolbar.find("[data-name="+
a+"]")},_createButtons:function(a,b){var c=a;b&&(c=p.extend(!0,{},a,this.customButtons));a=0;for(var d in c)!c.hasOwnProperty(d)||"add"===d&&!this.opts.addbar||"html"===d&&!this.opts.source||"format"===d&&!this.opts.format||b&&!b.isAllowedButton(d,c[d])||this._isHidden(d)||(this.app.create("button",d,c[d],this.$toolbar,"toolbar"),a++);return a},_isHidden:function(a){return-1!==this.opts.toolbar.hide.indexOf(a)},_setActiveKeys:function(a){for(var b=0;b<a.length;b++)this._findButton(a[b]).addClass(this.activeClass)},
_getObservedTags:function(a,b){var c=[];if(a&&c.push(a),0<b.length)for(a=0;a<b.length;a++)c.push(b[a].tagName.toLowerCase());return c},_toggleSticky:function(a,b){this.$container["remove"===a?"removeClass":"addClass"](this.prefix+"-toolbar-sticky");this.$container.css("top",b)},_startEvent:function(){this.app.scroll.getTarget().on("scroll."+this.eventname,this._observeSticky.bind(this))},_stopEvent:function(){this.app.scroll.getTarget().off("."+this.eventname)},_observeSticky:function(){if(this.app.source.is())this.$container.css("top",
0);else{var a=this.app.scroll.getTarget();a=this.app.scroll.isTarget()?parseInt(a.css("padding-top")):0;this.$container.css("top",0-a+this.opts.toolbar.stickyTopOffset+"px");this.isSticky()?this.app.broadcast("toolbar.sticky"):this.app.broadcast("toolbar.static")}}});h.add("module","addbar",{init:function(){this.custom={}},popup:function(a,b){this.opts.addbar&&(this.app.popup.create("addbar",{width:"380px",items:this.buildItems()}),this.app.popup.open(b.isButton||b.isControl?{button:b}:{}))},add:function(a,
b){this.custom[a]=b;this.custom[a].container=!0;this.custom[a].addbar=!0;this.custom[a].command=b.command?b.command:"block.add";b.template&&(this.custom[a].params={template:b.template})},buildItems:function(){for(var a={},b=this.opts.buttons.addbar,c=p.extend(!0,{},this.opts.buttonsObj),d=0;d<b.length;d++){var e=b[d];this._isHidden(e)||(a[e]=c[e],a[e].container=!0,a[e].addbar=!0,a[e].icon=!0)}for(var f in this.opts.addbar.add)this.opts.addbar.add.hasOwnProperty(f)&&!this._isHidden(f)&&(a[f]=this.opts.addbar.add[f],
a[f].container=!0,a[f].addbar=!0,a[f].command="block.add",a[f].params={template:this.opts.addbar.add[f].template});return p.extend(!0,{},a,this.custom)},_isHidden:function(a){return-1!==this.opts.addbar.hide.indexOf(a)}});h.add("module","format",{popup:function(a,b){var c=this.app.block.get();a=!!c&&c.getBlock();c=!!c&&c.getTag();for(var d=this.opts.format,e={},f=0;f<d.length;f++){var g=d[f];e[g]={title:this.opts.formatObj[g].title,params:{tag:g},command:"block.format",shortcut:this.opts.formatObj[g].shortcut}}if(this.opts.formatAdd){var l=
this.opts.formatAdd;Object.keys(l).forEach(function(m){e[m]={title:l[m].title,params:l[m].params,command:"block.format"}})}(a=this._isActiveFormat(a,c,e))&&(e[a].active=!0);this.app.popup.create("format",{width:"300px",items:e});this.app.popup.open({button:b})},set:function(a){if(this.app.popup.close(),!this.app.blocks.isMeta()){var b={type:this.opts.formatObj[a.tag].type,tag:a.tag,classname:a.classname||!1},c=this.app.blocks.getSelectedBlocks("editable"),d=this.app.block.get();d?this.setSingle(d,
b,a):0!==c.length&&this.setMultiple(c,b,a)}},setSingle:function(a,b){var c,d=a.isEmpty(),e=!!d&&"start";this.tag=a.getTag();this.type=a.getType();this.$block=a.getBlock();d||this.app.selection.saveMarker();this._isSameTag(b)&&(b=this._checkSameFormat(this.$block,b));b&&(this._isListToText(b,"list")?c=this._formatListToText(b):this._isListToText(b,"dlist")?c=this._formatListToText(b,!0):this._isTextToList(b,"list")?this._formatTextToList(b,!1,e):this._isTextToList(b,"dlist")?this._formatTextToList(b,
!0,e):this._replaceTo(a,b,e));d||this.app.selection.restoreMarker();c&&this.app.block.unset();a=this.app.block.get();this.app.editor.build();this.app.broadcast("block.format",{instance:a})},setMultiple:function(a,b){var c,d,e;this.app.selection.saveMarker();this._isListTag(b.tag)&&this._isMultipleParagraphs()&&(e=(c=this.app.create("block."+b.type,!1,{tag:b.tag})).getBlock(),this.dom(a[0]).before(e));for(var f=0;f<a.length;f++){var g;if((d=a[f].tagName.toLowerCase())!==b.tag)if(e){var l=this.dom("<li>").html(a[f].innerHTML);
e.append(l);this.dom(a[f]).remove();this._setStyleAndClass(e,b)}else!this._isListTag(d)&&this._isListTag(b.tag)?(d=(c=this.app.create("block."+b.type,!1,{tag:b.tag})).getBlock(),l=this.dom("<li>").html(a[f].innerHTML),d.append(l),(g=this.dom(a[f])).after(d),g.remove(),this._setStyleAndClass(d,b)):this._isListTag(d)&&!this._isListTag(b.tag)?(d=(g=this.dom(a[f])).find("li"),d.find("ul, ol").each(function(m){m.parent().after(m)}),d.find("ul, ol").unwrap(),d.each(function(m){var r=this.dom("<"+b.tag+
">");r.html(m.html());m.remove();this.app.create("block."+b.type,r);g.before(r);this._setStyleAndClass(r,b)}.bind(this)),g.remove()):c=this._replaceToBlock(a[f],b)}this.app.selection.restoreMarker();e&&this.app.block.set(e);this.app.editor.build();this.app.editor.unsetSelectAll();this.app.broadcast("block.format",{instance:c})},_isListTag:function(a){return-1!==["ul","ol"].indexOf(a)},_isSameTag:function(a){return this.tag===a.tag&&this.type===a.type},_isMultipleParagraphs:function(){var a=this.app.blocks.getSelectedBlocks(),
b="P ADDRESS H1 H2 H3 H4 H5 H6".split(" ");if(1<a.length){for(var c=0,d=0;d<a.length;d++)-1===b.indexOf(a[d].tagName)&&c++;if(0===c)return!0}return!1},_checkSameFormat:function(a,b){a=this.app.element.hasClass(a,b.classname);return!b.classname||a?this._buildDefaultFormat():b},_buildDefaultFormat:function(){return{type:"paragraph",tag:"p",classname:!1}},_formatListToText:function(a,b){b=b?this._getDlistItems():this._getListItems();return this._createItems(b,a),this.$block.remove(),b},_formatTextToList:function(a,
b,c){var d=this.app.create("block."+a.type,"<"+a.tag+">").getBlock();if(b&&"list"===this.type){var e=0;this._getListItems().each(function(f){var g=0===e?"dt":"dd";f=this.dom("<"+g+">").html(f.html());e="dt"==g?1:0;d.append(f)}.bind(this))}else b||"dlist"!==this.type?(b=this.dom(b?"<dt>":"<li>").html(this.$block.html()),d.append(b)):this._getDlistItems().each(function(f){f=this.dom("<li>").html(f.html());d.append(f)}.bind(this));this.app.create("block."+a.type,d);this.$block.after(d);this.$block.remove();
this._setStyleAndClass(d,a);this.app.block.set(d,c)},_replaceTo:function(a,b,c){a=a.getBlock();b=this._replaceToBlock(a,b).getBlock();this.app.block.set(b,c)},_replaceToBlock:function(a,b){a=this.app.element.replaceToTag(a,b.tag);return this._setStyleAndClass(a,b),this.app.create("block."+b.type,a)},_createItems:function(a,b){a.each(function(c){var d=this.dom("<"+b.tag+">");d.html(c.html());c.remove();this.app.create("block."+b.type,d);this.$block.before(d);this._setStyleAndClass(d,b)}.bind(this))},
_isListToText:function(a,b){return this.type===b&&-1!==["heading","address","paragraph"].indexOf(a.type)},_isTextToList:function(a,b){return a.type===b&&-1!==["heading","address","paragraph","list"===b?"dlist":"list"].indexOf(this.type)},_isActiveFormat:function(a,b,c){if(a){var d,e;for(e in c)if(c.hasOwnProperty(e)){var f=c[e].params.classname||!1;b===c[e].params.tag&&(f?f&&this.app.element.hasClass(a,f)&&(d=e):d=e)}return d}},_setStyleAndClass:function(a,b){a.removeAttr("style class data-"+this.prefix+
"-style-cache");b.classname&&a.addClass(b.classname)},_getListItems:function(){var a=this.$block.find("li");return a.find("ul, ol").each(function(b){b.parent().after(b)}),a.find("ul, ol").unwrap(),a},_getDlistItems:function(){return this.$block.find("dt, dd")}});h.add("module","embed",{popups:{add:{title:"## embed.embed ##",width:"100%",form:{embed:{type:"textarea",label:"## embed.description ##",rows:6},caption:{type:"input",label:"## embed.caption ##"},responsive:{type:"checkbox",text:"## embed.responsive-video ##"}},
footer:{insert:{title:"## buttons.insert ##",command:"embed.insert",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}},edit:{title:"## embed.embed ##",width:"100%",form:{embed:{type:"textarea",label:"## embed.description ##",rows:6},caption:{type:"input",label:"## embed.caption ##"},responsive:{type:"checkbox",text:"## embed.responsive-video ##"}},footer:{save:{title:"## buttons.save ##",command:"embed.save",type:"primary"},remove:{title:"## buttons.delete ##",command:"embed.remove",
type:"danger",right:!0},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}}},build:function(a){a?this._callScripts(a):this._findScripts()},observe:function(a,b,c){if(!this.opts.embed)return!1;b=this.app.block.get();return c&&"addbar"===c.getName()?a.command="embed.popup":b&&"embed"===b.getType()&&(a.command="embed.edit"),a},popup:function(){this.app.popup.create("embed",this.popups.add);this.app.popup.open({focus:"embed"});this.opts.embed.checkbox&&stack.getInput("responsive").attr("checked",
!0);this._buildCodemirror()},edit:function(a){a=this.app.block.get();a={embed:a.getEmbedCode(),caption:a.getCaption(),responsive:a.isResponsive()};this.app.popup.create("embed",this.popups.edit);this.app.popup.setData(a);this.app.popup.open({focus:"embed"});this._buildCodemirror()},insert:function(){this.app.popup.close();var a=this.app.popup.getData(),b=this._getEmbedCode(a);""!==b&&(a=this._createInstance(a,b),this.app.block.add({instance:a}))},save:function(){this.app.popup.close();var a=this.app.block.get(),
b=this.app.popup.getData(),c=this._getEmbedCode(b);""!==c?(c=this._createInstance(b,c,a),this._isNeedToChange(b,c,a)&&this.app.block.change(c)):this.app.block.remove()},remove:function(){this.app.popup.close();this.app.block.remove()},_buildCodemirror:function(){var a=this.app.popup.getInput("embed");this.app.codemirror.create({el:a,height:"200px",focus:!0});this.app.popup.updatePosition()},_findScripts:function(){var a=this.app.editor.getEditor().find("[data-"+this.prefix+"-type=embed]").find("script").getAll();
this.build.call(this,a)},_callScripts:function(a){for(var b=0;b<a.length;b++)if(""!==a[b].src){var c=a[b].src;this.app.$doc.find('head script[src="'+c+'"]').remove();var d=this.dom("<script>").attr({src:c,async:!0,defer:"true"});d.on("load",function(){if(-1!==c.search("instagram")){var f=this.app.$win.get();f.instgrm&&f.instgrm.Embeds.process()}this.build(a.slice(b+1))}.bind(this));var e=this.app.$doc.get().getElementsByTagName("head")[0];e&&e.appendChild(d.get())}},_getEmbedCode:function(a){a=a.embed.trim();
return a=this.app.codemirror.val(a),a=this._removeScript(a),a=this.app.content.sanitize(a),this._isHtmlString(a)||""===a?a:this._parseUrl(a)},_removeScript:function(a){return this.opts.embed.script||(a=this.app.content.removeTagsWithContent(a,["script"])),a},_createInstance:function(a,b,c){var d;c?(d=c.duplicate().getBlock()).html(b):d=this._isFigure(b)?b:"<figure>"+b+"</figure>";b=this.app.create("block.embed",d);return b.setCaption(a.caption),a.responsive&&b.addResponsive(),b},_parseUrl:function(a){if(a.match(this.opts.regex.youtube)){var b=
"//www.youtube.com";return-1!==a.search("youtube-nocookie.com")&&(b="//www.youtube-nocookie.com"),'<iframe width="560" height="315" src="'+a.replace(this.opts.regex.youtube,b+"/embed/$1")+'" frameborder="0" allowfullscreen></iframe>'}return a.match(this.opts.regex.vimeo)?'<iframe width="560" height="315" src="'+a.replace(this.opts.regex.vimeo,"//player.vimeo.com/video/$2")+'" frameborder="0" allowfullscreen></iframe>':a},_isNeedToChange:function(a,b,c){return c.getEmbedCode()!==b.getEmbedCode()||
a.responsive!==c.isResponsive()||a.caption!==c.getCaption()||void 0},_isHtmlString:function(a){return/^\s*<(\w+|!)[^>]*>/.test(a)},_isFigure:function(a){return/^<figure/.test(a)}});h.add("module","image",{popups:{add:{title:"## popup.add-image ##",width:"100%"},edit:{title:"## popup.image ##",width:"100%",getter:"block.getData",form:{width:{type:"input",width:"100px",label:"## image.width ##",observer:"image.observeImageWidth"},alt:{type:"input",label:"## image.alt-text ##"},caption:{type:"input",
label:"## image.caption ##",observer:"image.observeImageCaption"},link:{type:"input",label:"## image.link ##",observer:"image.observeImageLink"},target:{type:"checkbox",text:"## image.link-in-new-tab ##",observer:"image.observeImageLink"}},footer:{save:{title:"## buttons.save ##",command:"image.save",type:"primary"},remove:{title:"## buttons.delete ##",command:"image.remove",type:"danger",right:!0},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}}},init:function(){this.dataStates=[]},
popup:function(){this.app.popup.create("image",this.popups.add);var a=this.app.popup.getBody();this._createImageByUrl(a);this._createOrSection(a);this._createUploadBox(a);this._createSelectBox(a);this.app.popup.open()},edit:function(a){this.app.popup.create("image-edit",this.popups.edit);this._buildEditUpload();this.app.popup.open()},observe:function(a,b,c){if(!this.isImagePopup())return!1;b=this.app.block.get();return c&&"addbar"===c.getName()?a.command="image.popup":b&&"image"===b.getType()&&(a.command=
"image.edit"),a},observeStates:function(){this._findImages().each(this._addImageState.bind(this))},observeImageLink:function(a){return!!this.opts.image.link&&a},observeImageCaption:function(a){var b=this.app.block.get();return!(!b||"figure"!==b.getTag())&&a},observeImageWidth:function(a){return!!this.opts.image.width&&a},isImagePopup:function(){return!1!==this.opts.image},paste:function(a,b){var c={url:this.opts.image.upload,name:this.opts.image.name,data:this.opts.image.data,multiple:this.opts.image.multiple,
success:"image.insertFromBlob",error:"image.error"};this.app.create("upload").send(b,[a],c)},parseInserted:function(a){var b=[],c={url:this.opts.image.upload,name:this.opts.image.name,data:this.opts.image.data,multiple:!0,success:"image.insertFromInserted",error:"image.error"};this.pasteInsertedImages=[];this.resolved=[];for(var d=0,e=0;e<a.instances.length;e++){var f=a.instances[e];if("image"===f.getType()){var g=f.getSrc();if(-1!==g.search(/^data:/i))g=this._dataURLtoFile(g,"image"+e),b.push(g),
this.pasteInsertedImages.push(f);else if(-1!==g.search(/^blob:/i)){d++;this.pasteInsertedImages.push(f);var l=this;(function(r,v){var x=new XMLHttpRequest;x.open("GET",r,!0);x.responseType="blob";x.onload=function(w){200==x.status&&(w=new File([x.response],"image"+v,{type:"image/png"}),l.resolved.push(w))};x.send()})(g,e)}}}if(0!==d)var m=setInterval(function(){this.resolved.length===d&&(clearInterval(m),this.app.create("upload").send(!1,this.resolved,c))}.bind(this),100);0!==b.length&&this.app.create("upload").send(!1,
b,c)},drop:function(a,b){for(var c=[],d=0;d<b.files.length;d++){var e=b.files[d]||b.items[d].getAsFile();e&&c.push(e)}b={url:this.opts.image.upload,name:this.opts.image.name,data:this.opts.image.data,multiple:this.opts.image.multiple,success:"image.insertByDrop",error:"image.error"};0<c.length&&(d=this.dom(a.target).closest("[data-"+this.prefix+"-type]"),0!==d.length&&this.app.block.set(d),this.app.create("upload").send(a,c,b))},insertFromClipboard:function(a){if(""===(a.getData("text/plain")||a.getData("text/html")).trim()){a=
a.items;for(var b=null,c=0;c<a.length;c++)0===a[c].type.indexOf("image")&&(b=a[c].getAsFile());return null!==b?(this.paste(b),!0):void 0}},insertFromBlob:function(a){this.insert(a)},insertByDrop:function(a,b){if(this.app.block.is()){var c=this.app.block.get(),d=b.target,e=c.getType();if("card"===e&&d&&"IMG"===d.tagName&&c.hasImage()||"image"===e)return void this.change(a);b&&"card"!==e&&c.isEditable()&&this.app.insertion.insertPoint(b)}this.insert(a)},insertByUpload:function(a){this.insert(a)},insertByUrl:function(a){a.preventDefault();
a=this.$urlinput.val();""!==a.trim()&&(a={file:{url:a,id:this.app.utils.getRandomId()}},this.insert(a))},insertFromSelect:function(a){a.preventDefault();a=this.dom(a.target);for(var b={url:a.attr("data-url")},c="id alt caption link width height".split(" "),d=0;d<c.length;d++){var e=a.attr("data-"+c[d]);null!==e&&(b[c[d]]=e)}this.insert({file:b},!0)},insertFromInserted:function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&(this.pasteInsertedImages[b].setImage(a[c]),b++)},changeClone:function(a){for(var b in a)if(a.hasOwnProperty(b)){this.$imageclone.attr("src",
a[b].url);break}this.change(a,!1)},change:function(a,b){!1!==b&&this.app.popup.close();b=this.app.block.get();for(var c in a)if(a.hasOwnProperty(c))return b.setImage(a[c]),this.app.broadcast("image.change",a[c]),void this.app.broadcast("image.upload",{instance:b,data:a[c]});this.app.parser.buildPredefinedClasses()},save:function(a){this.app.popup.close();this.app.block.setData(a)},insert:function(a,b){this.app.popup.close();this.imagescount=this.imageslen=0;var c=this.opts.image.tag,d;for(d in a)if(a.hasOwnProperty(d)){var e=
this.dom("<"+c+">"),f=this._createImageFromResponseItem(a[d]);e.append(f);e=this.app.create("block.image",e);if(this.app.block.add({instance:e,type:"image"}),Object.prototype.hasOwnProperty.call(a[d],"caption"))f=this.dom("<figcaption>").html(a[d].caption),e.$block.append(f),this.app.create("block.figcaption",f);this.app.broadcast("image."+(b?"select":"upload"),{instance:e,data:a[d]});this.$last=e.getBlock();this.imageslen++}},remove:function(){this.app.popup.close();this.app.block.remove()},error:function(a){this.app.broadcast("image.upload.error",
{response:a})},getStates:function(){var a=this._findImages(),b;for(b in this.dataStates)if(this.dataStates.hasOwnProperty(b)){var c=this.dataStates[b],d=a.is('[data-image="'+c.id+'"]');this._setImageState(c.id,d)}return this.dataStates},createUploadBox:function(a,b){if(a)return a=this.dom("<div>"),b.append(a),a},createSelectBox:function(a,b,c){a&&((this.$selectbox=this._createImagesBox(b),"object"==typeof a)?this._parseList(a,c):(b=this.opts.editor.reloadmarker?{d:(new Date).getTime()}:{},this.ajax.get({url:a,
data:b,success:function(d){this._parseList(d,c)}.bind(this)})))},_findImages:function(){return this.app.editor.getEditor().find("[data-image]")},_addImageState:function(a){var b=a.attr("data-image");this.dataStates[b]={type:"image",status:!0,url:a.attr("src"),$img:a,id:b}},_setImageState:function(a,b){this.dataStates[a].status=b},_checkImageLoad:function(){this.imagescount++;this.imagescount===this.imageslen&&(this.app.block.unset(),this.app.block.set(this.$last))},_buildEditUpload:function(){if(this.opts.image.upload){var a=
this.app.block.get(),b=this.app.popup.getBody(),c=this._createFormItem();c.addClass(this.prefix+"-form-item-edit-image-box");this.$imageclone=a.getImage().clone();this.$imageclone.removeAttr("width height style");a=this.dom("<div>").addClass(this.prefix+"-form-item-image");a.append(this.$imageclone);c.append(a);this.$upload=this.dom("<div>");c.append(this.$upload);b.prepend(c);this._buildUpload(this.$upload,"image.changeClone")}},_buildUpload:function(a,b){this.opts.image.upload&&(b={box:!0,placeholder:this.lang.get("image.upload-new-placeholder"),
url:this.opts.image.upload,name:this.opts.image.name,data:this.opts.image.data,multiple:this.opts.image.multiple,success:b,error:"image.error"},this.app.create("upload",a,b))},_createSelectBox:function(a){this.createSelectBox(this.opts.image.select,a,"image.insertFromSelect")},_createUploadBox:function(a){this.$upload=this.createUploadBox(this.opts.image.upload,a);this._buildUpload(this.$upload,"image.insertByUpload")},_createImageFromResponseItem:function(a){for(var b=this.dom("<img>").attr("src",
a.url).one("load",this._checkImageLoad.bind(this)),c=b,d=["id","alt","width","height"],e=0;e<d.length;e++)Object.prototype.hasOwnProperty.call(a,d[e])&&c.attr(d[e],a[d[e]]);if(Object.prototype.hasOwnProperty.call(a,"id")&&c.attr("data-image",a.id),Object.prototype.hasOwnProperty.call(a,"2x")&&c.attr("srcset",a["2x"]+" 2x"),Object.prototype.hasOwnProperty.call(a,"link"))c=this.dom("<a>"),c.attr("href",a.link),b.wrap(c);return c},_createImagesBox:function(a){var b=this.dom("<div>").addClass(this.prefix+
"-popup-images-box");return a.append(b),b},_createOrSection:function(a){if(this.opts.image.url&&(this.opts.image.upload||this.opts.image.select)){var b=this.dom("<div>").addClass(this.prefix+"-popup-image-section-or");b.html(this.lang.get("image.or"));a.append(b)}},_createImageByUrl:function(a){if(this.opts.image.url){var b=this._createFormItem();this.$urlinput=this._createUrlInput();this.$urlbutton=this._createUrlButton();b.append(this.$urlinput);b.append(this.$urlbutton);a.append(b);this.$urlinput.focus()}},
_createFormItem:function(){return this.dom("<div>").addClass(this.prefix+"-form-container-flex")},_createUrlInput:function(){var a=this.dom("<input>").addClass(this.prefix+"-form-input");return a.attr("placeholder",this.lang.get("image.url-placeholder")),a},_createUrlButton:function(){var a=this.dom("<button>").addClass(this.prefix+"-form-button "+this.prefix+"-form-button-primary");return a.html(this.lang.get("buttons.insert")),a.one("click",this.insertByUrl.bind(this)),a},_parseList:function(a,
b){for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];if("object"==typeof d){var e=this.dom("<img>"),f=d.thumb?d.thumb:d.url;e.addClass(this.prefix+"-popup-event");e.attr("src",f);e.attr("data-url",d.url);e.attr("data-callback",b);f="id alt caption link width height".split(" ");for(var g=0;g<f.length;g++)Object.prototype.hasOwnProperty.call(d,f[g])&&e.attr("data-"+f[g],d[f[g]]);e.on("click."+this.prefix+"-popup-event-"+this.uuid,function(l){var m=this.dom(l.target).attr("data-callback");this.app.api(m,
l)}.bind(this));this.$selectbox.append(e)}}},_dataURLtoFile:function(a,b){var c=a.split(",");a=c[0].match(/:(.*?);/)[1];c=atob(c[1]);for(var d=c.length,e=new Uint8Array(d);d--;)e[d]=c.charCodeAt(d);return new File([e],b,{type:a})}});h.add("module","link",{popups:{format:{items:{format:{title:"## link.link ##",command:"link.format",shortcut:"Ctrl+k"},unlink:{title:"## link.unlink ##",command:"link.unlink"}}},change:{items:{edit:{title:"## link.edit-link ##",command:"link.format",shortcut:"Ctrl+k"},
unlink:{title:"## link.unlink ##",command:"link.unlink"}}},create:{title:"## popup.link ##",width:"600px",form:{text:{type:"input",label:"## link.text ##"},url:{type:"input",label:"## link.url ##"},target:{type:"checkbox",text:"## link.link-in-new-tab ##"}},footer:{insert:{title:"## buttons.insert ##",command:"link.insert",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}},edit:{title:"## popup.link ##",width:"600px",form:{text:{type:"input",label:"## link.text ##"},url:{type:"input",
label:"## link.url ##"},target:{type:"checkbox",text:"## link.link-in-new-tab ##"}},footer:{save:{title:"## buttons.save ##",command:"link.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}}},popup:function(a,b){a=0===this.getLink().length?"format":"change";this.app.popup.create("link-items",this.popups[a]);this.app.popup.open({button:b})},format:function(a){this.app.selection.restore();a=this.getLink();var b=0!==a.length,c=this.app.selection.getText();this.app.selection.save();
this.app.popup.create("link",this.popups[b?"edit":"create"]);var d={};d=b?(d={text:a.text(),url:a.attr("href"),target:a.attr("target")||this.opts.link.target},this._encodeUrl(d)):{text:c,target:this.opts.link.target};this.app.popup.setData(d);this.app.popup.open(b?{focus:"url"}:{focus:c?"url":"text"})},insert:function(){this.app.popup.close();var a=this.app.inline.set({tag:"a",caret:"after"});a=this.dom(a);this._save(a,"add")},save:function(){this.app.popup.close();var a=this.getLink();this._save(a,
"change")},unlink:function(){this.app.popup.close();var a=this.app.selection.getNodes({tags:["a"]});if(0!==a.length){for(var b=0;b<a.length;b++){var c=this.dom(a[b]);this.app.broadcast("link.remove",{url:c.attr("href"),text:c.text()});c.unwrap()}this.app.toolbar.observe();this.app.context.observe()}},getLink:function(){var a=this.app.selection.getNodes({tags:["a"]});return 0!==a.length?this.dom(a[0]):this.dom()},_save:function(a,b){var c=this.app.popup.getData();c=this._cleanUrl(c);""!==(c=this._encodeUrl(c)).url?
(c=this._setUrl(a,c),1===a.length&&(c=this._setText(a,c)),c=this._setTarget(a,c),this.app.broadcast("link."+b,c)):a.unwrap()},_cleanUrl:function(a){return a.url=this.app.content.escapeHtml(a.url),a.url=-1!==a.url.search(/^javascript:/i)?"":a.url,a},_encodeUrl:function(a){return a.url=a.url?a.url.replace(/&amp;/g,"&"):"",a},_setUrl:function(a,b){return a.attr("href",b.url),b},_setText:function(a,b){return b.text=""===b.text?b.url:b.text,a.text(b.text),b},_setTarget:function(a,b){return b.target?a.attr("target",
"_blank"):a.removeAttr("target"),b}});h.add("module","table",{popups:{cell:{title:"## table.column ##",width:"300px",form:{width:{type:"input",label:"## table.width ##"},nowrap:{type:"checkbox",text:"## table.nowrap ##"}},footer:{insert:{title:"## buttons.save ##",command:"table.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"popup.close"}}}},items:{addhead:{title:"## table.add-head ##",command:"table.addHead"},addcolumnafter:{title:"## table.add-column-after ##",command:"table.addColumnAfter"},
addcolumnbefore:{title:"## table.add-column-before ##",command:"table.addColumnBefore"},addrowbelow:{title:"## table.add-row-below ##",command:"table.addRowBelow"},addrowabove:{title:"## table.add-row-above ##",command:"table.addRowAbove"},removehead:{title:"## table.remove-head ##",command:"table.removeHead",divider:"top"},removecolumn:{title:"## table.remove-column ##",command:"table.removeColumn"},removerow:{title:"## table.remove-row ##",command:"table.removeRow"},removetable:{title:"## table.delete-table ##",
command:"table.removeTable",divider:"top"}},add:function(){var a=this.app.block.add({name:"table",source:this.opts.table.template,caret:"start"}).getFirstCell();a&&this.app.caret.set(a.getBlock(),"start")},observe:function(a,b,c){if(!this.opts.table)return!1;b=this.app.block.get();return c&&"addbar"===c.getName()?a.command="table.add":b&&b.isType(["table","cell"])&&(a.command="table.popup"),a},popup:function(a,b){this.app.popup.create("table",{items:this.items});this.app.popup.open({button:b})},addHead:function(){var a=
this.app.block.get().getTable().getBlock();this.removeHead();var b=a.find("tr").first().children("td, th").length,c=this.dom("<thead>");b=this._buildRow(!1,b,"<th>");c.append(b);a.prepend(c);this.app.block.set(b.children("td, th").first(),"start")},addRowBelow:function(){this._addRow("below")},addRowAbove:function(){this._addRow("above")},addColumnBefore:function(){this._addColumn("before")},addColumnAfter:function(){this._addColumn("after")},removeTable:function(){this.app.popup.close();this.app.block.remove()},
removeHead:function(){this.app.popup.close();var a=this.app.block.get().getTable(),b=a.getBlock().find("thead");0!==b.length&&b.remove();a.getFirst().setCaret("start")},removeRow:function(){this.app.popup.close();this.app.control.close();var a=this.app.block.get(),b=a.getTable();a=a.getRow();var c=a.getBlock().closest("thead");0!==c.length?(c.remove(),b.getFirst().setCaret("start")):a.remove()},removeColumn:function(){this.app.popup.close();this.app.control.close();var a=this.app.block.get().getBlock(),
b=a.closest("table"),c=0;a.closest("tr").find("td, th").each(function(d,e){d.get()===a.get()&&(c=e)});b.find("tr").each(function(d){d=d.find("td, th").get(c);this.dom(d).remove()}.bind(this))},cellSetting:function(a,b){a=this.app.block.get();this.app.popup.create("cell",this.popups.cell).setData({width:a.getWidth(),nowrap:a.getNowrap()});this.app.popup.open({button:b,focus:"width"})},save:function(a){this.app.popup.close();a=a.getData();var b=this.app.block.get();""!==a.width&&b.setWidth(a.width);
b.setNowrap(a.nowrap)},_addColumn:function(a){this.app.popup.close();var b=this.app.block.get().getBlock(),c=b.closest("table"),d=b.closest("tr"),e=0;d.find("td, th").each(function(l,m){l.get()===b.get()&&(e=m)});var f,g=0;c.find("tr").each(function(l,m){l.get()===d.get()&&(g=m)});c.find("tr").each(function(l,m){l=l.find("td, th").get(e);l=this.dom(l);var r=l.clone();r.html("");this.app.create("block.cell",r);g===m&&(f=r);l[a](r)}.bind(this));f&&this.app.block.set(f,"start")},_addRow:function(a){this.app.popup.close();
a="below"===a?"after":"before";var b=this.app.block.get().getBlock(),c=b.closest("tr");b=b.closest("thead");var d=c.children("td, th").length;d=this._buildRow(c,d,"<td>");0!==b.length?b.after(d):c[a](d);this.app.block.set(d.find("td, th").first(),"start")},_buildRow:function(a,b,c){if(!1===a){a=this.dom("<tr>");for(var d=0;d<b;d++){var e=this.dom(c);this.app.create("block.cell",e);a.append(e)}}else(a=a.clone()).find("td, th").html("");return this.app.create("block.row",a),a.find("td, th").each(function(f){this.app.create("block.cell",
f)}.bind(this)),a}});h.add("module","context",{init:function(){this.customButtons={};this.activeClass="active";this.eventname="."+this.prefix+"-context";this.aTags={};this.aTypes={};this.clickOffset=!1},start:function(){this.opts.context&&this._build()},stop:function(){this.app.scroll.isTarget()&&this.app.scroll.getTarget().off(this.eventname);this.opts.context&&this.$context.remove()},isOpen:function(){this.$context.hasClass("open")},close:function(){this.opts.context&&this._close()},add:function(a,
b){this.customButtons[a]=b},observe:function(){this.opts.context&&this._observe()},_doOpen:function(a){!1===this.opts.context||this.app.utils.isMobile()||setTimeout(function(){if(this._isSelection())this._open(a);else{if(this._isInstance()&&this.clickOffset&&this.clickOffset.x===a.pageX&&this.clickOffset.y===a.pageY)return this.clickOffset=!1,void this._open(a);this._close();this.clickOffset={x:a.pageX,y:a.pageY}}}.bind(this),0)},_open:function(a){this.$context.html("");this._buildButtons();this._buildCustomButtons();
this._buildActiveButtons();this._buildPosition(a);this._buildEvents();this._observe()},_close:function(){this.$context.removeClass("open");this.$context.hide();this.app.editor.getEditor().off(this.eventname);this.app.scroll.isTarget()&&this.app.scroll.getTarget().off(this.eventname)},_isSelection:function(){return!this.app.blocks.is()&&this._isInstance()&&this.app.selection.is()&&!this.app.selection.isCollapsed()},_isInstance:function(){var a=this.app.block.get(),b=a&&a.isEditable();a=a&&"pre"!==
a.getType();return b&&a},_scroll:function(){var a=this.app.selection.getPosition().bottom+this.app.$doc.scrollTop();if(this.$context.css("top",a+2+"px"),this.app.scroll.isTarget()){var b=this.app.scroll.getTarget(),c=b.offset().top+b.height();b=b.offset().top;c<a+this.$context.height()||a<b?this.$context.hide():this.$context.show()}},_build:function(){this.$context=this.dom("<div>").addClass(this.prefix+"-context "+this.prefix+"-context-"+this.uuid).hide();this.app.$body.append(this.$context);this.app.editor.getEditor().on("mouseup."+
this.prefix+"-context-up",this._doOpen.bind(this))},_buildButtons:function(){for(var a=this.opts.buttons.context,b=p.extend(!0,{},this.opts.buttonsObj),c=0;c<a.length;c++){var d=a[c];this.app.create("button",d,b[d],this.$context,"context")}},_buildCustomButtons:function(){var a=this.customButtons,b;for(b in a)a.hasOwnProperty(b)&&this.app.create("button",b,a[b],this.$context,"context")},_buildPosition:function(a){var b=this.$context.width(),c=this.app.editor.getRect(),d=this.app.selection.getPosition();
a=a.pageX-b/2;d=d.bottom+this.app.$doc.scrollTop();a<c.left&&(a=c.left+4);a+b>c.right&&(a=c.right-b-4);this.$context.css({left:a+"px",top:d+2+"px"});this.$context.addClass("open");this.$context.show()},_buildEvents:function(){var a=this.app.editor.getEditor();a.on("mousedown"+this.eventname,this._close.bind(this));a.on("keydown"+this.eventname,this._close.bind(this));this.app.scroll.isTarget()&&this.app.scroll.getTarget().on("scroll"+this.eventname,this._scroll.bind(this))},_buildActiveButtons:function(){var a=
this.app.observer.buildActiveButtons(this.customButtons);this.aTags=a.tags;this.aTypes=a.types},_observe:function(){if(this._unsetActive(),this.app.observer.isButtons()){var a=this.app.observer.buildButtons(this.aTags,this.aTypes);this._setActiveKeys(a)}},_setActiveKeys:function(a){for(var b=0;b<a.length;b++)this._findButton(a[b]).addClass(this.activeClass)},_unsetActive:function(){this._findButtons().removeClass(this.activeClass)},_findButtons:function(){return this.$context.find("."+this.prefix+
"-button-context")},_findButton:function(a){return this.$context.find("[data-name="+a+"]")}});h.add("module","topbar",{init:function(){this.activeClass="active";this.disableClass=this.toggledClass="disable";this.customButtons={}},start:function(){this._isTopbar()&&this._build()},load:function(){this._buildButtons()},get:function(a){return this._findButton(a)},add:function(a,b){this.customButtons[a]=b},setToggled:function(a){this._isTopbar()&&(this._findButtons().removeClass(this.toggledClass),this._findButton(a).addClass(this.toggledClass))},
unsetToggled:function(a){this._isTopbar()&&(a?this._findButton(a):this._findButtons()).removeClass(this.toggledClass)},enable:function(){this._isTopbar()&&this._findButtons().removeClass(this.disableClass)},disable:function(){this._isTopbar()&&this._findButtons().removeClass(this.toggledClass).removeClass(this.activeClass).addClass(this.disableClass)},_isTopbar:function(){return this.opts.topbar},_build:function(){this.$topbar=this.dom("<div>").addClass(this.prefix+"-topbar");this.app.container.get("toolbar").append(this.$topbar)},
_buildButtons:function(){var a=this.app.editor.getButtonsFromArr(this.opts.buttons.topbar),b;for(b in a=p.extend(!0,{},a,this.customButtons),this.opts.topbar.add&&(a=p.extend(!0,{},a,this.opts.topbar.add)),a)!a.hasOwnProperty(b)||this.opts.topbar.hide&&-1!==this.opts.topbar.hide.indexOf(b)||this.app.create("button",b,a[b],this.$topbar,"topbar")},_findButtons:function(){return this.$topbar.find("."+this.prefix+"-button-topbar")},_findButton:function(a){return this.$topbar.find("[data-name="+a+"]")}});
h.add("module","control",{init:function(){this.instance=!1;this.customItems={};this.eventName=this.prefix+"-control"},start:function(){this._build()},stop:function(){this._isControl()&&this.$control.remove();this.instance=!1},getElement:function(){return this.$control},add:function(a,b){this.customItems[a]=b},build:function(){if(this._isControl()){var a=this.app.block.get();a.isFigcaption()||(a.isSecondLevel()&&(a=a.getFirstLevel()),a?this.open(a):this.close())}},open:function(a){this._isControl()&&
((this.instance=a,this.instance)?(this.$control.show(),this.updatePosition(),a=this.app.scroll.getTarget(),a.on("resize."+this.eventName,this.updatePosition.bind(this)),a.on("scroll."+this.eventName,this.updatePosition.bind(this)),this.$button.off("."+this.prefix+"-control-button"),this.app.$win.off("."+this.prefix+"-control-button"),this.opts.control&&this.$button.on("click."+this.prefix+"-control-button",this._click.bind(this)),this.opts.reorder&&this.$button.on("mousedown."+this.prefix+"-control-button touchstart."+
this.prefix+"-control-button",this._press.bind(this))):this.close())},close:function(){if(this._isControl()){if(this.$control.hide(),this.instance){var a=this.instance.getBlock();this.app.content.unfixListMargin(a)}this.app.scroll.getTarget().off("."+this.eventName);this.instance=!1}},updatePosition:function(){if(this._isControl())if(this.instance){if("list"===this.instance.getType()){var a=this.instance.getBlock();this.app.content.fixListMargin(a)}a=this.instance.isEditable();var b=this.instance.getOffset(),
c=this.$control.width();a=b.top-(a?-3:4);b=b.left-c-4;if(this.$control.show(),this.app.scroll.isTarget()){var d=this.app.scroll.getTarget();c=d.offset().top+d.height();d=d.offset().top;(c<a+this.$control.height()||a<d)&&this.$control.hide()}this.$control.css({top:a+"px",left:b+"px"})}else this.close()},_isControl:function(){return this.opts.control||this.opts.reorder},_click:function(a){a.preventDefault();a.stopPropagation();a={};var b={},c;for(c in a=this.app.editor.getButtonsFromArr(this.instance.control),
a=p.extend(!0,{},a,this.customItems))this.instance.isAllowedButton(c,a[c])&&(b[c]=a[c],b[c].icon=!a[c].icon||a[c].icon,b[c].control=!0);this.app.popup.create("control",{items:b});this.app.context.close();this.app.popup.open({control:this.$button})},_press:function(a){a.preventDefault();a.stopPropagation();setTimeout(function(){this.app.$win.on("mouseup."+this.prefix+"-control-button touchend."+this.prefix+"-control-button",this._release.bind(this));this.app.$win.on("mousemove."+this.prefix+"-control-button touchmove."+
this.prefix+"-control-button",this._move.bind(this))}.bind(this),0)},_release:function(a){this.$button.removeClass(this.prefix+"-handle");this.app.$win.off("."+this.prefix+"-control-button");this.app.observer.trigger=!0;this.app.event.trigger=!1;this.oldY=0;this.dragging=!1;this._trashDragItem();this.updatePosition();this.$control.show();setTimeout(function(){this.app.block.set(this.instance,"start",!0);this.app.event.trigger=!0}.bind(this),2)},_move:function(a){if(a.preventDefault(),!this.$button.hasClass(this.prefix+
"-handle")){var b=this.instance.getBlock().get();this.$button.addClass(this.prefix+"-handle");this.dragging=!0;this.$dragItem=this._makeDragItem(b,a.target);this.$control.hide()}b=!1;var c=0===this.oldY?0:this.oldY-a.pageY;0<c?b="up":0>c&&(b="down");this._moveItem(this.$dragItem,c);a=this.oldY=a.pageY;c=this.app.editor.getRect();var d=this.app.$doc.scrollTop(),e=d>c.top?d+40:c.top+40,f=this.app.$win.height()+d-40,g=c.top,l=c.top+this.app.editor.getEditor().height();this.app.scroll.isTarget()&&(f=
this.app.scroll.getTarget(),l=f.offset(),g=l.top,e=d>c.top?l.top+40:e,f=(l=l.top+f.height())-40);"up"===b&&a<e&&g<a?this._scroll(-10):"down"===b&&f<a&&a<l&&this._scroll(10);b=this.app.editor.getEditor().children();a=b.length;for(c=0;c<a;c++)d=b.eq(c).get(),d!==this.$clickItem.get()&&this._isOver(this.dom(d))&&this._swapItems(d)},_build:function(){this.$control=this.dom("<div>").addClass(this.prefix+"-control "+this.prefix+"-control-"+this.uuid).hide();this.$button=this.dom("<span>").addClass(this.prefix+
"-icon-sort "+this.prefix+"-button "+this.prefix+"-button-control");this.$control.append(this.$button);this.opts.bsmodal&&this.$control.css("z-index",1060);this.app.$body.append(this.$control)},_isOver:function(a){var b=this.$dragItem.offset().top,c=a.offset();a=a.height();return b>c.top&&b<c.top+a},_scroll:function(a){var b=this.app.scroll.isTarget()?this.app.scroll.getTarget():this.app.$win,c=b.scrollTop();b.scrollTop(c+a)},_swapItems:function(a){var b=this.$dragItem.offset().top,c=this.$clickItem;
a=this.dom(a);var d=a.offset(),e=a.height()/2;a[e+d.top>b?"before":"after"](c)},_moveItem:function(a,b){var c=a.offset().top;c-=b;a.css("top",c+"px");this.$control.css("top",c+"px")},_makeDragItem:function(a){this._trashDragItem();a=this.dom(a);var b=a.offset();this.$clickItem=a;this.$clickItem.addClass(this.prefix+"-drag-active");var c=a.clone();c.removeClass(this.prefix+"-drag-active "+this.prefix+"-element-active");c.css({"font-family":a.css("font-family"),"font-size":a.css("font-size"),"line-height":a.css("line-height"),
margin:0,padding:0});var d=this.dom("<div>").addClass(this.prefix+"-dragging");return d.append(c),d.css({opacity:.95,position:"absolute","z-index":999,left:b.left+"px",top:b.top+"px",width:a.width()+"px"}),this.app.$body.append(d),d},_trashDragItem:function(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass(this.prefix+"-drag-active"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)}});h.add("class","tool.checkbox",{mixins:["tool"],type:"checkbox",input:{tag:"input",
type:"checkbox",classname:"-form-checkbox"},getValue:function(){return this.$input.val()},_buildInput:function(){if(this.$box=this.dom("<label>").addClass(this.prefix+"-form-checkbox-item"),this.$box.append(this.$input),this._has("text")){var a=this.dom("<span>").html(this.lang.parse(this.obj.text));this.$box.append(a)}this.$tool.append(this.$box)}});h.add("class","tool.input",{mixins:["tool"],type:"input",input:{tag:"input",type:"text",classname:"-form-input"},_buildInput:function(){this.$tool.append(this.$input)}});
h.add("class","tool.number",{mixins:["tool"],type:"number",input:{tag:"input",type:"number",classname:"-form-input"},_buildInput:function(){this.$input.attr("min",0).css("max-width","65px");this.$tool.append(this.$input)}});h.add("class","tool.segment",{mixins:["tool"],type:"segment",input:{tag:"input",type:"hidden",classname:"-form-input"},setValue:function(a){this.$segment.find("."+this.prefix+"-form-segment-item").removeClass("active");this.$segment.find("[data-segment="+a+"]").addClass("active");
this.$input.val(a)},_buildInput:function(){this.$segment=this.dom("<div>").addClass(this.prefix+"-form-segment");var a=this.obj.segments,b;for(b in a)if(a.hasOwnProperty(b)){var c=this.dom("<span>").addClass(this.prefix+"-form-segment-item");c.attr("data-segment",b).on("click",this._catchSegment.bind(this));Object.prototype.hasOwnProperty.call(a[b],"icon")?c.html(a[b].icon):c.addClass(this.prefix+"-icon-"+a[b].prefix+"-"+b);this.$segment.append(c)}this.$segment.append(this.$input);this.$tool.append(this.$segment)},
_catchSegment:function(a){a.preventDefault();a.stopPropagation();a=this.dom(a.target).closest("."+this.prefix+"-form-segment-item");var b=a.attr("data-segment");this.$segment.find("."+this.prefix+"-form-segment-item").removeClass("active");a.addClass("active");this.$input.val(b);this.app.api(this.setter,this.popup)}});h.add("class","tool.select",{mixins:["tool"],type:"select",input:{tag:"select",classname:"-form-select"},_buildInput:function(){for(var a in this.obj.options)if(this.obj.options.hasOwnProperty(a)){var b=
this.dom("<option>");b.val(a);b.html(this.lang.parse(this.obj.options[a]));this.$input.append(b)}this.$tool.append(this.$input)}});h.add("class","tool.textarea",{mixins:["tool"],type:"textarea",input:{tag:"textarea",classname:"-form-textarea"},setFocus:function(){this.$input.focus();this.$input.get().setSelectionRange(0,0);this.$input.scrollTop(0)},_buildInput:function(){this._has("rows")&&this.$input.attr("rows",this._get("rows"));this.$input.attr("data-gramm_editor",!1);this.$tool.append(this.$input)}});
h.add("class","tool.upload",{mixins:["tool"],type:"upload",input:{tag:"input",type:"hidden",classname:"-form-input"},setValue:function(a){a=a||"";this.upload&&this.upload.setImage(a);this.$input.val(a)},_buildInput:function(){this.$tool.append(this.$input);this._buildUpload()},_buildUpload:function(){this.$upload=this.dom("<input>").attr("type","file");this.$tool.append(this.$upload);var a={};this._has("trigger")&&this._get("trigger")&&(a={instance:this,method:"trigger"});this.upload=this.app.create("upload",
this.$upload,this.obj.upload,a)}});h.add("block","block.address",{mixins:["block"],type:"address",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",
params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<address>")},handleEnter:function(a){if(a.preventDefault(),this.isEmpty()||this.isCaretEnd()){var b=this.getBlock(),c=b.children(),d=c.length;
a=c.eq(d-1);c=c.eq(d-2);b=b.html().trim();if(-1!==this.app.utils.removeInvisibleChars(b).search(/<br\s?\/?>$/))return c.remove(),a.remove(),void this.insertEmpty({position:"after",caret:"start"})}return this.app.insertion.insertBreakline(),!0}});h.add("block","block.cell",{mixins:["block"],type:"cell",editable:!0,create:function(){return this.dom("<td>")},getTable:function(){return this.getParent("table")},getRow:function(){return this.getParent("row")},getNextCell:function(){var a=this.getNext();
if(!a){var b=this.getParent("row");b&&(b=b.getNextRow())&&(a=b.getChildFirst("cell"))}return a},getPrevCell:function(){var a=this.getPrev();if(!a){var b=this.getParent("row");b&&(b=b.getPrevRow())&&(a=b.getChildLast("cell"))}return a},getWidth:function(){return this.$block.attr("width")||""},getNowrap:function(){return this.$block.hasClass(this.prefix+"-nowrap")},setWidth:function(a){this._eachCell(function(b){""===a?b.removeAttr("width"):(a=-1!==a.search("%")?a:a.replace("px",""),b.attr("width",
a))})},setNowrap:function(a){this._eachCell(function(b){var c=this.opts.table.nowrap+" "+this.prefix+"-nowrap";a?b.addClass(c):b.removeClass(c)}.bind(this))},handleArrow:function(a,b,c){var d,e;b=this.getTable();var f=b.getBlock(),g=this.app.caret.is(f,"start");f=this.app.caret.is(f,"end");return c.is("up-left")&&g?(a.preventDefault(),(d=b.getPrev())?this.app.block.set(d,"end"):this.app.insertion.insertEmptyBlock({current:b,position:"before",caret:"start"}),!0):c.is("down-right")&&f?(a.preventDefault(),
(e=b.getNext())?this.app.block.set(e,"start"):this.app.insertion.insertEmptyBlock({current:b,position:"after",caret:"start"}),!0):c.is("up-left")&&this.isCaretStart()?(a.preventDefault(),(d=this.getPrevCell())?this.app.block.set(d,"end"):(d=this.getFirstLevel().getPrev())&&this.app.block.set(d,"end"),!0):c.is("down-right")&&this.isCaretEnd()?(a.preventDefault(),(e=this.getNextCell())?this.app.block.set(e,"start"):(e=this.getFirstLevel().getNext())&&this.app.block.set(e,"start"),!0):void 0},handleTab:function(a){a.preventDefault();
a=this.getNextCell();return a?this.app.block.set(a,"start"):(a=this.getFirstLevel().getNext())&&this.app.block.set(a,"start"),!0},handleEnter:function(a){return a.preventDefault(),this.app.insertion.insertBreakline(),!0},_eachCell:function(a){var b=0,c=this.$block.closest("table");this.$block.closest("tr").find("td, th").each(function(d,e){d.get()===this.$block.get()&&(b=e)}.bind(this));c.find("tr").each(function(d){d=d.find("td, th").get(b);d=this.dom(d);a(d)}.bind(this))}});h.add("block","block.pre",
{mixins:["block"],type:"pre",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom(this.opts.pre.template)},build:function(){this._buildCaption();this._buildItems("figcaption","figcaption")},
handleTab:function(a){a.preventDefault();a=document.createTextNode(Array(this.opts.pre.spaces+1).join(" "));return this.app.insertion.insertNode(a,"end"),!0},handleEnter:function(a){a.preventDefault();a=this.$block.html().search(/\n$/);return this.isCaretEnd()&&-1===a?this.app.insertion.insertNewline("after",!0):this.app.insertion.insertNewline(),!0}});h.add("block","block.embed",{mixins:["block"],type:"embed",editable:!1,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",
command:"source.toggle"},embed:{title:"## blocks.embed ##",command:"embed.popup",observer:"embed.observe"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<figure>")},build:function(){this._buildCaption();this._buildItems("figcaption","figcaption");this._buildEmbedCode()},addResponsive:function(){var a=this.dom("<div>").addClass(this.opts.embed.responsive),
b=this.$block.find("figcaption"),c=b.clone(),d=this.getEmbedCode();b.remove();a.html(d);this.$block.html("").append(a);0!==c.length&&(this.app.create("block.figcaption",c),this.$block.append(c));this._buildEmbedCode()},removeResponsive:function(){this.$block.find(this._getEmbedClass()).unwrap()},getEmbedCode:function(){return decodeURI(this.$block.attr("data-embed-code"))},isResponsive:function(){return 0!==this.$block.find(this._getEmbedClass()).length},_buildEmbedCode:function(){var a=this.$block.clone();
a.find(this._getEmbedClass()).unwrap();a.find("figcaption").remove();a=a.html().trim();this.$block.attr("data-embed-code",encodeURI(a))},_getEmbedClass:function(){return"."+this.opts.embed.responsive.replace(/ +/g,".")}});h.add("block","block.figcaption",{mixins:["block"],type:"figcaption",editable:!0,toolbar:{bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",
params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},create:function(){return this.dom("<figcaption>")},getFigure:function(){return this.$block.closest("figure").dataget("instance")},handleArrow:function(a,b,c){if(c.is("up-left")&&this.isCaretStart()||c.is("down-right")&&this.isCaretEnd())return a.preventDefault(),a=this.getFigure(),this.app.block.set(a),!0},handleTab:function(a){a.preventDefault();a=this.getFigure();return this.app.block.set(a),!0},handleEnter:function(a){return a.preventDefault(),
this.isEmpty()||this.isCaretEnd()||this.isCaretStart()||this.app.insertion.insertBreakline(),!0}});h.add("block","block.heading",{mixins:["block"],type:"heading",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},
deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<h2>")},getTitle:function(){var a=this.lang.get("headings"),b=this.getTag(),
c=this.$block.attr("data-title");return void 0!==a[b]?a[b]:c},handleEnter:function(a){(a.preventDefault(),this.isEmpty()||this.isCaretEnd())?this.insertEmpty({position:"after",caret:"start",remove:!1}):this.isCaretStart()?this.insert({instance:this.duplicateEmpty(),position:"before"}):(a=this.getBlock(),a=this.app.element.split(a),this.app.block.set(a,"start"));return!0}});h.add("block","block.image",{mixins:["block"],type:"image",editable:!1,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},
html:{title:"## buttons.html ##",command:"source.toggle"},image:{title:"## blocks.image ##",command:"image.popup",observer:"image.observe"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<"+this.opts.image.tag+">")},build:function(){this._buildCaption();this._buildItems("figcaption","figcaption");this.data={alt:{getter:"getAlt",
setter:"setAlt"},width:{getter:"getWidth",setter:"setWidth"},link:{getter:"getLinkUrl",setter:"setLinkUrl"},target:{getter:"getTarget",setter:"setTarget"},caption:{getter:"getCaption",setter:"setCaption"}}},getImage:function(){return this.$block.find("img").eq(0)},getSrc:function(){return this.getImage().attr("src")},getId:function(){return this.getImage().attr("data-image")},getLink:function(){var a=this.getImage().parent();return"A"===a.get().tagName&&a},getWidth:function(){var a=this.getImage(),
b=a.css("width");a=a.attr("width");return a&&-1!==a.search(/%/)&&(b=a),b},getAlt:function(){return this.getImage().attr("alt")||""},getLinkUrl:function(){var a=this.getLink();return a?a.attr("href"):""},getTarget:function(){var a=this.getLink();return a?a.attr("target"):this.opts.image.newtab},setWidth:function(a){var b=this.getImage();if(""===(a=a.trim()))b.removeAttr("width");else{var c=-1!==a.search(/%/),d=c?a:parseInt(a),e=b.width()/b.height();c?(b.removeAttr("height"),b.attr({width:d})):b.attr({width:d,
height:Math.round(d/e)})}b.css({width:a,"max-width":a});this.app.broadcast("image.width",{image:b,width:a})},setAlt:function(a){this.getImage().attr("alt",a)},setTarget:function(a){var b=this.getLink();b&&(a?b.attr("target","_blank"):b.removeAttr("target"))},setLinkUrl:function(a){var b=this.getLink();if(b){if(""===a)return this.removeLink(),void this.app.broadcast("image.unlink",{instance:this});b.attr("href",a)}else if(!b){if(""===a)return;var c=this.getImage();b=this.dom("<a>");c.wrap(b);b.attr("href",
a)}this.app.broadcast("image.link",{instance:this,link:b})},setImage:function(a){var b=this.getImage();b.attr("src",a.url);Object.prototype.hasOwnProperty.call(a,"id")&&b.attr("data-image",a.id);Object.prototype.hasOwnProperty.call(a,"2x")&&b.attr("srcset",a["2x"]+" 2x")},removeLink:function(){var a=this.getLink();a&&a.unwrap()}});h.add("block","block.line",{mixins:["block"],type:"line",editable:!1,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"}},
control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<hr>")}});h.add("block","block.list",{mixins:["block"],type:"list",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",
command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},indent:{title:"## buttons.indent ##",command:"list.indent"},outdent:{title:"## buttons.outdent ##",command:"list.outdent"},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",
command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(a){return a&&a.tag?this.dom("<"+a.tag+">"):this.dom("<ul>")},setCaret:function(a){var b=this.$block;"start"===a?b=this.$block.find("li").first():"end"===a&&(b=this.$block.find("li").last());this.app.caret.set(b,a)},setEmpty:function(){this.$block.html("");var a=this.dom("<li>");this.$block.append(a);this.app.caret.set(a,"start")},
isEmpty:function(){var a=this.$block.html();a=this._cleanEmpty(a);var b=this.$block.find("li");return 0===b.length?""===a.trim():1===b.length&&(a=b.eq(0).html(),""===this._cleanEmpty(a))},handleTab:function(a){var b=this.app.selection.getBlock(),c=this.app.caret.is(b,"start");if(this.app.element.isEmpty(b)&&(a.preventDefault(),this.app.list.indent()))return!0;if(!this.isCaretStart()&&!this.isCaretEnd())return this.opts.tab.spaces&&!c?void 0:(a.preventDefault(),this.app.list.indent(),!0);if(b=this.getNext())return a.preventDefault(),
this.app.block.set(b,"start"),!0},handleEnter:function(a){var b;if(a.preventDefault(),this.isEmpty()||this.isCaretEnd()){if(b=this.app.selection.getBlock(),a=this.dom(b),this.app.content.isEmptyHtml(b.innerHTML))return a.remove(),this.insertEmpty({position:"after",caret:"start"}),!0;var c=this.dom("<li>");this.app.element.cloneAttrs(b,c);this.dom(b).after(c);this.app.caret.set(c,"start")}else if(this.isCaretStart())c=this.dom("<li>"),b=this.app.selection.getBlock(),this.app.element.cloneAttrs(b,c),
this.dom(b).before(c);else{b=this.app.selection.getBlock();a=this.dom(b);var d=this.app.content.isEmptyHtml(b.innerHTML);var e=this.app.caret.is(b,"start"),f=this.app.caret.is(b,"end",["ul","ol"]);(c=this.dom("<li>"),this.app.element.cloneAttrs(b,c),d)?(a.after(c),this.app.caret.set(c,"start")):e?a.before(c):f?(b=a.find("ul, ol").first(),0!==b.length&&(c.append(this.app.utils.createInvisibleChar()),c.append(b)),a.after(c),this.app.caret.set(c,"start")):(c=this.app.element.split(b),this.app.caret.set(c,
"start"))}return!0}});h.add("block","block.paragraph",{mixins:["block"],type:"paragraph",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},format:{title:"## buttons.format ##",command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},
link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<p>")},handleEnter:function(a){if(a.preventDefault(),this.isEmpty()||this.isCaretEnd()){if(a=this.app.block.create(),this.opts.clean.enter||(a=this.duplicateEmpty()).getBlock().removeAttr("id"),
!this.opts.clean.enterinline){var b=this.app.selection.getInline();if(b){var c;a=this.app.element.getAllInlines(b);for(b=0;b<a.length;b++)if(0===b)(c=a[b].cloneNode()).removeAttribute("id"),c.innerHTML="";else{var d=a[b].cloneNode();d.removeAttribute("id");d.innerHTML="";c.appendChild(d)}a=this.app.block.create(c.outerHTML)}}this.insert({instance:a,position:"after",caret:"start",remove:!1})}else this.isCaretStart()?((a=this.duplicate()).getBlock().html(""),this.insert({instance:a,position:"before"})):
(c=this.getBlock(),c=this.app.element.split(c),this.app.block.set(c,"start"));return!0}});h.add("block","block.quote",{mixins:["block"],type:"quote",toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",
command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom(this.opts.quote.template)},build:function(){this._buildCaption();this._buildItems("p","quoteitem");this._buildItems("figcaption","figcaption")},getLast:function(){return this._getLast()},getFirst:function(){return this._getFirst()},getFirstElement:function(){return this._getFirst().getBlock()},
_getFirst:function(){return this.$block.find("p").first().dataget("instance")},_getLast:function(){return this.$block.find("p").last().dataget("instance")}});h.add("block","block.quoteitem",{mixins:["block"],type:"quoteitem",editable:!0,create:function(){return this.dom("<p>")},getBlockquote:function(){return this.$block.closest("blockquote").dataget("instance")},handleArrow:function(a,b,c){b=this.getBlockquote();var d=b.getBlock();if(0!==d.length){var e=this.app.caret.is(d,"start");d=this.app.caret.is(d,
"end");if(c.is("up-left")&&e)return a.preventDefault(),a=this.getFirstLevel().getPrev(),a?this.app.block.set(a,"end"):this.app.insertion.insertEmptyBlock({current:b,position:"before",caret:"start"}),!0;if(c.is("down-right")&&d)return a.preventDefault(),a=this.getFirstLevel().getNext(),a?this.app.block.set(a,"start"):this.app.insertion.insertEmptyBlock({current:b,position:"after",caret:"start"}),!0}},handleTab:function(a){a.preventDefault();a=this.getNext();return a?this.app.block.set(a,"start"):(a=
this.getFirstLevel().getNext())&&this.app.block.set(a,"start"),!0},handleEnter:function(a){a.preventDefault();a=this.app.create("block.quoteitem");this.isEmpty()||this.isCaretEnd()?this.insert({instance:a,position:"after",caret:"start"}):this.isCaretStart()?this.insert({instance:a,position:"before"}):(a=this.getBlock(),a=this.app.element.split(a),this.app.block.set(a,"start"));return!0}});h.add("block","block.row",{mixins:["block"],type:"row",create:function(){return this.dom("<tr>")},getNextRow:function(){var a=
this.getNext(),b=this.$block.parent();return a||"TABLE"===b.get().tagName||(a=b.nextElement().find("tr").first().dataget("instance")),a},getPrevRow:function(){var a=this.getPrev(),b=this.$block.parent();return a||"TABLE"===b.get().tagName||(a=b.prevElement().find("tr").last().dataget("instance")),a}});h.add("block","block.table",{mixins:["block"],type:"table",toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},table:{title:"## blocks.table ##",
command:"table.add",observer:"table.observe",params:{name:"table"}},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"},tune:{title:"## buttons.column-settings ##",command:"table.cellSetting"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},table:{title:"## blocks.table ##",
command:"table.add",observer:"table.observe",params:{name:"table"}},tune:{title:"## buttons.column-settings ##",command:"table.cellSetting",icon:"tune"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom(this.opts.table.template)},build:function(){this._buildItems("tr","row");this._buildItems("td, th","cell");this._buildNowrap()},getLast:function(){return this.getLastCell()},getFirst:function(){return this.getFirstCell()},
getFirstElement:function(){return this.getFirstCell().getBlock()},getFirstCell:function(){var a=this.$block.find("th, td").first();if(0!==a.length)return a.dataget("instance")},getLastCell:function(){var a=this.$block.find("th, td").last();if(0!==a.length)return a.dataget("instance")},_buildNowrap:function(){this.$block.find("th, td").each(function(a){a.hasClass(this.opts.table.nowrap)&&a.addClass(this.prefix+"-nowrap")}.bind(this))}});h.add("block","block.layer",{mixins:["block"],type:"layer",editable:!1,
toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},duplicate:{title:"## buttons.duplicate ##",command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}}});h.add("block","block.dlist",{mixins:["block"],type:"dlist",editable:!0,toolbar:{add:{title:"## buttons.add ##",command:"addbar.popup"},html:{title:"## buttons.html ##",command:"source.toggle"},
format:{title:"## buttons.format ##",command:"format.popup"},bold:{title:"## buttons.bold ##",command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",command:"inline.set",params:{tag:"del"}},link:{title:"## buttons.link ##",command:"link.popup"}},control:{add:{title:"## buttons.add ##",command:"addbar.popup"},format:{title:"## buttons.format ##",command:"format.popup"},duplicate:{title:"## buttons.duplicate ##",
command:"block.duplicate"},trash:{title:"## buttons.delete ##",command:"block.remove"}},create:function(){return this.dom("<dl>")},getPlainText:function(a){var b="",c=this.$block.find("dt, dd"),d=c.length;return c.each(function(e,f){var g=a?"<br>":"";f===d&&(g="");b+=e.html()+g}),b},setEmpty:function(){this.$block.html("");var a=this.dom("<dt>");this.$block.append(a);this.app.caret.set(a,"start")},isEmpty:function(){var a=this.$block.html();a=this._cleanEmpty(a);var b=this.$block.find("dt, dd");return 0===
b.length?""===a.trim():1===b.length&&(a=b.eq(0).html(),""===this._cleanEmpty(a))},handleEnter:function(a,b,c){if(a.preventDefault(),this.isEmpty()||this.isCaretEnd()){a=this.app.selection.getBlock();b=this.dom(a);c=a.tagName.toLowerCase();var d=this.app.content.isEmptyHtml(a.innerHTML);if("dt"===c&&d)return b.remove(),this.insertEmpty({position:"after",caret:"start"}),!0;b="dt"===c?this.dom("<dd>"):this.dom("<dt>");this.dom(a).after(b);this.app.caret.set(b,"start")}else{if(this.isCaretStart())return!0;
this.app.insertion.insertBreakline()}return!0}});window.RedactorX=h;window.addEventListener("load",function(){A("[data-redactorx]",void 0)});"object"==typeof module&&module.exports&&(module.exports=h,module.exports.RedactorX=h)}();RedactorX.add("plugin","alignment",{translations:{en:{alignment:{alignment:"Alignment"}}},defaults:{align:{left:"align-left",center:"align-center",right:"align-right",justify:"align-justify"}},start:function(){this.app.toolbar.add("alignment",{title:"## alignment.alignment ##",command:"alignment.popup",position:{after:"format"},blocks:{all:"editable"}})},popup:function(k,h){k={};var n=this.opts.alignment.align,q;for(q in n)n[q]&&(k[q]={name:n[q],prefix:"align"});this.app.popup.create("alignment",
{setter:"alignment.setAlign",getter:"alignment.getAlign",form:{align:{type:"segment",label:"## alignment.alignment ##",segments:k}}});this.app.popup.open({button:h})},getAlign:function(){var k=this.opts.alignment.align;if(!k)return!1;var h=this.app.block.get().getBlock(),n="left",q;for(q in k)h.hasClass(k[q])&&(n=q);return{align:n}},setAlign:function(k){this.app.popup.close();k=k.getData();this.app.block.get().setClassFromObj(this.opts.alignment.align,k.align)}});RedactorX.add("plugin","blockcode",{translations:{en:{blockcode:{save:"Save",cancel:"Cancel","edit-code":"Edit Code"}}},defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m10.6128994 3.20970461.0942074.08318861 4 4c.3604839.36048396.3882135.92771502.0831886 1.32000622l-.0831886.09420734-4 4.00000002c-.3905243.3905243-1.02368929.3905243-1.41421358 0-.36048396-.360484-.3882135-.927715-.08318861-1.3200062l.08318861-.0942074 3.29210678-3.2928932-3.29210678-3.29289322c-.36048396-.36048396-.3882135-.92771502-.08318861-1.32000622l.08318861-.09420734c.36048396-.36048396.92771498-.3882135 1.32000618-.08318861zm-3.90579262.08318861c.36048396.36048396.3882135.92771502.08318861 1.32000622l-.08318861.09420734-3.29210678 3.29289322 3.29210678 3.2928932c.36048396.360484.3882135.927715.08318861 1.3200062l-.08318861.0942074c-.36048396.3604839-.92771502.3882135-1.32000622.0831886l-.09420734-.0831886-4-4.00000002c-.36048396-.36048396-.3882135-.92771502-.08318861-1.32000622l.08318861-.09420734 4-4c.39052429-.39052429 1.02368927-.39052429 1.41421356 0z"/></svg>',
popup:{width:"100%",title:"## blockcode.edit-code ##",form:{code:{type:"textarea",rows:"8"}},footer:{save:{title:"## blockcode.save ##",command:"blockcode.save",type:"primary"},cancel:{title:"## blockcode.cancel ##",close:!0}}}},init:function(){this.offset=!1},start:function(){this.app.control.add("blockcode",{icon:this.opts.blockcode.icon,command:"blockcode.edit",title:"## blockcode.edit-code ##",position:{before:"duplicate"}})},edit:function(){var k=this._getCurrent(),h=k.getOuterHtml();h=this.app.parser.unparse(h);
k.isEditable()&&(this.offset=this.app.offset.get(k.getBlock()));this.app.popup.create("code",this.opts.blockcode.popup);this.app.popup.setData({code:h});this.app.popup.open({focus:"code"});this._buildInputHandle();this._buildCodemirror()},save:function(){this.app.popup.close();var k=this._getCurrent(),h=this._getCode();""!==h&&(h=this.app.parser.parse(h,!1),h=this.dom(h),h=this.app.create("block."+k.getType(),h),k.change(h),this.offset&&h.isEditable()&&this.app.offset.set(h.getBlock(),this.offset),
this.offset=!1)},_getCurrent:function(){var k=this.app.block.get();return k.isSecondLevel()&&(k=k.getFirstLevel()),k},_getCode:function(){var k=this.app.popup.getData().code.trim();return this.app.codemirror.val(k)},_buildInputHandle:function(){this.app.popup.getInput("code").on("keydown",this.app.input.handleTextareaTab.bind(this))},_buildCodemirror:function(){var k=this.app.popup.getInput("code");this.app.codemirror.create({el:k,height:"200px",focus:!0});this.app.popup.updatePosition()}});RedactorX.add("plugin","removeformat",{translations:{en:{removeformat:{removeformat:"Remove Format"}}},defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m8 11c.51283584 0 .93550716.3860402.99327227.8833789l.00672773.1166211v1c0 .5522847-.44771525 1-1 1-.51283584 0-.93550716-.3860402-.99327227-.8833789l-.00672773-.1166211v-1c0-.5522847.44771525-1 1-1zm-4.60436072-5.91850958.10436072.05248418 9.5262794 5.5c.4782927.2761424.6421678.8877328.3660254 1.3660254-.2564179.4441289-.8020741.6171529-1.2616646.4185096l-.1043608-.0524842-9.5262794-5.5c-.47829262-.27614237-.64216778-.88773278-.3660254-1.3660254.25641792-.44412886.80207419-.61715287 1.26166468-.41850958zm9.60436072-3.08149042c.5522847 0 1 .44771525 1 1 0 .51283584-.3860402.93550716-.8833789.99327227l-.1166211.00672773h-4.00016698l.00016698 2c0 .55228475-.44771525 1-1 1-.51283584 0-.93550716-.38604019-.99327227-.88337887l-.00672773-.11662113-.00016698-2h-3.99983302c-.55228475 0-1-.44771525-1-1 0-.51283584.38604019-.93550716.88337887-.99327227l.11662113-.00672773z"/></svg>'},
start:function(){var k={title:"## removeformat.removeformat ##",icon:this.opts.removeformat.icon,command:"inline.removeFormat",position:{after:["deleted","italic"]},blocks:{all:"editable"}};this.app.toolbar.add("removeformat",k);this.app.context.add("removeformat",k)}});RedactorX.add("plugin","inlineformat",{translations:{en:{inlineformat:{"inline-format":"Inline Format",underline:"Underline",superscript:"Superscript",subscript:"Subscript",mark:"Mark",code:"Code",shortcut:"Shortcut","remove-format":"Remove Format"}}},defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7.39849577 1.20113038c-3.5610278 2.68125517-5.39849577 5.14152807-5.39849577 7.49360646 0 3.50902886 2.59345039 6.30526316 6 6.30526316 3.4065496 0 6-2.7962343 6-6.30526316 0-2.35207839-1.837468-4.81235129-5.39849577-7.49360646-.35616697-.26817384-.84684149-.26817384-1.20300846 0zm.60150423 2.06186962.28200813.22720401c2.50634097 2.04313256 3.71799187 3.80538426 3.71799187 5.20453283 0 2.43669386-1.73306 4.30526316-4 4.30526316-2.26694005 0-4-1.8685693-4-4.30526316 0-1.39914857 1.21165095-3.16140027 3.71799187-5.20453283z"/></svg>',
items:"u sup sub mark code kbd".split(" "),itemsObj:{u:{title:'<span style="text-decoration: underline;">## inlineformat.underline ##</span>',params:{tag:"u"},shortcut:"Ctrl+u"},sup:{title:"## inlineformat.superscript ##<sup>x</sup>",params:{tag:"sup"},shortcut:"Ctrl+h"},sub:{title:"## inlineformat.subscript ##<sub>x</sub>",params:{tag:"sub"},shortcut:"Ctrl+l"},mark:{title:'<span style="background: yellow;">## inlineformat.mark ##</span>',params:{tag:"mark"}},code:{title:'<span style="font-family: monospace; background: #f0f1f2; padding: 4px;">## inlineformat.code ##</span>',
params:{tag:"code"}},kbd:{title:"## inlineformat.shortcut ##",params:{tag:"kbd"}}}},start:function(){this.app.toolbar.add("inlineformat",{title:"## inlineformat.inline-format ##",icon:this.opts.inlineformat.icon,command:"inlineformat.popup",position:{after:"deleted"},blocks:{all:"editable"}})},popup:function(k,h){k=this.opts.inlineformat.items;for(var n=this.app.selection.getNodes({type:"inline"}),q={},t=0;t<k.length;t++){var u=k[t];q[u]=this.opts.inlineformat.itemsObj[u];q[u].command="inline.set"}0!==
n.length&&(q.remove={title:"## inlineformat.remove-format ##",divider:"top",command:"inline.removeFormat"});this.app.popup.create("inlineformat",{width:"300px",items:q});this.app.popup.open({button:h})}});RedactorX.add("plugin","imageposition",{translations:{en:{imageposition:{"image-position":"Image position"}}},defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m15 13c.5522847 0 1 .4477153 1 1s-.4477153 1-1 1h-13c-.55228475 0-1-.4477153-1-1s.44771525-1 1-1zm-5-12c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm5 8c.5522847 0 1 .44771525 1 1 0 .5522847-.4477153 1-1 1h-2c-.5522847 0-1-.4477153-1-1 0-.55228475.4477153-1 1-1zm-10-1-1 1h2zm4-5h-6v5l2-2 3 3h1zm6 2c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.44771525-1-1s.4477153-1 1-1zm-8-1c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1zm8-3c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.44771525-1-1s.4477153-1 1-1z"/></svg>',
items:{none:"none",left:"float-left",center:"align-center",right:"float-right"},icons:{none:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m12 3c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm-5 7-1 1h2zm4-5h-6v5l2-2 3 3h1zm-2 1c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1z"/></svg>',left:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m10 3c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm5 8c.5522847 0 1 .4477153 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.4477153-1-1s.4477153-1 1-1zm-10-1-1 1h2zm4-5h-6v5l2-2 3 3h1zm6 2c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.44771525-1-1s.4477153-1 1-1zm-8-1c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1zm8-3c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-2c-.5522847 0-1-.44771525-1-1s.4477153-1 1-1z"/></svg>',
center:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m12 3c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm3 8c.5522847 0 1 .4477153 1 1s-.4477153 1-1 1-1-.4477153-1-1 .4477153-1 1-1zm-14 0c.55228475 0 1 .4477153 1 1s-.44771525 1-1 1-1-.4477153-1-1 .44771525-1 1-1zm6-1-1 1h2zm4-5h-6v5l2-2 3 3h1zm4 2c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1-1-.44771525-1-1 .4477153-1 1-1zm-14 0c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1zm8-1c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1zm6-3c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1-1-.44771525-1-1 .4477153-1 1-1zm-14 0c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1-1-.44771525-1-1 .44771525-1 1-1z"/></svg>',
right:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m14 3c.5522847 0 1 .44771525 1 1v8c0 .5522847-.4477153 1-1 1h-8c-.55228475 0-1-.4477153-1-1v-8c0-.55228475.44771525-1 1-1zm-11 8c.55228475 0 1 .4477153 1 1s-.44771525 1-1 1h-2c-.55228475 0-1-.4477153-1-1s.44771525-1 1-1zm6-1-1 1h2zm4-5h-6v5l2-2 3 3h1zm-10 2c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1h-2c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1zm8-1c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1-1-.44771525-1-1 .4477153-1 1-1zm-8-3c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1h-2c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1z"/></svg>'}},
start:function(){this.app.toolbar.add("imageposition",{title:"## imageposition.image-position ##",command:"imageposition.popup",icon:this.opts.imageposition.icon,position:{after:"image"},blocks:{types:["image"]}})},popup:function(k,h){k={};var n=this.opts.imageposition.items,q;for(q in n)n[q]&&(k[q]={name:n[q],icon:this.opts.imageposition.icons[q]});this.app.popup.create("imageposition",{setter:"imageposition.setFloat",getter:"imageposition.getFloat",form:{ifloat:{type:"segment",label:"## imageposition.image-position ##",
segments:k}}});this.app.popup.open({button:h})},getFloat:function(){var k=this.opts.imageposition.items;if(!k)return!1;var h=this.app.block.get().getBlock(),n="none",q;for(q in k)h.hasClass(k[q])&&(n=q);return{ifloat:n}},setFloat:function(k){this.app.popup.close();k=k.getData();var h=this.app.block.get();h.setClassFromObj(this.opts.imageposition.items,k.ifloat);this.app.broadcast("image.position",{image:h.getImage(),position:k.ifloat})}});RedactorX.add("plugin","allowstyle",{init:function(){var k=this.app.content.removeTagsWithContent;this.app.content.removeTagsWithContent=function(h,n){n=["script"];return k.bind(this).apply(null,arguments)}}});RedactorX.lang.ru={accessibility:{"help-label":"\u0412\u0438\u0437\u0443\u0430\u043b\u044c\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442\u043e\u0432\u044b\u0439 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440"},placeholders:{figcaption:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043f\u043e\u0434\u043f\u0438\u0441\u044c (\u043d\u0435\u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e)"},popup:{back:"\u041d\u0430\u0437\u0430\u0434",link:"\u0421\u0441\u044b\u043b\u043a\u0430",add:"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c",
image:"\u0418\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435","add-image":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435"},shortcuts:{"meta-a":"\u0412\u044b\u0434\u0435\u043b\u0438\u0442\u044c \u0432\u0441\u0451","meta-z":"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c","meta-shift-z":"\u041f\u043e\u0432\u0442\u043e\u0440\u0438\u0442\u044c","meta-shift-m":"\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c \u0444\u043e\u0440\u043c\u0430\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435",
"meta-b":"\u0416\u0438\u0440\u043d\u044b\u0439","meta-i":"\u041a\u0443\u0440\u0441\u0438\u0432","meta-u":"\u041f\u043e\u0434\u0447\u0451\u0440\u043a\u0438\u0432\u0430\u043d\u0438\u0435","meta-h":"\u0412\u0435\u0440\u0445\u043d\u0438\u0439 \u0438\u043d\u0434\u0435\u043a\u0441","meta-l":"\u041d\u0438\u0436\u043d\u0438\u0439 \u0438\u043d\u0434\u0435\u043a\u0441","meta-k":"\u0421\u0441\u044b\u043b\u043a\u0430","meta-alt-0":"\u041e\u0431\u044b\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442","meta-alt-1":"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 1",
"meta-alt-2":"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 2","meta-alt-3":"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 3","meta-alt-4":"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 4","meta-alt-5":"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 5","meta-alt-6":"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 6","meta-shift-7":"\u041d\u0443\u043c\u0435\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a","meta-shift-8":"\u041c\u0430\u0440\u043a\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a",
"meta-indent":"\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c \u043e\u0442\u0441\u0442\u0443\u043f","meta-outdent":"\u0423\u043c\u0435\u043d\u044c\u0448\u0438\u0442\u044c \u043e\u0442\u0441\u0442\u0443\u043f","meta-shift-backspace":"\u0423\u0434\u0430\u043b\u0438\u0442\u044c","meta-shift-o":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c","meta-shift-d":"\u0414\u0443\u0431\u043b\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0430\u0431\u0437\u0430\u0446","meta-shift-up":"\u041f\u0435\u0440\u0435\u0434\u0432\u0438\u043d\u0443\u0442\u044c \u0432\u0432\u0435\u0440\u0445",
"meta-shift-down":"\u041f\u0435\u0440\u0435\u0434\u0432\u0438\u043d\u0443\u0442\u044c \u0432\u043d\u0438\u0437"},buttons:{add:"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c",html:"HTML",format:"\u0424\u043e\u0440\u043c\u0430\u0442",bold:"\u0416\u0438\u0440\u043d\u044b\u0439",italic:"\u041a\u0443\u0440\u0441\u0438\u0432",deleted:"\u0417\u0430\u0447\u0451\u0440\u043a\u043d\u0443\u0442\u044b\u0439",link:"\u0421\u0441\u044b\u043b\u043a\u0430",list:"\u0421\u043f\u0438\u0441\u043e\u043a",image:"\u0418\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435",
indent:"\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c \u043e\u0442\u0441\u0442\u0443\u043f",outdent:"\u0423\u043c\u0435\u043d\u044c\u0448\u0438\u0442\u044c \u043e\u0442\u0441\u0442\u0443\u043f",embed:"\u041e\u0431\u044a\u0435\u043a\u0442",table:"\u0422\u0430\u0431\u043b\u0438\u0446\u0430",insert:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c",save:"\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c",cancel:"\u041e\u0442\u043c\u0435\u043d\u0430","delete":"\u0423\u0434\u0430\u043b\u0438\u0442\u044c",
duplicate:"\u0414\u0443\u0431\u043b\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0430\u0431\u0437\u0430\u0446",shortcut:"\u0421\u043e\u0447\u0435\u0442\u0430\u043d\u0438\u044f \u043a\u043b\u0430\u0432\u0438\u0448",underline:"\u041f\u043e\u0434\u0447\u0451\u0440\u043a\u0438\u0432\u0430\u043d\u0438\u0435",undo:"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c",redo:"\u041f\u043e\u0432\u0442\u043e\u0440\u0438\u0442\u044c",code:"\u0424\u0440\u0430\u0433\u043c\u0435\u043d\u0442 \u043a\u043e\u0434\u0430",
mark:"\u041e\u0442\u043c\u0435\u0442\u043a\u0430",subscript:"\u041d\u0438\u0436\u043d\u0438\u0439 \u0438\u043d\u0434\u0435\u043a\u0441",superscript:"\u0412\u0435\u0440\u0445\u043d\u0438\u0439 \u0438\u043d\u0434\u0435\u043a\u0441",kbd:"\u0421\u043e\u0447\u0435\u0442\u0430\u043d\u0438\u0435 \u043a\u043b\u0430\u0432\u0438\u0448","image-settings":"\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f","column-settings":"\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0441\u0442\u043e\u043b\u0431\u0446\u0430"},
blocks:{text:"\u0422\u0435\u043a\u0441\u0442",paragraph:"\u0410\u0431\u0437\u0430\u0446",image:"\u0418\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435",embed:"\u041e\u0431\u044a\u0435\u043a\u0442",line:"\u041b\u0438\u043d\u0438\u044f",table:"\u0422\u0430\u0431\u043b\u0438\u0446\u0430",quote:"\u0426\u0438\u0442\u0430\u0442\u0430",pre:"\u0424\u0440\u0430\u0433\u043c\u0435\u043d\u0442 \u043a\u043e\u0434\u0430",address:"\u0410\u0434\u0440\u0435\u0441"},format:{p:"\u041e\u0431\u044b\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442",
h1:"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 1",h2:"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 2",h3:"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 3",h4:"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 4",h5:"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 5",h6:"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a 6",address:"\u0410\u0434\u0440\u0435\u0441",ul:"\u041c\u0430\u0440\u043a\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a",
ol:"\u041d\u0443\u043c\u0435\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a",dl:"\u0421\u043f\u0438\u0441\u043e\u043a \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0439"},embed:{embed:"\u041e\u0431\u044a\u0435\u043a\u0442",caption:"\u041d\u0430\u0434\u043f\u0438\u0441\u044c",description:"\u0412\u0441\u0442\u0430\u0432\u044c\u0442\u0435 \u043b\u044e\u0431\u043e\u0439 HTML-\u043a\u043e\u0434 \u0434\u043b\u044f \u0432\u0441\u0442\u0440\u0430\u0438\u0432\u0430\u043d\u0438\u044f \u0438\u043b\u0438 URL (\u0442\u043e\u043b\u044c\u043a\u043e Vimeo \u0438\u043b\u0438 YouTube)",
"responsive-video":"\u0410\u0434\u0430\u043f\u0442\u0438\u0432\u043d\u043e\u0435 \u0432\u0438\u0434\u0435\u043e"},image:{or:"\u0438\u043b\u0438","alt-text":"\u0422\u0435\u043a\u0441\u0442 \u0434\u043b\u044f \u0430\u0442\u0440\u0438\u0431\u0443\u0442\u0430 alt",link:"\u0421\u0441\u044b\u043b\u043a\u0430",width:"\u0428\u0438\u0440\u0438\u043d\u0430",caption:"\u041d\u0430\u0434\u043f\u0438\u0441\u044c","link-in-new-tab":"\u041e\u0442\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u0441\u0441\u044b\u043b\u043a\u0443 \u0432 \u043d\u043e\u0432\u043e\u0439 \u0432\u043a\u043b\u0430\u0434\u043a\u0435",
"url-placeholder":"\u0412\u0441\u0442\u0430\u0432\u044c\u0442\u0435 URL \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f...","upload-new-placeholder":"\u041f\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0444\u0430\u0439\u043b \u0434\u043b\u044f \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f<br>\u0438\u043b\u0438 \u043d\u0430\u0436\u043c\u0438\u0442\u0435 \u0437\u0434\u0435\u0441\u044c"},link:{link:"\u0421\u0441\u044b\u043b\u043a\u0430",
"edit-link":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0441\u0441\u044b\u043b\u043a\u0443",unlink:"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0441\u0441\u044b\u043b\u043a\u0443","link-in-new-tab":"\u041e\u0442\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u0441\u0441\u044b\u043b\u043a\u0443 \u0432 \u043d\u043e\u0432\u043e\u0439 \u0432\u043a\u043b\u0430\u0434\u043a\u0435",text:"\u0422\u0435\u043a\u0441\u0442",url:"URL"},table:{width:"\u0428\u0438\u0440\u0438\u043d\u0430",
nowrap:"\u041d\u0435 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0438\u0442\u044c \u0442\u0435\u043a\u0441\u0442 \u043f\u043e \u0441\u0442\u0440\u043e\u043a\u0430\u043c",column:"\u0421\u0442\u043e\u043b\u0431\u0435\u0446","add-head":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a","remove-head":"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a","add-row-below":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0441\u0442\u0440\u043e\u043a\u0443 \u043d\u0438\u0436\u0435",
"add-row-above":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0441\u0442\u0440\u043e\u043a\u0443 \u0432\u044b\u0448\u0435","remove-row":"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0441\u0442\u0440\u043e\u043a\u0443","add-column-after":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0441\u0442\u043e\u043b\u0431\u0435\u0446 \u0441\u043f\u0440\u0430\u0432\u0430","add-column-before":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0441\u0442\u043e\u043b\u0431\u0435\u0446 \u0441\u043b\u0435\u0432\u0430",
"remove-column":"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0441\u0442\u043e\u043b\u0431\u0435\u0446","delete-table":"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0442\u0430\u0431\u043b\u0438\u0446\u0443"},alignment:{alignment:"\u0412\u044b\u0440\u0430\u0432\u043d\u0438\u0432\u0430\u043d\u0438\u0435"},blockcode:{save:"\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c",cancel:"\u041e\u0442\u043c\u0435\u043d\u0430","edit-code":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043a\u043e\u0434"},
clips:{clips:"Clips"},counter:{words:"words",chars:"chars"},filelink:{file:"File",upload:"Upload",title:"Title",choose:"Choose",placeholder:"Drag to upload a file<br>or click to select"},icons:{icons:"Icons"},imageposition:{"image-position":"\u0412\u044b\u0440\u0430\u0432\u043d\u0438\u0432\u0430\u043d\u0438\u0435 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f"},imageresize:{"image-resize":"Image resize"},inlineformat:{"inline-format":"\u0421\u0442\u0438\u043b\u044c \u0442\u0435\u043a\u0441\u0442\u0430",
underline:"\u041f\u043e\u0434\u0447\u0451\u0440\u043a\u0438\u0432\u0430\u043d\u0438\u0435",superscript:"\u0412\u0435\u0440\u0445\u043d\u0438\u0439 \u0438\u043d\u0434\u0435\u043a\u0441",subscript:"\u041d\u0438\u0436\u043d\u0438\u0439 \u0438\u043d\u0434\u0435\u043a\u0441",mark:"\u0412\u044b\u0434\u0435\u043b\u0435\u043d\u0438\u0435",code:"\u0424\u0440\u0430\u0433\u043c\u0435\u043d\u0442 \u043a\u043e\u0434\u0430",shortcut:"\u0421\u043e\u0447\u0435\u0442\u0430\u043d\u0438\u0435 \u043a\u043b\u0430\u0432\u0438\u0448",
"remove-format":"\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c \u0444\u043e\u0440\u043c\u0430\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435"},removeformat:{removeformat:"\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c \u0444\u043e\u0440\u043c\u0430\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435"},specialchars:{"special-chars":"\u0421\u043f\u0435\u0446\u0438\u0430\u043b\u044c\u043d\u044b\u0435 \u0441\u0438\u043c\u0432\u043e\u043b\u044b"}};
//# sourceMappingURL=redactorx.bundle.min.js.map